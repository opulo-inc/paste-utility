var M=Object.defineProperty;var I=(t,e,n)=>e in t?M(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var b=(t,e,n)=>(I(t,typeof e!="symbol"?e+"":e,n),n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function n(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(i){if(i.ep)return;i.ep=!0;const r=n(i);fetch(i.href,r)}})();class E{constructor(){b(this,"timeout",async e=>new Promise(n=>setTimeout(n,e)));this.modalObject=document.getElementById("modal"),this.overlay=document.getElementById("overlay"),this.modalTitle=document.getElementById("modal-title"),this.modalContent=document.getElementById("modal-content"),this.modalNumInput=document.getElementById("modal-num-input"),this.modalClose=document.getElementById("modal-close"),this.modalOK=document.getElementById("modal-ok"),this.receivedInput=void 0}hide(){this.modalObject.style.display="none",this.overlay.style.display="none"}show(e,n,s){s===void 0&&(s=0),this.modalTitle.innerHTML=e,this.modalContent.innerHTML=n,this.modalObject.style.display="flex",this.overlay.style.display="block",s==0?this.modalNumInput.style.display="none":s==1&&(this.modalNumInput.style.display="block",this.modalNumInput.value=1),this.modalOK.focus();let i=this.waitForUserSelection();return i&&s==1&&(i=this.modalNumInput.value),i}async waitForUserSelection(){for(;this.receivedInput===void 0;)await this.timeout(50);let e=this.receivedInput;return this.receivedInput=void 0,e}}class L{constructor(e){b(this,"delay",e=>new Promise(n=>setTimeout(n,e)));this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.consoleDiv=document.getElementById("console"),this.port,this.modal=e,this.receiveBuffer=[],this.inspectBuffer=[],this.sentCommandBuffer=[""],this.sentCommandBufferIndex=0,this.okRespTimeout=!1,this.timeoutID=void 0,this.bootCommands=["G90","M260 A112 B1 S1","M260 A109","M260 B48","M260 B27","M260 S1","M260 A112 B2 S1","M260 A109","M260 B48","M260 B27","M260 S1","G0 F35000"]}async appendToConsole(e,n){let s=document.createElement("p"),i=new Date().toISOString(),r="";n?r="[SEND]":r="[RECE]",s.innerHTML=r+" - "+i+" - "+e+`
`,this.consoleDiv.appendChild(s),this.consoleDiv.scrollTop=this.consoleDiv.scrollHeight}clearBuffer(){for(;this.receiveBuffer.length>0;)this.receiveBuffer.shift()}clearInspectBuffer(){for(;this.inspectBuffer.length>0;)this.inspectBuffer.shift()}dec2bin(e){return(e>>>0).toString(2)}async connect(){if(!navigator.serial)return this.modal.show("Browser Support","Please use a browser that supports WebSerial, like Chrome, Opera, or Edge. <a href='https://developer.mozilla.org/en-US/docs/Web/API/Web_Serial_API#browser_compatibility'>Supported Browsers."),!1;const e=1155;return this.port=await navigator.serial.requestPort({filters:[{usbVendorId:e}]}),console.log("Port Selected."),await this.port.open({baudRate:115200,bufferSize:255,dataBits:8,flowControl:"none",parity:"none",stopBits:1}),console.log("Port Opened."),this.listen(),document.querySelector("#connect").style.background="green",document.querySelector("#connect").style.color="white",document.querySelector("#connect").innerHTML="Connected",this.send(this.bootCommands),!0}async listen(){var e;for(;(e=this.port)!=null&&e.readable;){console.log("Port is readable: Starting to listen.");let n="";document.getElementById("console");const s=this.port.readable.getReader();try{for(;;){const{value:i,done:r}=await s.read();if(r){console.log("Closing reader.");break}const c=this.decoder.decode(i);for(n=n.concat(c);n.indexOf(`
`)!=-1;){let o=n.split(`
`);this.receiveBuffer.push(o[0]),this.appendToConsole(o[0],!1),this.inspectBuffer.push(o[0]),console.log("current inspect buffer",this.inspectBuffer),n=n.split(`
`).slice(1).join(`
`)}}}catch(i){console.error("Reading error.",i)}finally{s.releaseLock()}}}sleep(e){for(var n=new Date().getTime(),s=0;s<1e7&&!(new Date().getTime()-n>e);s++);}async setOkRespTimeout(){new Promise(e=>{this.timeoutID=setTimeout(()=>{console.log("timeout triggered"),this.okRespTimeout=!0,e()},5e3)})}async send(e){var n;if(console.log("sending: ",e),(n=this.port)!=null&&n.writable){const s=await this.port.writable.getWriter();for(const i of e){for(await s.write(this.encoder.encode(i+`
`)),this.setOkRespTimeout(),this.appendToConsole(i,!0),this.clearBuffer();!this.okRespTimeout;){let r=this.receiveBuffer.shift();if(r=="ok"){clearTimeout(this.timeoutID);break}(r="echo:busy: processing")&&(clearTimeout(this.timeoutID),this.setOkRespTimeout()),await new Promise(c=>setTimeout(c,50))}this.okRespTimeout=!1}s.releaseLock()}else this.modal.show("Cannot Write","Cannot write to port. Have you connected?")}async sendRepl(){let e=[document.querySelector("#repl-input").value];this.sentCommandBuffer.splice(1,0,e[0]),this.sentCommandBufferIndex=0,this.send(e)}async leftAirOn(){const e=["M106","M106 P1 S255"];await this.send(e)}async leftAirOff(){const e=["M107","M107 P1"];await this.send(e)}async rightAirOn(){const e=["M106 P2 S255","M106 P3 S255"];await this.send(e)}async rightAirOff(){const e=["M107 P2","M107 P3"];await this.send(e)}async ledOn(){const e=["M150 P255 R255 U255 B255"];await this.send(e)}async ledOff(){const e=["M150 P0"];await this.send(e)}async disableSteppers(){const e=["M18"];await this.send(e)}async readLeftVac(){var f;if(!((f=this.port)!=null&&f.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;const e=["M260 A112 B1 S1"],n=50;this.clearBuffer();let s,i,r;const c=new RegExp("data:(..)");await this.send(e),this.clearBuffer(),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var o=0,d=this.receiveBuffer.length;o<d;o++){let m=this.receiveBuffer[o];if(c.test(m)){s=m.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var o=0,d=this.receiveBuffer.length;o<d;o++){let h=this.receiveBuffer[o];if(c.test(h)){i=h.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var o=0,d=this.receiveBuffer.length;o<d;o++){let h=this.receiveBuffer[o];if(c.test(h)){r=h.match("data:(..)")[1];break}}let l=parseInt(s+i+r,16);l&1<<23&&(l=l-2**24),await this.modal.show("Left Vacuum Sensor Value",l),this.clearBuffer()}async readRightVac(){var f;if(!((f=this.port)!=null&&f.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;const e=["M260 A112 B2 S1"];let n,s,i;const r=new RegExp("data:(..)"),c=50;this.clearBuffer(),await this.send(e),await this.delay(c),this.clearBuffer(),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(c);for(var o=0,d=this.receiveBuffer.length;o<d;o++){let m=this.receiveBuffer[o];if(r.test(m)){n=m.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(c);for(var o=0,d=this.receiveBuffer.length;o<d;o++){let h=this.receiveBuffer[o];if(r.test(h)){s=h.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(c);for(var o=0,d=this.receiveBuffer.length;o<d;o++){let h=this.receiveBuffer[o];if(r.test(h)){i=h.match("data:(..)")[1];break}}let l=parseInt(n+s+i,16);l&1<<23&&(l=l-2**24),await this.modal.show("Right Vacuum Sensor Value",l)}async testTMC(){var i;if(!((i=this.port)!=null&&i.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;let e="";const n=["M122"];await this.clearBuffer(),await this.send(n),await this.delay(5e3),console.log(this.receiveBuffer);for(let r=0;r<this.receiveBuffer.length;r++)e=e.concat(this.receiveBuffer[r]+`
`);if(await this.modal.show("Stepper Driver Test Complete","Test is complete. Click OK to download test report.")==!0){let r=new Date().toISOString();r=r+"-tmctest.txt",this.download(r,e)}}async testVac(){var B;if(!((B=this.port)!=null&&B.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;let e="";const n=["M260 A112 B1 S1","M260 A109","M260 B48","M260 B10","M260 S1"],s=["M260 A112 B2 S1","M260 A109","M260 B48","M260 B10","M260 S1"],i=100;this.clearBuffer();let r,c,o;const d=new RegExp("data:(..)");await this.send(n),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var l=0,f=this.receiveBuffer.length;l<f;l++){let g=this.receiveBuffer[l];if(d.test(g)){r=g.match("data:(..)")[1],e=e.concat("Left MSB - "+r+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var l=0,f=this.receiveBuffer.length;l<f;l++){let u=this.receiveBuffer[l];if(d.test(u)){c=u.match("data:(..)")[1],e=e.concat("Left CSB - "+c+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var l=0,f=this.receiveBuffer.length;l<f;l++){let u=this.receiveBuffer[l];if(d.test(u)){o=u.match("data:(..)")[1],e=e.concat("Left LSB - "+o+`
`);break}}let m=parseInt(r+c+o,16);m&1<<23&&(m=m-2**24),e=e.concat("Left Val - "+m+`
`),this.clearBuffer(),await this.send(s),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var l=0,f=this.receiveBuffer.length;l<f;l++){let u=this.receiveBuffer[l];if(d.test(u)){r=u.match("data:(..)")[1],e=e.concat("Right MSB - "+r+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var l=0,f=this.receiveBuffer.length;l<f;l++){let u=this.receiveBuffer[l];if(d.test(u)){c=u.match("data:(..)")[1],e=e.concat("Right CSB - "+c+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i),console.log("current buffer length: ",this.receiveBuffer.length);for(var l=0,f=this.receiveBuffer.length;l<f;l++){let u=this.receiveBuffer[l];if(d.test(u)){o=u.match("data:(..)")[1],e=e.concat("Right LSB - "+o+`
`);break}}let p=parseInt(r+c+o,16);if(p&1<<23&&(p=p-2**24),e=e.concat("Right Val - "+p+`
`),console.log(m,p),await this.modal.show("Vacuum Sensor Test Complete","Test is complete. Click OK to download test report.")==!0){let g=new Date().toISOString();g=g+"-vactest.txt",this.download(g,e)}}download(e,n){var s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(n)),s.setAttribute("download",e),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)}}let w=new E,a=new L(w),y=[];document.getElementById("modal-close").addEventListener("click",()=>{w.receivedInput=!1,w.hide()});document.getElementById("modal-ok").addEventListener("keyup",function(t){t.code==="Enter"&&(t.preventDefault(),w.receivedInput=!0,w.hide())});document.getElementById("modal-ok").addEventListener("click",()=>{w.receivedInput=!0,w.hide()});document.getElementById("modal-ng").addEventListener("click",()=>{w.receivedInput=!1,w.hide()});function k(){document.getElementById("repl-input").value=""}document.getElementById("repl-input").addEventListener("keyup",function(t){if(t.code==="Enter")t.preventDefault(),document.getElementById("send").click();else if(t.code==="ArrowUp"){if(t.preventDefault(),a.sentCommandBufferIndex==a.sentCommandBuffer.length-1)return!1;a.sentCommandBufferIndex++,document.getElementById("repl-input").value=a.sentCommandBuffer[a.sentCommandBufferIndex]}else if(t.code==="ArrowDown"){if(t.preventDefault(),a.sentCommandBufferIndex==0)return!1;a.sentCommandBufferIndex--,document.getElementById("repl-input").value=a.sentCommandBuffer[a.sentCommandBufferIndex]}});document.getElementById("capture-button").addEventListener("click",()=>{x()});document.getElementById("export-captured").addEventListener("click",()=>{C()});document.getElementById("connect").addEventListener("click",()=>{a.connect()});document.getElementById("send").addEventListener("click",()=>{a.sendRepl(),k()});document.getElementById("home").addEventListener("click",()=>{a.send(["G28"])});function G(){let t=document.getElementById("jog-distance").value;return t=="1"?.1:t=="2"?1:t=="3"?10:t=="4"?100:1}document.getElementById("jog-yp").addEventListener("click",()=>{let t=G();a.send(["G91",`G0 Y${t}`,"G90"])});document.getElementById("jog-ym").addEventListener("click",()=>{let t=G();a.send(["G91",`G0 Y-${t}`,"G90"])});document.getElementById("jog-xp").addEventListener("click",()=>{let t=G();a.send(["G91",`G0 X${t}`,"G90"])});document.getElementById("jog-xm").addEventListener("click",()=>{let t=G();a.send(["G91",`G0 X-${t}`,"G90"])});document.getElementById("jog-zp").addEventListener("click",()=>{let t=G();a.send(["G91",`G0 Z${t}`,"G90"])});document.getElementById("jog-zm").addEventListener("click",()=>{let t=G();a.send(["G91",`G0 Z-${t}`,"G90"])});document.addEventListener("keyup",function(t){t.getModifierState("Shift")&&!t.getModifierState("Alt")?t.code==="ArrowUp"?(console.log("we saw shift arrow up!"),a.send(["G91","G0 Y10","G90"])):t.code==="ArrowDown"?(console.log("we saw shift arrow down!"),a.send(["G91","G0 Y-10","G90"])):t.code==="ArrowLeft"?(console.log("we saw shift arrow left!"),a.send(["G91","G0 X-10","G90"])):t.code==="ArrowRight"?(console.log("we saw shift arrow right!"),a.send(["G91","G0 X10","G90"])):t.code==="BracketLeft"?(console.log("we saw shift comma!"),a.send(["G91","G0 Z-10","G90"])):t.code==="BracketRight"&&(console.log("we saw shift period!"),a.send(["G91","G0 Z10","G90"])):!t.getModifierState("Shift")&&t.getModifierState("Alt")?t.code==="ArrowUp"?(console.log("we saw shift arrow up!"),a.send(["G91","G0 Y1","G90"])):t.code==="ArrowDown"?(console.log("we saw shift arrow down!"),a.send(["G91","G0 Y-1","G90"])):t.code==="ArrowLeft"?(console.log("we saw shift arrow left!"),a.send(["G91","G0 X-1","G90"])):t.code==="ArrowRight"?(console.log("we saw shift arrow right!"),a.send(["G91","G0 X1","G90"])):t.code==="BracketLeft"?(console.log("we saw shift comma!"),a.send(["G91","G0 Z-1","G90"])):t.code==="BracketRight"&&(console.log("we saw shift period!"),a.send(["G91","G0 Z1","G90"])):t.getModifierState("Shift")&&t.getModifierState("Alt")&&(t.code==="ArrowUp"?(console.log("we saw shift arrow up!"),a.send(["G91","G0 Y0.1","G90"])):t.code==="ArrowDown"?(console.log("we saw shift arrow down!"),a.send(["G91","G0 Y-0.1","G90"])):t.code==="ArrowLeft"?(console.log("we saw shift arrow left!"),a.send(["G91","G0 X-0.1","G90"])):t.code==="ArrowRight"?(console.log("we saw shift arrow right!"),a.send(["G91","G0 X0.1","G90"])):t.code==="BracketLeft"?(console.log("we saw shift comma!"),a.send(["G91","G0 Z-0.1","G90"])):t.code==="BracketRight"&&(console.log("we saw shift period!"),a.send(["G91","G0 Z0.1","G90"])))});function C(){const t=JSON.stringify(y),e=new Blob([t],{type:"text/plain"}),n=URL.createObjectURL(e),s=document.createElement("a");s.href=URL.createObjectURL(e),s.download="positions.json",s.click(),URL.revokeObjectURL(n)}async function x(){a.clearInspectBuffer(),await a.send(["G92"]);const t=/X:(.*?) Y:(.*?) Z:(.*?) A:(.*?) B:(.*?) /,e=new RegExp(t,"i");console.log("serial inspect buffer: ",a.inspectBuffer);for(var n=0;n<a.inspectBuffer.length;n++){let s=a.inspectBuffer[n];if(console.log(s),e.test(s)){const r=e.exec(s);let c=[r[1],r[2],r[3]];y.push(c);const o=document.createElement("div");o.className="position-item",o.innerHTML=`Position: ${c.join(", ")} <button class="remove-btn">X</button>`,document.getElementById("capture-output").appendChild(o),o.querySelector(".remove-btn").addEventListener("click",function(){o.remove();const d=y.indexOf(c);d>-1&&y.splice(d,1),console.log("positions: ",y)})}}console.log("positions: ",y)}const S=document.getElementById("pastingForm"),A=document.getElementById("generatedGcode");S.addEventListener("submit",async t=>{t.preventDefault();const e=t.submitter.name,n=new FormData(S),s=Object.fromEntries(n.entries());s.fileData=JSON.parse(await s.dataFile.text()),delete s.dataFile;const i=R(s.fileData,s);if(A.style.display="block",A.innerHTML=i.join(`
`),e!="execute")return;let r=w.show("Ensure Nozzles Are Level","Manually level the nozzles before hitting ok.");console.log("now we'll execute!!",r),r.then(c=>{console.log(c),a.send(i)})});function R(t,{dispenseDeg:e,retractionDeg:n,dwellMs:s}){const i=[];i.push("G90","G28","G28","G92 B0");let r=0;e=parseFloat(e),n=parseFloat(n),s=parseFloat(s);for(const[c,o,d]of t){const l=r+e,f=l-n;i.push(`G0 X${c} Y${o}`,`G0 Z${d}`,`G0 B${l}`,`G0 B${f}`,`G4 P${s}`,"G0 Z31.5"),r=f}return i.push("G0 X300 Y400"),i}
