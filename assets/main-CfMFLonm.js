var yt=Object.defineProperty;var vt=(t,e,n)=>e in t?yt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var ge=(t,e,n)=>vt(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();class wt{constructor(){ge(this,"timeout",async e=>new Promise(n=>setTimeout(n,e)));this.modalObject=document.getElementById("modal"),this.overlay=document.getElementById("overlay"),this.modalTitle=document.getElementById("modal-title"),this.modalContent=document.getElementById("modal-content"),this.modalNumInput=document.getElementById("modal-num-input"),this.modalClose=document.getElementById("modal-close"),this.modalOK=document.getElementById("modal-ok"),this.modalNG=document.getElementById("modal-ng"),this.receivedInput=void 0,this.setupEventListeners()}setupEventListeners(){this.modalClose.addEventListener("click",()=>{this.receivedInput=!1,this.hide()}),this.modalOK.addEventListener("keyup",e=>{e.code==="Enter"&&(e.preventDefault(),this.receivedInput=!0,this.hide())}),this.modalOK.addEventListener("click",()=>{this.receivedInput=!0,this.hide()}),this.modalNG.addEventListener("click",()=>{this.receivedInput=!1,this.hide()})}hide(){this.modalObject.style.display="none",this.overlay.style.display="none"}show(e,n,s){s===void 0&&(s=0),this.modalTitle.innerHTML=e,this.modalContent.innerHTML=n,this.modalObject.style.display="flex",this.overlay.style.display="block",s==0?this.modalNumInput.style.display="none":s==1&&(this.modalNumInput.style.display="block",this.modalNumInput.value=1),this.modalOK.focus();let i=this.waitForUserSelection();return i&&s==1&&(i=this.modalNumInput.value),i}async waitForUserSelection(){for(;this.receivedInput===void 0;)await this.timeout(50);let e=this.receivedInput;return this.receivedInput=void 0,e}}class bt{constructor(){ge(this,"timeout",async e=>new Promise(n=>setTimeout(n,e)));this.toastObject=document.getElementById("toast"),this.toastContent=document.getElementById("toast-content"),this.toastClose=document.getElementById("toast-close"),this.receivedInput=void 0,this.setupEventListeners()}setupEventListeners(){this.toastClose.addEventListener("click",()=>{this.receivedInput=!1})}hide(){this.toastObject.style.display="none"}async waitForUserSelection(){for(;this.receivedInput===void 0;)await this.timeout(50);let e=this.receivedInput;return this.receivedInput=void 0,this.hide(),e}show(e){return this.toastContent.innerHTML=e,this.toastObject.style.display="flex",this.waitForUserSelection()}}class xt{constructor(e){ge(this,"delay",e=>new Promise(n=>setTimeout(n,e)));this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.consoleDiv=document.getElementById("console"),this.port,this.shouldListen=!0,this.modal=e,this.receiveBuffer=[],this.inspectBuffer=[],this.sentCommandBuffer=[""],this.sentCommandBufferIndex=0,this.okRespTimeout=!1,this.timeoutID=void 0,this.bootCommands=["G90","M260 A112 B1 S1","M260 A109","M260 B48","M260 B27","M260 S1","M260 A112 B2 S1","M260 A109","M260 B48","M260 B27","M260 S1","G0 F35000"]}async appendToConsole(e,n){let s=document.createElement("p"),i=new Date().toISOString(),o="";n?o="[SEND]":o="[RECE]",s.innerHTML=o+" - "+i+" - "+e+`
`,this.consoleDiv.appendChild(s),this.consoleDiv.scrollTop=this.consoleDiv.scrollHeight}clearBuffer(){for(;this.receiveBuffer.length>0;)this.receiveBuffer.shift()}clearInspectBuffer(){for(;this.inspectBuffer.length>0;)this.inspectBuffer.shift()}dec2bin(e){return(e>>>0).toString(2)}async connect(){if(!navigator.serial)return this.modal.show("Browser Support","Please use a browser that supports WebSerial, like Chrome, Opera, or Edge. <a href='https://developer.mozilla.org/en-US/docs/Web/API/Web_Serial_API#browser_compatibility'>Supported Browsers."),!1;const e=1155;return this.port=await navigator.serial.requestPort({filters:[{usbVendorId:e}]}),console.log("Port Selected."),await this.port.open({baudRate:115200,bufferSize:255,dataBits:8,flowControl:"none",parity:"none",stopBits:1}),console.log("Port Opened."),this.listen(),document.querySelector("#connect").style.background="green",document.querySelector("#connect").style.color="white",document.querySelector("#connect").innerHTML="Connected",this.send(this.bootCommands),this.send(["M150 P255 R255 U255 B255"]),!0}async listen(){var e;for(;(e=this.port)!=null&&e.readable&&this.shouldListen;){console.log("Port is readable: Starting to listen.");let n="";document.getElementById("console");const s=this.port.readable.getReader();try{for(;this.shouldListen;){const{value:i,done:o}=await s.read();if(o){console.log("Closing reader.");break}const l=this.decoder.decode(i);for(n=n.concat(l);n.indexOf(`
`)!=-1;){let r=n.split(`
`);this.receiveBuffer.push(r[0]),this.appendToConsole(r[0],!1),this.inspectBuffer.push(r[0]),n=n.split(`
`).slice(1).join(`
`)}}}catch(i){console.error("Reading error.",i)}finally{s.releaseLock()}}}sleep(e){for(var n=new Date().getTime(),s=0;s<1e7&&!(new Date().getTime()-n>e);s++);}async setOkRespTimeout(){new Promise(e=>{this.timeoutID=setTimeout(()=>{console.log("timeout triggered"),this.okRespTimeout=!0,e()},5e3)})}async send(e){var n;if(console.log("sending: ",e),(n=this.port)!=null&&n.writable){const s=await this.port.writable.getWriter();try{for(const i of e){for(await s.write(this.encoder.encode(i+`
`)),this.setOkRespTimeout(),this.appendToConsole(i,!0),this.clearBuffer();!this.okRespTimeout;){let o=this.receiveBuffer.shift();if(o=="ok"){clearTimeout(this.timeoutID);break}(o="echo:busy: processing")&&(clearTimeout(this.timeoutID),this.setOkRespTimeout()),await new Promise(l=>setTimeout(l,50))}this.okRespTimeout=!1}}finally{s.releaseLock()}}else this.modal.show("Cannot Write","Cannot write to port. Have you connected?")}async sendRepl(){let e=[document.querySelector("#repl-input").value];this.sentCommandBuffer.splice(1,0,e[0]),this.sentCommandBufferIndex=0,this.send(e)}async leftAirOn(){const e=["M106","M106 P1 S255"];await this.send(e)}async leftAirOff(){const e=["M107","M107 P1"];await this.send(e)}async rightAirOn(){const e=["M106 P2 S255","M106 P3 S255"];await this.send(e)}async rightAirOff(){const e=["M107 P2","M107 P3"];await this.send(e)}async ledOn(){const e=["M150 P255 R255 U255 B255"];await this.send(e)}async ledOff(){const e=["M150 P0"];await this.send(e)}async disableSteppers(){const e=["M18"];await this.send(e)}async readLeftVac(){var d;if(!((d=this.port)!=null&&d.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;const e=["M260 A112 B1 S1"],n=50;this.clearInspectBuffer();let s,i,o;const l=new RegExp("data:(..)");await this.send(e),this.clearInspectBuffer(),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var r=0,h=this.inspectBuffer.length;r<h;r++){let p=this.inspectBuffer[r];if(console.log(this.inspectBuffer),l.test(p)){s=p.match("data:(..)")[1];break}}this.clearInspectBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var r=0,h=this.inspectBuffer.length;r<h;r++){let C=this.inspectBuffer[r];if(l.test(C)){i=C.match("data:(..)")[1];break}}this.clearInspectBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var r=0,h=this.inspectBuffer.length;r<h;r++){let C=this.inspectBuffer[r];if(l.test(C)){o=C.match("data:(..)")[1];break}}console.log(s,i,o);let u=parseInt(s+i+o,16);u&1<<23&&(u=u-2**24),await this.modal.show("Left Vacuum Sensor Value",u),this.clearInspectBuffer()}async readRightVac(){var d;if(!((d=this.port)!=null&&d.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;const e=["M260 A112 B2 S1"];let n,s,i;const o=new RegExp("data:(..)"),l=50;this.clearInspectBuffer(),await this.send(e),await this.delay(l),this.clearInspectBuffer(),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(l);for(var r=0,h=this.inspectBuffer.length;r<h;r++){let p=this.inspectBuffer[r];if(o.test(p)){n=p.match("data:(..)")[1];break}}this.clearInspectBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(l);for(var r=0,h=this.inspectBuffer.length;r<h;r++){let C=this.inspectBuffer[r];if(o.test(C)){s=C.match("data:(..)")[1];break}}this.clearInspectBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(l);for(var r=0,h=this.inspectBuffer.length;r<h;r++){let C=this.inspectBuffer[r];if(o.test(C)){i=C.match("data:(..)")[1];break}}let u=parseInt(n+s+i,16);u&1<<23&&(u=u-2**24),await this.modal.show("Right Vacuum Sensor Value",u),this.clearInspectBuffer()}async testTMC(){var i;if(!((i=this.port)!=null&&i.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;let e="";const n=["M122"];await this.clearBuffer(),await this.send(n),await this.delay(5e3),console.log(this.receiveBuffer);for(let o=0;o<this.receiveBuffer.length;o++)e=e.concat(this.receiveBuffer[o]+`
`);if(await this.modal.show("Stepper Driver Test Complete","Test is complete. Click OK to download test report.")==!0){let o=new Date().toISOString();o=o+"-tmctest.txt",this.download(o,e)}}async testVac(){var m;if(!((m=this.port)!=null&&m.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;let e="";const n=["M260 A112 B1 S1","M260 A109","M260 B48","M260 B10","M260 S1"],s=["M260 A112 B2 S1","M260 A109","M260 B48","M260 B10","M260 S1"],i=100;this.clearBuffer();let o,l,r;const h=new RegExp("data:(..)");await this.send(n),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var u=0,d=this.receiveBuffer.length;u<d;u++){let I=this.receiveBuffer[u];if(h.test(I)){o=I.match("data:(..)")[1],e=e.concat("Left MSB - "+o+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var u=0,d=this.receiveBuffer.length;u<d;u++){let O=this.receiveBuffer[u];if(h.test(O)){l=O.match("data:(..)")[1],e=e.concat("Left CSB - "+l+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var u=0,d=this.receiveBuffer.length;u<d;u++){let O=this.receiveBuffer[u];if(h.test(O)){r=O.match("data:(..)")[1],e=e.concat("Left LSB - "+r+`
`);break}}let p=parseInt(o+l+r,16);p&1<<23&&(p=p-2**24),e=e.concat("Left Val - "+p+`
`),this.clearBuffer(),await this.send(s),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var u=0,d=this.receiveBuffer.length;u<d;u++){let O=this.receiveBuffer[u];if(h.test(O)){o=O.match("data:(..)")[1],e=e.concat("Right MSB - "+o+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var u=0,d=this.receiveBuffer.length;u<d;u++){let O=this.receiveBuffer[u];if(h.test(O)){l=O.match("data:(..)")[1],e=e.concat("Right CSB - "+l+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i),console.log("current buffer length: ",this.receiveBuffer.length);for(var u=0,d=this.receiveBuffer.length;u<d;u++){let O=this.receiveBuffer[u];if(h.test(O)){r=O.match("data:(..)")[1],e=e.concat("Right LSB - "+r+`
`);break}}let E=parseInt(o+l+r,16);if(E&1<<23&&(E=E-2**24),e=e.concat("Right Val - "+E+`
`),console.log(p,E),await this.modal.show("Vacuum Sensor Test Complete","Test is complete. Click OK to download test report.")==!0){let I=new Date().toISOString();I=I+"-vactest.txt",this.download(I,e)}}download(e,n){var s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(n)),s.setAttribute("download",e),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)}async goToRelative(e,n){await this.send(["G91",`G0 X${e} Y${n}`,"G90"])}async goTo(e,n){await this.send([`G0 X${e} Y${n}`])}}function Bt(t){window.cv?window.cv.then(e=>t(e)):window.onOpenCVReady=()=>{window.cv.then(e=>t(e))}}class Et{constructor(e){this.cv=e,this.video=null,this.canvas=null,this.frame=null,this.cvFrame=null,this.displayCv=!1,this.cvDisplayTimer=null}async populateCameraList(e){try{const s=(await navigator.mediaDevices.enumerateDevices()).filter(i=>i.kind==="videoinput");e.innerHTML="",s.forEach(i=>{const o=document.createElement("option");o.value=i.deviceId,o.text=i.label||`Camera ${s.indexOf(i)+1}`,e.appendChild(o),i.label&&i.label.toLowerCase().includes("top")&&(e.value=i.deviceId)})}catch(n){console.error("Error populating camera list:",n)}}async startVideo(e,n){const s=await navigator.mediaDevices.getUserMedia({video:{deviceId:e?{exact:e}:void 0}});this.video=document.createElement("video"),this.video.srcObject=s,this.video.setAttribute("playsinline",!0),this.canvas=n,await new Promise(i=>{this.video.onloadedmetadata=()=>{this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight,i()}}),await this.video.play(),this.frame=new this.cv.Mat(this.video.videoHeight,this.video.videoWidth,this.cv.CV_8UC4),this.videoTick()}addReticle(e){const n=e.cols/2,s=e.rows/2,i=20,o=new this.cv.Scalar(255,200,0,255),l=3;let r=e.clone();return this.cv.line(r,new this.cv.Point(n-i,s),new this.cv.Point(n+i,s),o,l),this.cv.line(r,new this.cv.Point(n,s-i),new this.cv.Point(n,s+i),o,l),r}showFrame(e){this.cv.imshow(this.canvas,e)}CVdetectCircle(){try{this.cvFrame=this.frame.clone();let e=new this.cv.Mat;this.cv.cvtColor(this.cvFrame,e,this.cv.COLOR_RGBA2GRAY),this.cv.GaussianBlur(e,e,new this.cv.Size(9,9),2,2);let n=new this.cv.Mat;this.cv.HoughCircles(e,n,this.cv.HOUGH_GRADIENT,1,e.rows/8,50,30,1,50);let s=null;if(n.cols>0){console.log(n.cols);for(let i=0;i<n.cols;i++){const o=n.data32F[i*3+0],l=n.data32F[i*3+1],r=n.data32F[i*3+2];if(s===null)s=[o,l,r];else{let h=this.cvFrame.cols/2,u=this.cvFrame.cols/2,d=o-h,p=l-u,E=Math.sqrt(d*d+p*p),C=s[0]-h,m=s[1]-u,I=Math.sqrt(C*C+m*m);E<I&&(s=[o,l,r])}console.log("Circle %d, %d, rad %d",o,l,r),console.log(this.cvFrame.cols,this.cvFrame.rows),this.cv.circle(this.cvFrame,new this.cv.Point(o,l),3,new this.cv.Scalar(0,255,0,255),-1),this.cv.circle(this.cvFrame,new this.cv.Point(o,l),r,new this.cv.Scalar(255,0,0,255),3)}}return console.log("Best circle: ",s),e.delete(),n.delete(),this.addReticle(this.cvFrame),s}catch(e){return console.error("Error in detectCircle:",e),null}}loadNewFrame(){const e=this.canvas.getContext("2d");e.drawImage(this.video,0,0,this.video.videoWidth,this.video.videoHeight);const n=e.getImageData(0,0,this.video.videoWidth,this.video.videoHeight),s=this.cv.matFromImageData(n);s.copyTo(this.frame),s.delete(),this.cv.flip(this.frame,this.frame,-1)}videoTick(){this.displayCv?this.showFrame(this.cvFrame):(this.loadNewFrame(),this.frame=this.addReticle(this.frame),this.showFrame(this.frame)),requestAnimationFrame(()=>this.videoTick())}displayCvFrame(e){this.displayCv=!0,this.processTimer&&clearTimeout(this.processTimer),this.processTimer=setTimeout(()=>{this.displayCv=!1,this.needsCv=!1,this.cvFrame&&(this.cvFrame.delete(),this.cvFrame=null),this.processTimer=null},e)}stopVideo(e){this.isProcessing=!1,this.processTimer&&(clearTimeout(this.processTimer),this.processTimer=null),this.processedFrame&&(this.processedFrame.delete(),this.processedFrame=null),this.video&&this.video.srcObject&&(this.video.srcObject.getTracks().forEach(s=>s.stop()),this.video.remove(),this.video=null),this.src&&(this.src.delete(),this.src=null),this.dst&&(this.dst.delete(),this.dst=null),e.getContext("2d").clearRect(0,0,e.width,e.height),console.log("Video stopped and cleaned up")}}var It=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Te={},Ct={get exports(){return Te},set exports(t){Te=t}};(function(t){(function(e,n){t.exports?t.exports=n():e.moo=n()})(It,function(){var e=Object.prototype.hasOwnProperty,n=Object.prototype.toString,s=typeof new RegExp().sticky=="boolean";function i(c){return c&&n.call(c)==="[object RegExp]"}function o(c){return c&&typeof c=="object"&&!i(c)&&!Array.isArray(c)}function l(c){return c.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function r(c){var f=new RegExp("|"+c);return f.exec("").length-1}function h(c){return"("+c+")"}function u(c){if(!c.length)return"(?!)";var f=c.map(function(g){return"(?:"+g+")"}).join("|");return"(?:"+f+")"}function d(c){if(typeof c=="string")return"(?:"+l(c)+")";if(i(c)){if(c.ignoreCase)throw new Error("RegExp /i flag not allowed");if(c.global)throw new Error("RegExp /g flag is implied");if(c.sticky)throw new Error("RegExp /y flag is implied");if(c.multiline)throw new Error("RegExp /m flag is implied");return c.source}else throw new Error("Not a pattern: "+c)}function p(c,f){return c.length>f?c:Array(f-c.length+1).join(" ")+c}function E(c,f){for(var g=c.length,y=0;;){var w=c.lastIndexOf(`
`,g-1);if(w===-1||(y++,g=w,y===f)||g===0)break}var v=y<f?0:g+1;return c.substring(v).split(`
`)}function C(c){for(var f=Object.getOwnPropertyNames(c),g=[],y=0;y<f.length;y++){var w=f[y],v=c[w],x=[].concat(v);if(w==="include"){for(var P=0;P<x.length;P++)g.push({include:x[P]});continue}var S=[];x.forEach(function(b){o(b)?(S.length&&g.push(I(w,S)),g.push(I(w,b)),S=[]):S.push(b)}),S.length&&g.push(I(w,S))}return g}function m(c){for(var f=[],g=0;g<c.length;g++){var y=c[g];if(y.include){for(var w=[].concat(y.include),v=0;v<w.length;v++)f.push({include:w[v]});continue}if(!y.type)throw new Error("Rule has no type: "+JSON.stringify(y));f.push(I(y.type,y))}return f}function I(c,f){if(o(f)||(f={match:f}),f.include)throw new Error("Matching rules cannot also include states");var g={defaultType:c,lineBreaks:!!f.error||!!f.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var y in f)e.call(f,y)&&(g[y]=f[y]);if(typeof g.type=="string"&&c!==g.type)throw new Error("Type transform cannot be a string (type '"+g.type+"' for token '"+c+"')");var w=g.match;return g.match=Array.isArray(w)?w:w?[w]:[],g.match.sort(function(v,x){return i(v)&&i(x)?0:i(x)?-1:i(v)?1:x.length-v.length}),g}function R(c){return Array.isArray(c)?m(c):C(c)}var O=I("error",{lineBreaks:!0,shouldThrow:!0});function _(c,f){for(var g=null,y=Object.create(null),w=!0,v=null,x=[],P=[],S=0;S<c.length;S++)c[S].fallback&&(w=!1);for(var S=0;S<c.length;S++){var b=c[S];if(b.include)throw new Error("Inheritance is not allowed in stateless lexers");if(b.error||b.fallback){if(g)throw!b.fallback==!g.fallback?new Error("Multiple "+(b.fallback?"fallback":"error")+" rules not allowed (for token '"+b.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+b.defaultType+"')");g=b}var A=b.match.slice();if(w)for(;A.length&&typeof A[0]=="string"&&A[0].length===1;){var ie=A.shift();y[ie.charCodeAt(0)]=b}if(b.pop||b.push||b.next){if(!f)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+b.defaultType+"')");if(b.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+b.defaultType+"')")}if(A.length!==0){w=!1,x.push(b);for(var z=0;z<A.length;z++){var U=A[z];if(i(U)){if(v===null)v=U.unicode;else if(v!==U.unicode&&b.fallback===!1)throw new Error("If one rule is /u then all must be")}}var oe=u(A.map(d)),Y=new RegExp(oe);if(Y.test(""))throw new Error("RegExp matches empty string: "+Y);var ue=r(oe);if(ue>0)throw new Error("RegExp has capture groups: "+Y+`
Use (?: â€¦ ) instead`);if(!b.lineBreaks&&Y.test(`
`))throw new Error("Rule should declare lineBreaks: "+Y);P.push(h(oe))}}var re=g&&g.fallback,de=s&&!re?"ym":"gm",me=s||re?"":"|";v===!0&&(de+="u");var gt=new RegExp(u(P)+me,de);return{regexp:gt,groups:x,fast:y,error:g||O}}function B(c){var f=_(R(c));return new D({start:f},"start")}function j(c,f,g){var y=c&&(c.push||c.next);if(y&&!g[y])throw new Error("Missing state '"+y+"' (in token '"+c.defaultType+"' of state '"+f+"')");if(c&&c.pop&&+c.pop!=1)throw new Error("pop must be 1 (in token '"+c.defaultType+"' of state '"+f+"')")}function $(c,f){var g=c.$all?R(c.$all):[];delete c.$all;var y=Object.getOwnPropertyNames(c);f||(f=y[0]);for(var w=Object.create(null),v=0;v<y.length;v++){var x=y[v];w[x]=R(c[x]).concat(g)}for(var v=0;v<y.length;v++)for(var x=y[v],P=w[x],S=Object.create(null),b=0;b<P.length;b++){var A=P[b];if(A.include){var ie=[b,1];if(A.include!==x&&!S[A.include]){S[A.include]=!0;var z=w[A.include];if(!z)throw new Error("Cannot include nonexistent state '"+A.include+"' (in state '"+x+"')");for(var U=0;U<z.length;U++){var oe=z[U];P.indexOf(oe)===-1&&ie.push(oe)}}P.splice.apply(P,ie),b--}}for(var Y=Object.create(null),v=0;v<y.length;v++){var x=y[v];Y[x]=_(w[x],!0)}for(var v=0;v<y.length;v++){for(var ue=y[v],re=Y[ue],de=re.groups,b=0;b<de.length;b++)j(de[b],ue,Y);for(var me=Object.getOwnPropertyNames(re.fast),b=0;b<me.length;b++)j(re.fast[me[b]],ue,Y)}return new D(Y,f)}function Ee(c){for(var f=typeof Map<"u",g=f?new Map:Object.create(null),y=Object.getOwnPropertyNames(c),w=0;w<y.length;w++){var v=y[w],x=c[v],P=Array.isArray(x)?x:[x];P.forEach(function(S){if(typeof S!="string")throw new Error("keyword must be string (in keyword '"+v+"')");f?g.set(S,v):g[S]=v})}return function(S){return f?g.get(S):g[S]}}var D=function(c,f){this.startState=f,this.states=c,this.buffer="",this.stack=[],this.reset()};D.prototype.reset=function(c,f){return this.buffer=c||"",this.index=0,this.line=f?f.line:1,this.col=f?f.col:1,this.queuedToken=f?f.queuedToken:null,this.queuedText=f?f.queuedText:"",this.queuedThrow=f?f.queuedThrow:null,this.setState(f?f.state:this.startState),this.stack=f&&f.stack?f.stack.slice():[],this},D.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedText:this.queuedText,queuedThrow:this.queuedThrow}},D.prototype.setState=function(c){if(!(!c||this.state===c)){this.state=c;var f=this.states[c];this.groups=f.groups,this.error=f.error,this.re=f.regexp,this.fast=f.fast}},D.prototype.popState=function(){this.setState(this.stack.pop())},D.prototype.pushState=function(c){this.stack.push(this.state),this.setState(c)};var Ie=s?function(c,f){return c.exec(f)}:function(c,f){var g=c.exec(f);return g[0].length===0?null:g};D.prototype._getGroup=function(c){for(var f=this.groups.length,g=0;g<f;g++)if(c[g+1]!==void 0)return this.groups[g];throw new Error("Cannot find token type for matched text")};function Ce(){return this.value}if(D.prototype.next=function(){var c=this.index;if(this.queuedGroup){var f=this._token(this.queuedGroup,this.queuedText,c);return this.queuedGroup=null,this.queuedText="",f}var g=this.buffer;if(c!==g.length){var x=this.fast[g.charCodeAt(c)];if(x)return this._token(x,g.charAt(c),c);var y=this.re;y.lastIndex=c;var w=Ie(y,g),v=this.error;if(w==null)return this._token(v,g.slice(c,g.length),c);var x=this._getGroup(w),P=w[0];return v.fallback&&w.index!==c?(this.queuedGroup=x,this.queuedText=P,this._token(v,g.slice(c,w.index),c)):this._token(x,P,c)}},D.prototype._token=function(c,f,g){var y=0;if(c.lineBreaks){var w=/\n/g,v=1;if(f===`
`)y=1;else for(;w.exec(f);)y++,v=w.lastIndex}var x={type:typeof c.type=="function"&&c.type(f)||c.defaultType,value:typeof c.value=="function"?c.value(f):f,text:f,toString:Ce,offset:g,lineBreaks:y,line:this.line,col:this.col},P=f.length;if(this.index+=P,this.line+=y,y!==0?this.col=P-v+1:this.col+=P,c.shouldThrow){var S=new Error(this.formatError(x,"invalid syntax"));throw S}return c.pop?this.popState():c.push?this.pushState(c.push):c.next&&this.setState(c.next),x},typeof Symbol<"u"&&Symbol.iterator){var ce=function(c){this.lexer=c};ce.prototype.next=function(){var c=this.lexer.next();return{value:c,done:!c}},ce.prototype[Symbol.iterator]=function(){return this},D.prototype[Symbol.iterator]=function(){return new ce(this)}}return D.prototype.formatError=function(y,f){if(y==null)var g=this.buffer.slice(this.index),y={text:g,offset:this.index,lineBreaks:g.indexOf(`
`)===-1?0:1,line:this.line,col:this.col};var w=2,v=Math.max(y.line-w,1),x=y.line+w,P=String(x).length,S=E(this.buffer,this.line-y.line+w+1).slice(0,5),b=[];b.push(f+" at line "+y.line+" col "+y.col+":"),b.push("");for(var A=0;A<S.length;A++){var ie=S[A],z=v+A;b.push(p(String(z),P)+"  "+ie),z===y.line&&b.push(p("",P+y.col+1)+"^")}return b.join(`
`)},D.prototype.clone=function(){return new D(this.states,this.state)},D.prototype.has=function(c){return!0},{compile:B,states:$,error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:Ee}})})(Ct);const _e=Te,he="T_CODE",M="G_CODE",W="M_CODE",q="D_CODE",F="ASTERISK",G="PERCENT",$e="EQUALS",ae="COMMA",Q="OPERATOR",Se="GERBER_FORMAT",ve="GERBER_UNITS",ze="GERBER_TOOL_MACRO",qe="GERBER_TOOL_DEF",Ve="GERBER_LOAD_POLARITY",He="GERBER_STEP_REPEAT",fe="GERBER_MACRO_VARIABLE",Je="SEMICOLON",Ze="DRILL_UNITS",Fe="DRILL_ZERO_INCLUSION",L="COORD_CHAR",N="NUMBER",kt="WORD",Mt="WHITESPACE",V="NEWLINE",Tt="CATCHALL",St="ERROR",Ft=/^0*/,We=t=>t.replace(Ft,""),ye=t=>We(t.slice(1))||"0",Pt={[he]:{match:/T\d+/,value:ye},[M]:{match:/G\d+/,value:ye},[W]:{match:/M\d+/,value:ye},[q]:{match:/D\d+/,value:ye},[F]:"*",[G]:"%",[$e]:"=",[Se]:{match:/FS[LTDAI]+/,value:t=>t.slice(2)},[ve]:{match:/MO(?:IN|MM)/,value:t=>t.slice(2)},[ze]:{match:/AM[a-zA-Z_.$][\w.-]*/,value:t=>t.slice(2)},[qe]:{match:/ADD\d+[a-zA-Z_.$][\w.-]*/,value:t=>We(t.slice(3))},[Ve]:{match:/LP[DC]/,value:t=>t.slice(2)},[He]:"SR",[fe]:/\$\d+/,[Je]:";",[Ze]:/^(?:METRIC|INCH)/,[Fe]:{match:/,(?:TZ|LZ)/,value:t=>t.slice(1)},[L]:/[XYIJACFSBHZN]/,[N]:/[+-]?[\d.]+/,[Q]:["x","/","+","-","(",")"],[ae]:",",[kt]:/[a-zA-Z]+/,[Mt]:/[ \t]+/,[V]:{match:/\r?\n/,lineBreaks:!0},[Tt]:/\S/,[St]:_e.error};function Rt(){const t=_e.compile(Pt);return{feed:e};function e(s,i=null){return t.reset(s,i??void 0),n((i==null?void 0:i.offset)??0)}function n(s){return{[Symbol.iterator](){return this},next(){const i=t.next();if(i){const o={...i,offset:s+i.offset},l={...t.save(),offset:s+(t.index??0)};return{value:[o,l]}}return{value:void 0,done:!0}}}}}const Ue="gerber",Pe="drill",Re="mm",Oe="in",Ke="leading",Qe="trailing",Ot="absolute",Lt="incremental",Le="circle",et="rectangle",Nt="obround",At="polygon",jt="macroShape",Dt="shape",tt="move",Gt="segment",Xt="slot",Yt="line",_t="cwArc",$t="ccwArc",zt="single",qt="multi",Vt="dark",Ht="clear",we="TOKEN",Z="MIN_TO_MAX";function a(t,e){return{rule:we,type:t,value:e}}function te(t,e){return{rule:we,type:t,value:e,negate:!0}}function J(t){return{rule:Z,min:1,max:1,match:t}}function pe(t){return{rule:Z,min:0,max:1,match:t}}function H(t){return{rule:Z,min:0,max:Number.POSITIVE_INFINITY,match:t}}function nt(t){return{rule:Z,min:1,max:Number.POSITIVE_INFINITY,match:t}}function ne(t,e,n){return{rule:Z,min:t,max:e,match:n}}function st(t,e){const n=[];for(const s of e){const i=Zt(t,s.rules);if(i===ot)n.push(s);else if(i===it)return{filetype:s.filetype,nodes:s.createNodes(t)}}return n.length>0?{candidates:n,tokens:t}:{}}const it="FULL_MATCH",ot="PARTIAL_MATCH",Jt="NO_MATCH";function Zt(t,e){let n=0,s=0,i=0;for(;n<e.length&&s<t.length;){const o=e[n],l=t[s];if(rt(o,l))o.rule===we||o.rule===Z&&i>=o.max-1?(n++,s++,i=0):o.rule===Z&&(s++,i++);else if(o.rule===Z&&i>=o.min)i=0,n++;else return Jt}return n<e.length?ot:it}function rt(t,e){if(t.rule===we){const n=t.type===e.type,s=t.value===null||typeof t.value>"u"||typeof t.value=="string"&&t.value===e.value||t.value instanceof RegExp&&t.value.test(e.value),i=n&&s;return t.negate?!i:i}return Array.isArray(t.match)?t.match.some(n=>rt(n,e)):!1}const Wt="root",at="comment",Ut="drillHeader",lt="done",Ne="units",ct="coordinateFormat",ut="toolDefinition",Kt="toolMacro",Ae="toolChange",Qt="loadPolarity",en="stepRepeat",je="graphic",be="interpolateMode",tn="regionMode",nn="quadrantMode",sn="unimplemented",on="macroComment",rn="macroVariable",an="macroPrimitive";function se(t){return Object.fromEntries(t.map((e,n)=>[e,t[n-1]]).filter(([e,n])=>e.type===N&&(n==null?void 0:n.type)===L).map(([e,n])=>[n.value.toLowerCase(),e.value]))}function xe(t){return t.filter(e=>e.type===M).map(e=>e.value==="0"?tt:e.value==="1"?Yt:e.value==="2"?_t:e.value==="3"?$t:e.value==="5"?Pe:null)[0]??null}function ln(t){return t.filter(e=>e.type===q).map(e=>e.value==="1"?Gt:e.value==="2"?tt:e.value==="3"?Dt:null)[0]??null}function De(t){return t.map(e=>e.value).join("").trim()}function T(t,e={}){const{head:n=t[0],length:s=0}=e,i=s>0?t[t.indexOf(n)+s-1]:t[t.length-1];return{start:{line:n.line,column:n.col,offset:n.offset},end:{line:i.line,column:i.col,offset:i.offset}}}const cn={name:"units",rules:[J([a(Ze),a(W,"71"),a(W,"72")]),H([a(ae),a(Fe),a(N,/^0{1,8}\.0{1,8}$/)]),a(V)],createNodes(t){const e=t[0].value==="INCH"||t[0].value==="72"?Oe:Re,n=t.filter(o=>o.type===Fe).map(o=>o.value==="LZ"?Qe:o.value==="TZ"?Ke:null),s=t.filter(o=>o.type===N).map(o=>{const[l="",r=""]=o.value.split(".");return[l.length,r.length]}),i=[{type:Ne,position:T(t.slice(0,2)),units:e}];return(n.length>0||s.length>0)&&i.push({type:ct,position:T(t.slice(1)),mode:null,format:s[0]??null,zeroSuppression:n[0]??null}),i}},un={name:"tool",rules:[a(he),ne(0,12,[a(L,"C"),a(L,"F"),a(L,"S"),a(L,"B"),a(L,"H"),a(L,"Z"),a(N)]),a(V)],createNodes(t){const e=t[0].value,n=T(t),{c:s=null}=se(t.slice(1,-1)),i=s===null?null:{type:Le,diameter:Number(s)};return i?[{type:ut,hole:null,position:n,shape:i,code:e}]:[{type:Ae,position:n,code:e}]}},dn={name:"operationMode",rules:[J([a(M,"0"),a(M,"1"),a(M,"2"),a(M,"3"),a(M,"5")]),a(V)],createNodes:t=>[{type:be,position:T(t),mode:xe(t)}]},hn={name:"operation",rules:[ne(0,2,[a(he),a(M,"0"),a(M,"1"),a(M,"2"),a(M,"3"),a(M,"5")]),ne(2,8,[a(L),a(N)]),pe([a(he)]),a(V)],createNodes(t){const e=t.filter(p=>p.type===L||p.type===N),n=t.find(p=>p.type===M),s=t.find(p=>p.type===he),i=se(e),o=s?s.value:null,l=xe(t),r=T(t,{head:e[0],length:e.length+1}),h=T(t,{head:n,length:2}),u=T(t,{head:s,length:2}),d=[{type:je,position:r,graphic:null,coordinates:i}];return l&&d.unshift({type:be,position:h,mode:l}),o&&d.unshift({type:Ae,position:u,code:o}),d}},fn={name:"slot",rules:[ne(2,4,[a(L),a(N)]),a(M,"85"),ne(2,4,[a(L),a(N)]),a(V)],createNodes(t){const e=t.find(o=>o.type===M),n=e?t.indexOf(e):-1,s=Object.fromEntries(Object.entries(se(t.slice(0,n))).map(([o,l])=>[`${o}0`,l])),i=se(t.slice(n));return[{type:je,position:T(t),graphic:Xt,coordinates:{...s,...i}}]}},pn={name:"done",rules:[J([a(W,"30"),a(W,"0")]),a(V)],createNodes:t=>[{type:lt,position:T(t)}]},mn={name:"header",rules:[J([a(W,"48"),a(G)]),a(V)],createNodes:t=>[{type:Ut,position:T(t)}]},gn={name:"comment",rules:[a(Je),H([te(V)]),a(V)],createNodes:t=>[{type:at,comment:De(t.slice(1,-1)),position:T(t)}]},dt=[un,dn,hn,fn,gn,cn,pn,mn].map(t=>({...t,filetype:Pe})),yn={name:"macroComment",rules:[a(N,"0"),H([te(F)]),a(F)],createNodes:bn},vn={name:"macroVariable",rules:[a(fe),a($e),nt([a(N),a(Q),a(fe),a(L,"X")]),a(F)],createNodes:Bn},wn={name:"macroPrimitive",rules:[a(N),a(ae),nt([a(ae),a(N),a(Q),a(fe),a(L,"X")]),a(F)],createNodes:xn};function bn(t){const e=t.slice(1,-1).map(n=>n.text).join("").trim();return[{type:on,position:T(t),comment:e}]}function xn(t){const e=t[0].value,n=[[]];let s=n[0];for(const o of t.slice(2,-1))o.type===ae?(s=[],n.push(s)):s.push(o);const i=n.map(o=>ht(o));return[{type:an,position:T(t),code:e,parameters:i}]}function Bn(t){const e=t[0].value,n=ht(t.slice(2,-1));return[{type:rn,position:T(t),name:e,value:n}]}function ht(t){const e=t.map(l=>l.type===L?{...l,type:Q,value:"x"}:l);return o();function n(){return e[0]??null}function s(){const l=e.shift();if(l.type===N)return Number(l.value);if(l.type===fe)return l.value;const r=o();return e.shift(),r}function i(){let l=s(),r=n();for(;(r==null?void 0:r.type)===Q&&(r.value==="x"||r.value==="/");)e.shift(),l={left:l,right:s(),operator:r.value},r=n();return l}function o(){let l=i(),r=n();for(;(r==null?void 0:r.type)===Q&&(r.value==="+"||r.value==="-")||(r==null?void 0:r.type)===N;){let h="+";r.type===Q&&(e.shift(),h=r.value);const u=i();l={left:l,right:u,operator:h},r=n()}return l}}const Ge=[wn,vn,yn];function En(t){let e=Ge,n=[];const s=[];for(const i of t){const o=st([...n,i],e);o.nodes&&s.push(...o.nodes),n=o.tokens??[],e=o.candidates??Ge}return s}const ke=t=>{if(t.length===1){const[e]=t;return{type:Le,diameter:e}}if(t.length===2){const[e,n]=t;return{type:et,xSize:e,ySize:n}}return null},In={name:"done",rules:[J([a(W,"0"),a(W,"2")]),a(F)],createNodes:t=>[{type:lt,position:T(t)}]},Cn={name:"comment",rules:[a(M,"4"),H([te(F)]),a(F)],createNodes:t=>[{type:at,position:T(t),comment:De(t.slice(1,-1))}]},kn={name:"format",rules:[a(G),a(Se),H([te(L,"X")]),a(L,"X"),a(N),a(L,"Y"),a(N),H([te(F)]),a(F),ne(0,2,[a(ve),a(F)]),a(G)],createNodes(t){var e;let n=null,s=null,i=null;const o=se(t),l=t.findIndex(u=>u.type===F),r=t.find(u=>u.type===ve);for(const u of t.filter(d=>d.type===Se))u.value.includes("T")&&(s=Qe),u.value.includes("L")&&(s=Ke),u.value.includes("I")&&(i=Lt),u.value.includes("A")&&(i=Ot);if(o.x===o.y&&((e=o.x)==null?void 0:e.length)===2){const u=Number(o.x[0]),d=Number(o.x[1]);u&&d&&(n=[u,d])}const h=[{type:ct,position:T(t.slice(1,l+1)),zeroSuppression:s,format:n,mode:i}];return r&&h.push({type:Ne,position:T(t.slice(1,-1),{head:r}),units:r.value==="MM"?Re:Oe}),h}},Mn={name:"units",rules:[a(G),a(ve),a(F),a(G)],createNodes:t=>[{type:Ne,position:T(t.slice(1,-1)),units:t[1].value==="MM"?Re:Oe}]},Tn={name:"toolMacro",rules:[a(G),a(ze),a(F),H([te(G)]),a(G)],createNodes(t){const e=t[1].value,n=T(t.slice(1,-1)),s=t.slice(3,-1);return[{type:Kt,position:n,children:En(s),name:e}]}},Sn={name:"toolDefinition",rules:[a(G),a(qe),H([a(ae),a(N),a(L,"X")]),a(F),a(G)],createNodes(t){let e,n=null;const s=/(\d+)(.+)/.exec(t[1].value),[,i="",o=""]=s??[],l=t.slice(3,-2).filter(r=>r.type===N).map(r=>Number(r.value));switch(o){case"C":{const[r,...h]=l;e={type:Le,diameter:r},n=ke(h);break}case"R":case"O":{const[r,h,...u]=l;e={type:o==="R"?et:Nt,xSize:r,ySize:h},n=ke(u);break}case"P":{const[r,h,u=null,...d]=l;e={type:At,diameter:r,vertices:h,rotation:u},n=ke(d);break}default:e={type:jt,name:o,variableValues:l}}return[{type:ut,position:T(t.slice(1,-1)),code:i,shape:e,hole:n}]}},Fn={name:"toolChange",rules:[pe([a(M,"54")]),a(q),a(F)],createNodes:t=>[{type:Ae,position:T(t),code:t.find(e=>e.type===q).value}]},ft=t=>{const e=ln(t),n=se(t),s=xe(t),i=T(t,{head:s?t[1]:t[0]}),o=[{type:je,position:i,graphic:e,coordinates:n}];if(s){const l=T(t,{head:t[0],length:2});o.unshift({type:be,position:l,mode:s})}return o},Pn={name:"operation",rules:[pe([a(M,"1"),a(M,"2"),a(M,"3")]),ne(2,8,[a(L),a(N)]),pe([a(q,"1"),a(q,"2"),a(q,"3")]),a(F)],createNodes:ft},Rn={name:"operationWithoutCoords",rules:[pe([a(M,"1"),a(M,"2"),a(M,"3")]),J([a(q,"1"),a(q,"2"),a(q,"3")]),a(F)],createNodes:ft},On={name:"interpolationMode",rules:[J([a(M,"1"),a(M,"2"),a(M,"3")]),a(F)],createNodes:t=>[{type:be,position:T(t),mode:xe(t)}]},Ln={name:"regionMode",rules:[J([a(M,"36"),a(M,"37")]),a(F)],createNodes:t=>[{type:tn,position:T(t),region:t[0].value==="36"}]},Nn={name:"quadrantMode",rules:[J([a(M,"74"),a(M,"75")]),a(F)],createNodes:t=>[{type:nn,position:T(t),quadrant:t[0].value==="74"?zt:qt}]},An={name:"loadPolarity",rules:[a(G),a(Ve),a(F),a(G)],createNodes:t=>[{type:Qt,position:T(t.slice(1,-1)),polarity:t[1].value==="D"?Vt:Ht}]},jn={name:"stepRepeat",rules:[a(G),a(He),H([a(L),a(N)]),a(F),a(G)],createNodes(t){const e=se(t),n=Object.fromEntries(Object.entries(e).map(([s,i])=>[s,Number(i)]));return[{type:en,position:T(t.slice(1,-1)),stepRepeat:n}]}},Dn={name:"unimplementedExtendedCommand",rules:[a(G),H([te(F)]),a(F),a(G)],createNodes:t=>[{type:sn,position:T(t.slice(1,-1)),value:De(t)}]},pt=[Pn,Rn,On,Fn,Sn,Tn,Cn,Ln,Nn,An,jn,kn,Mn,In,Dn].map(t=>({...t,filetype:Ue})),Gn=[...pt,...dt];function Xn(t,e=null){const n=[];let s=r(),i=[],o=null,l="";for(const[h,u]of t){const d=st([...i,h],s);d.nodes?(n.push(...d.nodes),o=u,l=""):l+=h.text,e=e??d.filetype??null,i=d.tokens??[],s=d.candidates??r()}return{filetype:e,unmatched:l,nodes:n,lexerState:o};function r(){return e===Ue?pt:e===Pe?dt:Gn}}function Yn(){const t=Rt(),e=[];let n=null,s=null,i="";const o={lexer:t,feed:l,result:r};return o;function l(h){const u=t.feed(`${i}${h}`,s),d=Xn(u,n);return n=n??d.filetype,i=d.unmatched,s=d.lexerState??s,e.push(...d.nodes),o}function r(){if(n===null)throw new Error("File type not recognized");return{type:Wt,filetype:n,children:e}}}function _n(t){return Yn().feed(t).result()}function $n(t,e){return Array.isArray(e)?[t.a*e[0]+t.c*e[1]+t.e,t.b*e[0]+t.d*e[1]+t.f]:{x:t.a*e.x+t.c*e.y+t.e,y:t.b*e.x+t.d*e.y+t.f}}function zn(t){const{a:e,b:n,c:s,d:i,e:o,f:l}=t,r=e*i-n*s;return{a:i/r,b:n/-r,c:s/-r,d:e/r,e:(i*o-s*l)/-r,f:(n*o-e*l)/r}}function mt(...t){t=Array.isArray(t[0])?t[0]:t;const e=(n,s)=>({a:n.a*s.a+n.c*s.b,c:n.a*s.c+n.c*s.d,e:n.a*s.e+n.c*s.f+n.e,b:n.b*s.a+n.d*s.b,d:n.b*s.c+n.d*s.d,f:n.b*s.e+n.d*s.f+n.f});switch(t.length){case 0:throw new Error("no matrices provided");case 1:return t[0];case 2:return e(t[0],t[1]);default:{const[n,s,...i]=t,o=e(n,s);return mt(o,...i)}}}function qn(t,e=1e10){return{a:Math.round(t.a*e)/e,b:Math.round(t.b*e)/e,c:Math.round(t.c*e)/e,d:Math.round(t.d*e)/e,e:Math.round(t.e*e)/e,f:Math.round(t.f*e)/e}}function Vn(t,e){const n=t[0].x!=null?t[0].x:t[0][0],s=t[0].y!=null?t[0].y:t[0][1],i=e[0].x!=null?e[0].x:e[0][0],o=e[0].y!=null?e[0].y:e[0][1],l=t[1].x!=null?t[1].x:t[1][0],r=t[1].y!=null?t[1].y:t[1][1],h=e[1].x!=null?e[1].x:e[1][0],u=e[1].y!=null?e[1].y:e[1][1],d=t[2].x!=null?t[2].x:t[2][0],p=t[2].y!=null?t[2].y:t[2][1],E=e[2].x!=null?e[2].x:e[2][0],C=e[2].y!=null?e[2].y:e[2][1],m={a:n-d,b:s-p,c:l-d,d:r-p,e:d,f:p},I={a:i-E,b:o-C,c:h-E,d:u-C,e:E,f:C},R=zn(m),O=mt([I,R]);return qn(O)}function Hn(t,e){function n(){this.constructor=t}n.prototype=e.prototype,t.prototype=new n}function Be(t,e,n,s){var i=Error.call(this,t);return Object.setPrototypeOf&&Object.setPrototypeOf(i,Be.prototype),i.expected=e,i.found=n,i.location=s,i.name="SyntaxError",i}Hn(Be,Error);function Me(t,e,n){return n=n||" ",t.length>e?t:(e-=t.length,n+=n.repeat(e),t+n.slice(0,e))}Be.prototype.format=function(t){var e="Error: "+this.message;if(this.location){var n=null,s;for(s=0;s<t.length;s++)if(t[s].source===this.location.source){n=t[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,o=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,l=this.location.source+":"+o.line+":"+o.column;if(n){var r=this.location.end,h=Me("",o.line.toString().length," "),u=n[i.line-1],d=i.line===r.line?r.column:u.length+1,p=d-i.column||1;e+=`
 --> `+l+`
`+h+` |
`+o.line+" | "+u+`
`+h+" | "+Me("",i.column-1," ")+Me("",p,"^")}else e+=`
 at `+l}return e};Be.buildMessage=function(t,e){var n={literal:function(u){return'"'+i(u.text)+'"'},class:function(u){var d=u.parts.map(function(p){return Array.isArray(p)?o(p[0])+"-"+o(p[1]):o(p)});return"["+(u.inverted?"^":"")+d.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(u){return u.description}};function s(u){return u.charCodeAt(0).toString(16).toUpperCase()}function i(u){return u.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(d){return"\\x0"+s(d)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(d){return"\\x"+s(d)})}function o(u){return u.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(d){return"\\x0"+s(d)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(d){return"\\x"+s(d)})}function l(u){return n[u.type](u)}function r(u){var d=u.map(l),p,E;if(d.sort(),d.length>0){for(p=1,E=1;p<d.length;p++)d[p-1]!==d[p]&&(d[E]=d[p],E++);d.length=E}switch(d.length){case 1:return d[0];case 2:return d[0]+" or "+d[1];default:return d.slice(0,-1).join(", ")+", or "+d[d.length-1]}}function h(u){return u?'"'+i(u)+'"':"end of input"}return"Expected "+r(t)+" but "+h(e)+" found."};class ee{constructor(e,n,s){this.x=e,this.y=n,this.z=s,this.calX=null,this.calY=null,this.canvasX=null,this.canvasY=null,this.docElement=null}toArray(){return[this.x,this.y,this.z]}static fromArray(e){return new ee(e[0],e[1],e[2])}}class Jn extends ee{constructor(e,n,s,i,o){super(e,n,s),this.searchX=i,this.searchY=o}}class Zn{constructor(e,n){this.placements=[],this.fiducials=[],this.dispenseDegrees=30,this.retractionDegrees=1,this.dwellMilliseconds=100,this.lumen=e,this.toast=n,this.jobCanvas=document.getElementById("pointViz"),this.clickedFidBuffer=[]}drawJobToCanvas(){const e=this.jobCanvas.getContext("2d");let n=1/0,s=1/0,i=-1/0,o=-1/0;for(const m of this.placements)n=Math.min(n,m.x),s=Math.min(s,m.y),i=Math.max(i,m.x),o=Math.max(o,m.y);for(const m of this.fiducials)n=Math.min(n,m.x),s=Math.min(s,m.y),i=Math.max(i,m.x),o=Math.max(o,m.y);const l=Math.max(i-n,o-s)*.1;n-=l,s-=l,i+=l,o+=l;const r=i-n,h=o-s,u=this.jobCanvas.width/r,d=this.jobCanvas.height/h,p=Math.min(u,d),E=-n,C=-s;e.clearRect(0,0,this.jobCanvas.width,this.jobCanvas.height),e.fillStyle="blue";for(let m of this.fiducials){const I=(m.x+E)*p,R=(m.y+C)*p;m.canvasX=I,m.canvasY=R,e.beginPath(),e.arc(I,this.jobCanvas.height-R,2,0,Math.PI*2),e.fill()}e.fillStyle="red";for(let m of this.placements){const I=(m.x+E)*p,R=(m.y+C)*p;m.canvasX=I,m.canvasY=R,e.beginPath(),e.arc(I,this.jobCanvas.height-R,2,0,Math.PI*2),e.fill()}}returnClosestFidFromClickCoordinates(e,n){let i=null,o=1/0;for(const l of this.fiducials){const r=Math.sqrt(Math.pow(l.canvasX-e,2)+Math.pow(l.canvasY-n,2));r<10&&r<o&&(o=r,i=l)}return i}async parseGerber(e){const n=document.getElementById(e);if(!n||!n.files[0])return console.error("No file selected"),[];const s=await n.files[0].text(),i=_n(s);console.log(i);let o=[],l,r,h,u,d=1e6,p=1,E=NaN,C=NaN;for(const m of i.children)if(m.type=="units")m.units&&(m.units==="mm"?p=1:m.units==="in"?(console.log("Converting from inches"),p=25.4):console.error("Unknown unit format: ",m.units));else if(m.type==="coordinateFormat"){if(m.format){let I=m.format[1];console.log("Got coordinate format command, decimal places: ",I),d=Math.pow(10,I)}else console.log("Invalid coordinate");m.mode!="absolute"&&alert("Invalid Gerber coordinate format: "+m.mode+`
Try re-exporting with absolute coordinates`)}else if(m.type==="graphic"&&m.graphic==="shape"){let I=m.coordinates.x,R=m.coordinates.y;(Number.isNaN(I)||I===void 0)&&(Number.isNaN(E)?console.error("No reference X for this point: ",m):I=E),(Number.isNaN(R)||R===void 0)&&(Number.isNaN(C)?console.error("No reference Y for this point: ",m):R=C),o.push({x:I/d*p,y:R/d*p}),(l===void 0||m.coordinates.x/d*p<l)&&(l=m.coordinates.x/d*p),(r===void 0||m.coordinates.y/d*p<r)&&(r=m.coordinates.y/d*p),(h===void 0||m.coordinates.x/d*p>h)&&(h=m.coordinates.x/d*p),(u===void 0||m.coordinates.y/d*p>u)&&(u=m.coordinates.y/d*p),Number.isNaN(m.coordinates.x)||m.coordinates.x===void 0||(E=m.coordinates.x),Number.isNaN(m.coordinates.y)||m.coordinates.y===void 0||(C=m.coordinates.y)}return console.log(o),o}async loadJobFromGerbers(){const e=await this.parseGerber("pasteGerberFile");let n=await this.parseGerber("maskGerberFile");console.log("pastePoints: ",e),console.log("maskPoints: ",n),n=n.filter(h=>!e.includes(h));let s=[];for(const h of n)e.includes(h)||s.push(h);console.log("onlyInMask: ",s);for(const h of e){const u=new ee(h.x,h.y,31.5);this.placements.push(u)}for(const h of s){const u=new ee(h.x,h.y,31.5);this.fiducials.push(u)}this.drawJobToCanvas();function i(h){const u=this.jobCanvas.getBoundingClientRect(),d=h.clientX-u.left,p=this.jobCanvas.height-(h.clientY-u.top);let E=this.returnClosestFidFromClickCoordinates(d,p);if(E!==null){this.toast.receivedInput=E,console.log("her'es the point: ",this.toast.receivedInput);const C=this.jobCanvas.getContext("2d");C.fillStyle="green",C.fillRect(E.canvasX-4,this.jobCanvas.height-E.canvasY-4,8,8)}else console.log("no matching click")}console.log("setting event listener"),this.jobCanvas.addEventListener("click",i.bind(this));const o=await this.toast.show("Please click on FID1 in the display."),l=await this.toast.show("Please click on FID2 in the display."),r=await this.toast.show("Please click on FID3 in the display.");this.jobCanvas.removeEventListener("click",i),this.fiducials=[o,l,r],console.log("fiducials: ",this.fiducials),console.log("placements: ",this.placements),this.loadJobIntoPositionList(),this.drawJobToCanvas()}async findBoardRoughPosition(){await this.toast.show("Please jog the camera to be centered on FID1.");const e=await this.lumen.grabBoardPosition();console.log("fid1Rough: ",e),this.fiducials[0].searchX=parseFloat(e[0]),this.fiducials[0].searchY=parseFloat(e[1]),await this.toast.show("Please jog the camera to be centered on FID2.");const n=await this.lumen.grabBoardPosition();this.fiducials[1].searchX=parseFloat(n[0]),this.fiducials[1].searchY=parseFloat(n[1]),await this.toast.show("Please jog the camera to be centered on FID3.");const s=await this.lumen.grabBoardPosition();this.fiducials[2].searchX=parseFloat(s[0]),this.fiducials[2].searchY=parseFloat(s[1]),await this.toast.show("Please jog the paste extruder tip to just barely touch the board.");let i=await this.lumen.grabBoardPosition();await this.lumen.serial.send(["G0 Z31.5"]),i=parseFloat(i[2])-.2;for(const o of this.placements)o.z=i;console.log("this.fiducials: ",this.fiducials),this.transformPlacements([[this.fiducials[0].searchX,this.fiducials[0].searchY],[this.fiducials[1].searchX,this.fiducials[1].searchY],[this.fiducials[2].searchX,this.fiducials[2].searchY]]),console.log(this.placements),this.loadJobIntoPositionList()}async performTipCalibration(){await this.toast.show("Please jog the camera to be centered on any fiducial.");const e=await this.lumen.grabBoardPosition();await this.lumen.serial.send(["G0 Z31.5"]),await this.lumen.serial.goToRelative(-45,63),await this.lumen.serial.send(["G0 Z46.5"]),await this.toast.show("Please jog the nozzle tip to be perfectly centered on and touching the fiducial.");const n=await this.lumen.grabBoardPosition();await this.lumen.serial.send(["G0 Z31.5"]),this.lumen.tipXoffset=n[0]-e[0],this.lumen.tipYoffset=n[1]-e[1]}async performFiducialCalibration(){if(this.fiducials.length!==3){console.error("No fids in this job, cannot perform fiducial calibration.");return}let e=[];for(let n=0;n<this.fiducials.length;n++){const s=this.fiducials[n];console.log(`Processing fiducial ${n+1}:`,s),console.log("jogging to fid: ",s.searchX,s.searchY);try{await this.lumen.serial.goTo(s.searchX,s.searchY),await new Promise(o=>setTimeout(o,1500)),await this.lumen.jogToFiducial(),await new Promise(o=>setTimeout(o,1500)),await this.lumen.jogToFiducial(),await new Promise(o=>setTimeout(o,1500));const i=await this.lumen.grabBoardPosition();console.log(`Fiducial ${n+1} final position:`,i),e.push([parseFloat(i[0]),parseFloat(i[1])]),s.calX=i[0],s.calY=i[1]}catch(i){throw console.error(`Error processing fiducial ${n+1}:`,i),i}}console.log("All fiducials processed, transforming placements..."),this.transformPlacements(e),console.log("fid cal complete: ",this.fiducials),this.loadJobIntoPositionList()}loadJobIntoPositionList(){const e=document.querySelector(".positions-list");e.innerHTML="";for(let n of this.placements)this.createPositionElement(n,!1);for(let n of this.fiducials)this.createPositionElement(n,!0)}handleFiducialSelectionClick(e){const n=this.jobCanvas.getBoundingClientRect(),s=e.clientX-n.left,i=e.clientY-n.top;let o=this.returnClosestFidFromClickCoordinates(s,i);o&&(ctx.beginPath(),ctx.arc(o.canvasX,n.height-o.canvasY,6,0,Math.PI*2),ctx.fill(),this.clickedFidBuffer.push(o),currentFidIndex++,currentFidIndex<3?updateModalForFid():(modal.style.display="none",overlay.style.display="none",this.fiducials=this.clickedFidBuffer,this.clickedFidBuffer=[],console.log(this.fiducials),canvas.removeEventListener("click",this.handleFiducialSelectionClick)))}async captureNewPosition(){if(console.log("Job capture method called"),!this.lumen.serial){console.error("Serial manager not set");return}console.log("Serial manager is set, proceeding with capture"),this.lumen.serial.clearInspectBuffer(),console.log("Inspect buffer cleared"),await this.lumen.serial.send(["G92"]),console.log("G92 command sent");const e=/X:(.*?) Y:(.*?) Z:(.*?) A:(.*?) B:(.*?) /,n=new RegExp(e,"i");console.log("Serial inspect buffer contents:",this.lumen.serial.inspectBuffer);for(var s=0;s<this.lumen.serial.inspectBuffer.length;s++){let i=this.lumen.serial.inspectBuffer[s];console.log("Checking line:",i);let o=n.test(i);if(console.log("Regex test result:",o),o){const l=n.exec(i);console.log("Position matches:",l),this.addPoint(parseFloat(l[1]),parseFloat(l[2]),parseFloat(l[3])),console.log("Point added to job"),this.loadJobIntoPositionList();return}}console.log("No valid position found in inspect buffer")}addPoint(e,n,s){let i=new ee(e,n,s);this.placements.push(i)}async importFromFile(e){try{const n=await new Promise((r,h)=>{const u=new FileReader;u.onload=d=>r(d.target.result),u.onerror=d=>h(d),u.readAsText(e)}),s=JSON.parse(n);this.placements=(s.placements||[]).map(r=>{const h=new ee(r.x,r.y,r.z);return h.calX=r.calX,h.calY=r.calY,h.canvasX=r.canvasX,h.canvasY=r.canvasY,h}),this.fiducials=(s.fiducials||[]).map(r=>{const h=new Jn(r.x,r.y,r.z,r.searchX,r.searchY);return h.calX=r.calX,h.calY=r.calY,h.canvasX=r.canvasX,h.canvasY=r.canvasY,h}),this.dispenseDegrees=s.dispenseDegrees,this.retractionDegrees=s.retractionDegrees,this.dwellMilliseconds=s.dwellMilliseconds,typeof s.tipXoffset<"u"&&(this.lumen.tipXoffset=s.tipXoffset),typeof s.tipYoffset<"u"&&(this.lumen.tipYoffset=s.tipYoffset);const i=document.getElementById("jobDispenseDeg"),o=document.getElementById("jobRetractionDeg"),l=document.getElementById("jobDwellMs");return i&&(i.value=this.dispenseDegrees),o&&(o.value=this.retractionDegrees),l&&(l.value=this.dwellMilliseconds),this.loadJobIntoPositionList(),this.drawJobToCanvas(),{success:!0}}catch(n){return{success:!1,error:n.message||n.toString()}}}async saveToFile(){const e=this.export(),n=new Blob([e],{type:"application/json"}),i=await(await window.showSaveFilePicker({suggestedName:"job.json",types:[{description:"JSON Files",accept:{"application/json":[".json"]}}]})).createWritable();await i.write(n),await i.close()}createPositionElement(e,n){const s=document.querySelector(".positions-list"),i=document.createElement("div");i.className="position-item";let o,l;e.calX!=null&e.calY!=null?(o=e.calX,l=e.calY):e.searchX!=null&e.searchY!=null?(o=e.searchX,l=e.searchY):(o=e.x,l=e.y),n?i.innerHTML=`
            <span class="position-text">Fiducial: X:${o} Y:${l} Z:${e.z}</span>
            <div class="button-group">
                <button class="move-btn">â˜‰</button>
                <button class="remove-btn">X</button>
            </div>
        `:i.innerHTML=`
            <span class="position-text">Position: X:${o} Y:${l} Z:${e.z}</span>
            <div class="button-group">
                <button class="move-btn">â˜‰</button>
                <button class="remove-btn">X</button>
            </div>
        `,i.querySelector(".move-btn").addEventListener("click",()=>{let r,h;e.calX!=null&e.calY!=null?(r=e.calX,h=e.calY):(r=e.x,h=e.y),this.lumen.serial.send(["G90","G0 Z31.5",`G0 X${r} Y${h}`])}),i.querySelector(".remove-btn").addEventListener("click",()=>{i.remove(),this.placements=this.placements.filter(r=>r.x!==e.x||r.y!==e.y||r.z!==e.z),this.fiducials=this.fiducials.filter(r=>r.x!==e.x||r.y!==e.y||r.z!==e.z),this.loadJobIntoPositionList(),this.drawJobToCanvas(),console.log(this.placements)}),s.appendChild(i)}slice(){const e=[];e.push("G90","G92 B0","G0 Z31.5");let n=0;console.log(this.positions);const s=parseFloat(this.dispenseDegrees),i=parseFloat(this.retractionDegrees),o=parseFloat(this.dwellMilliseconds);for(const l of this.placements){const r=n-s,h=r+i;let u=l.x,d=l.y;l.calX!=null&&(u=l.calX),l.calY!=null&&(d=l.calY),e.push(`G0 X${u+this.lumen.tipXoffset} Y${d+this.lumen.tipYoffset}`,`G0 Z${l.z}`,`G0 B${r}`,`G0 B${h}`,`G4 P${o}`,"G0 Z31.5"),n=h}return e.push("G0 X5 Y5"),e}async run(){let e=this.slice();this.toast.show("Running job. Close this to cancel.");for(const n of e){if(console.log(this.toast.receivedInput),this.toast.toastObject.style.display=="none"){await this.lumen.serial.send(["G0 Z31.5"]),await this.lumen.serial.send(["G0 X5 Y5"]);return}await this.lumen.serial.send([n])}this.toast.receivedInput=!1}export(){const e={placements:this.placements.map(n=>({x:n.x,y:n.y,z:n.z,calX:n.calX,calY:n.calY,canvasX:n.canvasX,canvasY:n.canvasY})),fiducials:this.fiducials.map(n=>({x:n.x,y:n.y,z:n.z,calX:n.calX,calY:n.calY,canvasX:n.canvasX,canvasY:n.canvasY,searchX:n.searchX,searchY:n.searchY})),dispenseDegrees:this.dispenseDegrees,retractionDegrees:this.retractionDegrees,dwellMilliseconds:this.dwellMilliseconds,tipXoffset:this.lumen.tipXoffset,tipYoffset:this.lumen.tipYoffset};return JSON.stringify(e,null,2)}transformPlacements(e){const n=[[this.fiducials[0].x,this.fiducials[0].y],[this.fiducials[1].x,this.fiducials[1].y],[this.fiducials[2].x,this.fiducials[2].y]],s=Vn(n,e);for(let i of this.placements){let o=$n(s,[i.x,i.y]);i.calX=o[0],i.calY=o[1]}}}class Wn{constructor(e){this.serial=e,this.video=null,this.tipXoffset=0,this.tipYoffset=0}addVideoManager(e){this.video=e}async grabBoardPosition(){console.log("grabbing board position"),this.serial.clearInspectBuffer(),await this.serial.send(["G92"]),console.log("sent G92");const e=/X:(.*?) Y:(.*?) Z:(.*?) A:(.*?) B:(.*?) /,n=new RegExp(e,"i");console.log("serial inspect buffer: ",this.serial.inspectBuffer);let s=[];for(var i=0;i<this.serial.inspectBuffer.length;i++){let o=this.serial.inspectBuffer[i];if(console.log(o),n.test(o)){const r=n.exec(o);s=[r[1],r[2],r[3]];break}}return console.log("positionArray: ",s),s}async jogToFiducial(){const e=this.video.CVdetectCircle();if(this.video.displayCvFrame(1e3),e){const[n,s]=e,i=this.video.canvas.width/2,o=this.video.canvas.height/2,l=n-i,r=-(s-o),h=.02,u=l*h,d=r*h;await this.serial.goToRelative(u.toFixed(1),d.toFixed(1))}}}let Un=new wt,Kn=new bt,k=new xt(Un),K=new Wn(k),X=new Zn(K,Kn);Bt(t=>{console.log("OpenCV loaded");const e=new Et(t);K.addVideoManager(e);const n=document.getElementById("opencv-canvas"),s=document.getElementById("camera-select"),i=document.getElementById("process-button");e.populateCameraList(s);let o=!1;const l=document.getElementById("importJob"),r=document.getElementById("jobFile"),h=document.getElementById("exportJob"),u=document.getElementById("jobDispenseDeg"),d=document.getElementById("jobRetractionDeg"),p=document.getElementById("jobDwellMs");u&&u.addEventListener("change",B=>{console.log("Dispense degrees changed:",B.target.value),X.dispenseDegrees=Number(B.target.value)}),d&&d.addEventListener("change",B=>{console.log("Retraction degrees changed:",B.target.value),X.retractionDegrees=Number(B.target.value)}),p&&p.addEventListener("change",B=>{console.log("Dwell milliseconds changed:",B.target.value),X.dwellMilliseconds=Number(B.target.value)}),l&&r?(l.addEventListener("click",()=>{r.click()}),r.addEventListener("change",async B=>{const j=B.target.files[0];if(j){console.log("Reading file:",j.name);try{const $=await X.importFromFile(j);$.success||(console.error("Failed to import job:",$.error),alert("Failed to import job file: "+$.error))}catch($){console.error("Error importing job:",$),alert("Error importing job file: "+$.message)}}})):console.error("Import button or file input not found");const E=document.getElementById("selectPasteGerber"),C=document.getElementById("selectMaskGerber"),m=document.getElementById("loadGerbers"),I=document.getElementById("pasteGerberFile"),R=document.getElementById("maskGerberFile"),O=document.getElementById("pasteGerberFilename"),_=document.getElementById("maskGerberFilename");E&&I&&(E.addEventListener("click",()=>{I.click()}),I.addEventListener("change",B=>{const j=B.target.files[0];j?O.textContent=j.name:O.textContent=""})),C&&R&&(C.addEventListener("click",()=>{R.click()}),R.addEventListener("change",B=>{const j=B.target.files[0];j?_.textContent=j.name:_.textContent=""})),m&&m.addEventListener("click",async()=>{if(!I.files[0]||!R.files[0]){alert("Please select both paste and mask gerber files first");return}try{await X.loadJobFromGerbers()}catch(B){console.error("Error loading gerbers:",B),alert("Error loading gerber files: "+B.message)}}),h&&h.addEventListener("click",async()=>{try{u&&(X.dispenseDegrees=Number(u.value)),d&&(X.retractionDegrees=Number(d.value)),p&&(X.dwellMilliseconds=Number(p.value)),await X.saveToFile()}catch(B){B.name!=="AbortError"&&(console.error("Error saving file:",B),alert("Error saving file: "+B.message))}}),n.addEventListener("click",B=>{const j=n.getBoundingClientRect(),$=B.clientX-j.left,Ee=B.clientY-j.top,D=n.width/j.width,Ie=n.height/j.height,Ce=$*D,ce=Ee*Ie,c=n.width/2,f=n.height/2,g=Ce-c,y=-(ce-f),w=.02,v=g*w,x=y*w;k.goToRelative(v.toFixed(1),x.toFixed(1))}),document.getElementById("connect").addEventListener("click",async()=>{const B=document.getElementById("connect");try{o||(await k.connect(),await e.startVideo(s.value,n),o=!0,B.textContent="Connected",B.classList.add("connected"),B.disabled=!0)}catch(j){alert("Error: "+j.message)}}),i.addEventListener("click",()=>{o&&K.jogToFiducial()}),document.getElementById("homing-fid-button").addEventListener("click",async()=>{await K.serial.goTo(218,196),await new Promise(B=>setTimeout(B,1e3)),await K.jogToFiducial(),await new Promise(B=>setTimeout(B,1500)),await K.jogToFiducial(),await new Promise(B=>setTimeout(B,1500)),K.serial.send(["G92 X218 Y196"])}),document.getElementById("nozzleOffsetCal").addEventListener("click",async()=>{await X.performTipCalibration()})});function Qn(){document.getElementById("repl-input").value=""}document.getElementById("repl-input").addEventListener("keyup",function(t){if(t.code==="Enter")t.preventDefault(),document.getElementById("send").click();else if(t.code==="ArrowUp"){if(t.preventDefault(),k.sentCommandBufferIndex==k.sentCommandBuffer.length-1)return!1;k.sentCommandBufferIndex++,document.getElementById("repl-input").value=k.sentCommandBuffer[k.sentCommandBufferIndex]}else if(t.code==="ArrowDown"){if(t.preventDefault(),k.sentCommandBufferIndex==0)return!1;k.sentCommandBufferIndex--,document.getElementById("repl-input").value=k.sentCommandBuffer[k.sentCommandBufferIndex]}});document.getElementById("send").addEventListener("click",()=>{k.sendRepl(),Qn()});function le(){let t=document.getElementById("jog-distance").value;return t=="1"?.1:t=="2"?1:t=="3"?10:t=="4"?100:1}document.getElementById("jog-yp").addEventListener("click",()=>{let t=le();k.send(["G91",`G0 Y${t}`,"G90"])});document.getElementById("jog-ym").addEventListener("click",()=>{let t=le();k.send(["G91",`G0 Y-${t}`,"G90"])});document.getElementById("jog-xp").addEventListener("click",()=>{let t=le();k.send(["G91",`G0 X${t}`,"G90"])});document.getElementById("jog-xm").addEventListener("click",()=>{let t=le();k.send(["G91",`G0 X-${t}`,"G90"])});document.getElementById("jog-zp").addEventListener("click",()=>{let t=le();k.send(["G91",`G0 Z${t}`,"G90"])});document.getElementById("jog-zm").addEventListener("click",()=>{let t=le();k.send(["G91",`G0 Z-${t}`,"G90"])});const Xe=document.getElementById("extrude-btn"),Ye=document.getElementById("retract-btn");Xe&&Xe.addEventListener("click",()=>{k.send(["G91","G0 B-2","G90"])});Ye&&Ye.addEventListener("click",()=>{k.send(["G91","G0 B2","G90"])});document.getElementById("left-air-on").addEventListener("click",()=>{k.send(["M106","M106 P1 S255"])});document.getElementById("left-air-off").addEventListener("click",()=>{k.send(["M107","M107 P1"])});document.getElementById("left-vac").addEventListener("click",()=>{k.readLeftVac()});document.getElementById("ring-lights-on").addEventListener("click",()=>{k.send(["M150 P255 R255 U255 B255"])});document.getElementById("ring-lights-off").addEventListener("click",()=>{k.send(["M150 P0"])});document.getElementById("disable-steppers").addEventListener("click",()=>{k.send(["M18"])});document.getElementById("home-x").addEventListener("click",()=>{k.send(["G28 X"])});document.getElementById("home-y").addEventListener("click",()=>{k.send(["G28 Y"])});document.getElementById("home-z").addEventListener("click",()=>{k.send(["G28 Z"])});document.getElementById("getRoughBoardPosition").addEventListener("click",async()=>{try{await X.findBoardRoughPosition()}catch(t){console.error("Error during capture:",t)}});document.getElementById("runJob").addEventListener("click",async()=>{try{await X.run()}catch(t){console.error("Error during run:",t)}});document.getElementById("performFidCal").addEventListener("click",async()=>{try{await X.performFiducialCalibration()}catch(t){console.error("Error during fid cal:",t)}});document.getElementById("captureNewPos").addEventListener("click",async()=>{try{await X.captureNewPosition()}catch(t){console.error("Error during pos capture:",t)}});
