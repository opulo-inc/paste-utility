var vt=Object.defineProperty;var yt=(t,e,n)=>e in t?vt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var ye=(t,e,n)=>yt(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();class wt{constructor(){ye(this,"timeout",async e=>new Promise(n=>setTimeout(n,e)));this.modalObject=document.getElementById("modal"),this.overlay=document.getElementById("overlay"),this.modalTitle=document.getElementById("modal-title"),this.modalContent=document.getElementById("modal-content"),this.modalNumInput=document.getElementById("modal-num-input"),this.modalClose=document.getElementById("modal-close"),this.modalOK=document.getElementById("modal-ok"),this.modalNG=document.getElementById("modal-ng"),this.receivedInput=void 0,this.setupEventListeners()}setupEventListeners(){this.modalClose.addEventListener("click",()=>{this.receivedInput=!1,this.hide()}),this.modalOK.addEventListener("keyup",e=>{e.code==="Enter"&&(e.preventDefault(),this.receivedInput=!0,this.hide())}),this.modalOK.addEventListener("click",()=>{this.receivedInput=!0,this.hide()}),this.modalNG.addEventListener("click",()=>{this.receivedInput=!1,this.hide()})}hide(){this.modalObject.style.display="none",this.overlay.style.display="none"}show(e,n,s){s===void 0&&(s=0),this.modalTitle.innerHTML=e,this.modalContent.innerHTML=n,this.modalObject.style.display="flex",this.overlay.style.display="block",s==0?this.modalNumInput.style.display="none":s==1&&(this.modalNumInput.style.display="block",this.modalNumInput.value=1),this.modalOK.focus();let i=this.waitForUserSelection();return i&&s==1&&(i=this.modalNumInput.value),i}async waitForUserSelection(){for(;this.receivedInput===void 0;)await this.timeout(50);let e=this.receivedInput;return this.receivedInput=void 0,e}}class bt{constructor(){ye(this,"timeout",async e=>new Promise(n=>setTimeout(n,e)));this.toastObject=document.getElementById("toast"),this.toastContent=document.getElementById("toast-content"),this.toastClose=document.getElementById("toast-close"),this.receivedInput=void 0,this.setupEventListeners()}setupEventListeners(){this.toastClose.addEventListener("click",()=>{this.receivedInput=!1})}hide(){this.toastObject.style.display="none"}async waitForUserSelection(){for(;this.receivedInput===void 0;)await this.timeout(50);let e=this.receivedInput;return this.receivedInput=void 0,this.hide(),e}show(e){return this.toastContent.innerHTML=e,this.toastObject.style.display="flex",this.waitForUserSelection()}}class Bt{constructor(e){ye(this,"delay",e=>new Promise(n=>setTimeout(n,e)));this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.consoleDiv=document.getElementById("console"),this.port,this.shouldListen=!0,this.modal=e,this.receiveBuffer=[],this.inspectBuffer=[],this.sentCommandBuffer=[""],this.sentCommandBufferIndex=0,this.okRespTimeout=!1,this.timeoutID=void 0,this.bootCommands=["G90","M260 A112 B1 S1","M260 A109","M260 B48","M260 B27","M260 S1","M260 A112 B2 S1","M260 A109","M260 B48","M260 B27","M260 S1","G0 F35000"]}async appendToConsole(e,n){let s=document.createElement("p"),i=new Date().toISOString(),o="";n?o="[SEND]":o="[RECE]",s.innerHTML=o+" - "+i+" - "+e+`
`,this.consoleDiv.appendChild(s),this.consoleDiv.scrollTop=this.consoleDiv.scrollHeight}clearBuffer(){for(;this.receiveBuffer.length>0;)this.receiveBuffer.shift()}clearInspectBuffer(){for(;this.inspectBuffer.length>0;)this.inspectBuffer.shift()}dec2bin(e){return(e>>>0).toString(2)}async connect(){if(!navigator.serial)return this.modal.show("Browser Support","Please use a browser that supports WebSerial, like Chrome, Opera, or Edge. <a href='https://developer.mozilla.org/en-US/docs/Web/API/Web_Serial_API#browser_compatibility'>Supported Browsers."),!1;const e=1155;return this.port=await navigator.serial.requestPort({filters:[{usbVendorId:e}]}),console.log("Port Selected."),await this.port.open({baudRate:115200,bufferSize:255,dataBits:8,flowControl:"none",parity:"none",stopBits:1}),console.log("Port Opened."),this.listen(),document.querySelector("#connect").style.background="green",document.querySelector("#connect").style.color="white",document.querySelector("#connect").innerHTML="Connected",this.send(this.bootCommands),this.send(["M150 P255 R255 U255 B255"]),!0}async listen(){var e;for(;(e=this.port)!=null&&e.readable&&this.shouldListen;){console.log("Port is readable: Starting to listen.");let n="";document.getElementById("console");const s=this.port.readable.getReader();try{for(;this.shouldListen;){const{value:i,done:o}=await s.read();if(o){console.log("Closing reader.");break}const a=this.decoder.decode(i);for(n=n.concat(a);n.indexOf(`
`)!=-1;){let r=n.split(`
`);this.receiveBuffer.push(r[0]),this.appendToConsole(r[0],!1),this.inspectBuffer.push(r[0]),n=n.split(`
`).slice(1).join(`
`)}}}catch(i){console.error("Reading error.",i)}finally{s.releaseLock()}}}sleep(e){for(var n=new Date().getTime(),s=0;s<1e7&&!(new Date().getTime()-n>e);s++);}async setOkRespTimeout(){new Promise(e=>{this.timeoutID=setTimeout(()=>{console.log("timeout triggered"),this.okRespTimeout=!0,e()},5e3)})}async send(e){var n;if(console.log("sending: ",e),(n=this.port)!=null&&n.writable){const s=await this.port.writable.getWriter();try{for(const i of e){for(await s.write(this.encoder.encode(i+`
`)),this.setOkRespTimeout(),this.appendToConsole(i,!0),this.clearBuffer();!this.okRespTimeout;){let o=this.receiveBuffer.shift();if(o=="ok"){clearTimeout(this.timeoutID);break}(o="echo:busy: processing")&&(clearTimeout(this.timeoutID),this.setOkRespTimeout()),await new Promise(a=>setTimeout(a,50))}this.okRespTimeout=!1}}finally{s.releaseLock()}}else this.modal.show("Cannot Write","Cannot write to port. Have you connected?")}async sendRepl(){let e=[document.querySelector("#repl-input").value];this.sentCommandBuffer.splice(1,0,e[0]),this.sentCommandBufferIndex=0,this.send(e)}async leftAirOn(){const e=["M106","M106 P1 S255"];await this.send(e)}async leftAirOff(){const e=["M107","M107 P1"];await this.send(e)}async rightAirOn(){const e=["M106 P2 S255","M106 P3 S255"];await this.send(e)}async rightAirOff(){const e=["M107 P2","M107 P3"];await this.send(e)}async ledOn(){const e=["M150 P255 R255 U255 B255"];await this.send(e)}async ledOff(){const e=["M150 P0"];await this.send(e)}async disableSteppers(){const e=["M18"];await this.send(e)}async readLeftVac(){var u;if(!((u=this.port)!=null&&u.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;const e=["M260 A112 B1 S1"],n=50;this.clearInspectBuffer();let s,i,o;const a=new RegExp("data:(..)");await this.send(e),this.clearInspectBuffer(),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var r=0,h=this.inspectBuffer.length;r<h;r++){let p=this.inspectBuffer[r];if(console.log(this.inspectBuffer),a.test(p)){s=p.match("data:(..)")[1];break}}this.clearInspectBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var r=0,h=this.inspectBuffer.length;r<h;r++){let x=this.inspectBuffer[r];if(a.test(x)){i=x.match("data:(..)")[1];break}}this.clearInspectBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var r=0,h=this.inspectBuffer.length;r<h;r++){let x=this.inspectBuffer[r];if(a.test(x)){o=x.match("data:(..)")[1];break}}console.log(s,i,o);let d=parseInt(s+i+o,16);d&1<<23&&(d=d-2**24),await this.modal.show("Left Vacuum Sensor Value",d),this.clearInspectBuffer()}async readRightVac(){var u;if(!((u=this.port)!=null&&u.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;const e=["M260 A112 B2 S1"];let n,s,i;const o=new RegExp("data:(..)"),a=50;this.clearInspectBuffer(),await this.send(e),await this.delay(a),this.clearInspectBuffer(),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(a);for(var r=0,h=this.inspectBuffer.length;r<h;r++){let p=this.inspectBuffer[r];if(o.test(p)){n=p.match("data:(..)")[1];break}}this.clearInspectBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(a);for(var r=0,h=this.inspectBuffer.length;r<h;r++){let x=this.inspectBuffer[r];if(o.test(x)){s=x.match("data:(..)")[1];break}}this.clearInspectBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(a);for(var r=0,h=this.inspectBuffer.length;r<h;r++){let x=this.inspectBuffer[r];if(o.test(x)){i=x.match("data:(..)")[1];break}}let d=parseInt(n+s+i,16);d&1<<23&&(d=d-2**24),await this.modal.show("Right Vacuum Sensor Value",d),this.clearInspectBuffer()}async testTMC(){var i;if(!((i=this.port)!=null&&i.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;let e="";const n=["M122"];await this.clearBuffer(),await this.send(n),await this.delay(5e3),console.log(this.receiveBuffer);for(let o=0;o<this.receiveBuffer.length;o++)e=e.concat(this.receiveBuffer[o]+`
`);if(await this.modal.show("Stepper Driver Test Complete","Test is complete. Click OK to download test report.")==!0){let o=new Date().toISOString();o=o+"-tmctest.txt",this.download(o,e)}}async testVac(){var m;if(!((m=this.port)!=null&&m.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;let e="";const n=["M260 A112 B1 S1","M260 A109","M260 B48","M260 B10","M260 S1"],s=["M260 A112 B2 S1","M260 A109","M260 B48","M260 B10","M260 S1"],i=100;this.clearBuffer();let o,a,r;const h=new RegExp("data:(..)");await this.send(n),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var d=0,u=this.receiveBuffer.length;d<u;d++){let C=this.receiveBuffer[d];if(h.test(C)){o=C.match("data:(..)")[1],e=e.concat("Left MSB - "+o+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var d=0,u=this.receiveBuffer.length;d<u;d++){let R=this.receiveBuffer[d];if(h.test(R)){a=R.match("data:(..)")[1],e=e.concat("Left CSB - "+a+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var d=0,u=this.receiveBuffer.length;d<u;d++){let R=this.receiveBuffer[d];if(h.test(R)){r=R.match("data:(..)")[1],e=e.concat("Left LSB - "+r+`
`);break}}let p=parseInt(o+a+r,16);p&1<<23&&(p=p-2**24),e=e.concat("Left Val - "+p+`
`),this.clearBuffer(),await this.send(s),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var d=0,u=this.receiveBuffer.length;d<u;d++){let R=this.receiveBuffer[d];if(h.test(R)){o=R.match("data:(..)")[1],e=e.concat("Right MSB - "+o+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var d=0,u=this.receiveBuffer.length;d<u;d++){let R=this.receiveBuffer[d];if(h.test(R)){a=R.match("data:(..)")[1],e=e.concat("Right CSB - "+a+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i),console.log("current buffer length: ",this.receiveBuffer.length);for(var d=0,u=this.receiveBuffer.length;d<u;d++){let R=this.receiveBuffer[d];if(h.test(R)){r=R.match("data:(..)")[1],e=e.concat("Right LSB - "+r+`
`);break}}let E=parseInt(o+a+r,16);if(E&1<<23&&(E=E-2**24),e=e.concat("Right Val - "+E+`
`),console.log(p,E),await this.modal.show("Vacuum Sensor Test Complete","Test is complete. Click OK to download test report.")==!0){let C=new Date().toISOString();C=C+"-vactest.txt",this.download(C,e)}}download(e,n){var s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(n)),s.setAttribute("download",e),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)}async goToRelative(e,n){await this.send(["G91",`G0 X${e} Y${n}`,"G90"])}async goTo(e,n){await this.send([`G0 X${e} Y${n}`])}}function Et(t){window.cv?window.cv.then(e=>t(e)):window.onOpenCVReady=()=>{window.cv.then(e=>t(e))}}class xt{constructor(e){this.cv=e,this.video=null,this.canvas=null,this.frame=null,this.cvFrame=null,this.displayCv=!1,this.cvDisplayTimer=null}async populateCameraList(e){try{const s=(await navigator.mediaDevices.enumerateDevices()).filter(i=>i.kind==="videoinput");e.innerHTML="",s.forEach(i=>{const o=document.createElement("option");o.value=i.deviceId,o.text=i.label||`Camera ${s.indexOf(i)+1}`,e.appendChild(o),i.label&&i.label.toLowerCase().includes("top")&&(e.value=i.deviceId)})}catch(n){console.error("Error populating camera list:",n)}}async startVideo(e,n){const s=await navigator.mediaDevices.getUserMedia({video:{deviceId:e?{exact:e}:void 0}});this.video=document.createElement("video"),this.video.srcObject=s,this.video.setAttribute("playsinline",!0),this.canvas=n,await new Promise(i=>{this.video.onloadedmetadata=()=>{this.canvas.width=this.video.videoWidth,this.canvas.height=this.video.videoHeight,i()}}),await this.video.play(),this.frame=new this.cv.Mat(this.video.videoHeight,this.video.videoWidth,this.cv.CV_8UC4),this.videoTick()}addReticle(e){const n=e.cols/2,s=e.rows/2,i=20,o=new this.cv.Scalar(255,200,0,255),a=3;let r=e.clone();return this.cv.line(r,new this.cv.Point(n-i,s),new this.cv.Point(n+i,s),o,a),this.cv.line(r,new this.cv.Point(n,s-i),new this.cv.Point(n,s+i),o,a),r}showFrame(e){this.cv.imshow(this.canvas,e)}CVdetectCircle(){try{this.cvFrame=this.frame.clone();let e=new this.cv.Mat;this.cv.cvtColor(this.cvFrame,e,this.cv.COLOR_RGBA2GRAY),this.cv.GaussianBlur(e,e,new this.cv.Size(9,9),2,2);let n=new this.cv.Mat;this.cv.HoughCircles(e,n,this.cv.HOUGH_GRADIENT,1,e.rows/8,50,30,1,50);let s=null;if(n.cols>0){console.log(n.cols);for(let i=0;i<n.cols;i++){const o=n.data32F[i*3+0],a=n.data32F[i*3+1],r=n.data32F[i*3+2];if(s===null)s=[o,a,r];else{let h=this.cvFrame.cols/2,d=this.cvFrame.cols/2,u=o-h,p=a-d,E=Math.sqrt(u*u+p*p),x=s[0]-h,m=s[1]-d,C=Math.sqrt(x*x+m*m);E<C&&(s=[o,a,r])}console.log("Circle %d, %d, rad %d",o,a,r),console.log(this.cvFrame.cols,this.cvFrame.rows),this.cv.circle(this.cvFrame,new this.cv.Point(o,a),3,new this.cv.Scalar(0,255,0,255),-1),this.cv.circle(this.cvFrame,new this.cv.Point(o,a),r,new this.cv.Scalar(255,0,0,255),3)}}return console.log("Best circle: ",s),e.delete(),n.delete(),this.addReticle(this.cvFrame),s}catch(e){return console.error("Error in detectCircle:",e),null}}loadNewFrame(){const e=this.canvas.getContext("2d");e.drawImage(this.video,0,0,this.video.videoWidth,this.video.videoHeight);const n=e.getImageData(0,0,this.video.videoWidth,this.video.videoHeight),s=this.cv.matFromImageData(n);s.copyTo(this.frame),s.delete(),this.cv.flip(this.frame,this.frame,-1)}videoTick(){this.displayCv?this.showFrame(this.cvFrame):(this.loadNewFrame(),this.frame=this.addReticle(this.frame),this.showFrame(this.frame)),requestAnimationFrame(()=>this.videoTick())}displayCvFrame(e){this.displayCv=!0,this.processTimer&&clearTimeout(this.processTimer),this.processTimer=setTimeout(()=>{this.displayCv=!1,this.needsCv=!1,this.cvFrame&&(this.cvFrame.delete(),this.cvFrame=null),this.processTimer=null},e)}stopVideo(e){this.isProcessing=!1,this.processTimer&&(clearTimeout(this.processTimer),this.processTimer=null),this.processedFrame&&(this.processedFrame.delete(),this.processedFrame=null),this.video&&this.video.srcObject&&(this.video.srcObject.getTracks().forEach(s=>s.stop()),this.video.remove(),this.video=null),this.src&&(this.src.delete(),this.src=null),this.dst&&(this.dst.delete(),this.dst=null),e.getContext("2d").clearRect(0,0,e.width,e.height),console.log("Video stopped and cleaned up")}}var It=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Te={},Ct={get exports(){return Te},set exports(t){Te=t}};(function(t){(function(e,n){t.exports?t.exports=n():e.moo=n()})(It,function(){var e=Object.prototype.hasOwnProperty,n=Object.prototype.toString,s=typeof new RegExp().sticky=="boolean";function i(c){return c&&n.call(c)==="[object RegExp]"}function o(c){return c&&typeof c=="object"&&!i(c)&&!Array.isArray(c)}function a(c){return c.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function r(c){var f=new RegExp("|"+c);return f.exec("").length-1}function h(c){return"("+c+")"}function d(c){if(!c.length)return"(?!)";var f=c.map(function(g){return"(?:"+g+")"}).join("|");return"(?:"+f+")"}function u(c){if(typeof c=="string")return"(?:"+a(c)+")";if(i(c)){if(c.ignoreCase)throw new Error("RegExp /i flag not allowed");if(c.global)throw new Error("RegExp /g flag is implied");if(c.sticky)throw new Error("RegExp /y flag is implied");if(c.multiline)throw new Error("RegExp /m flag is implied");return c.source}else throw new Error("Not a pattern: "+c)}function p(c,f){return c.length>f?c:Array(f-c.length+1).join(" ")+c}function E(c,f){for(var g=c.length,v=0;;){var b=c.lastIndexOf(`
`,g-1);if(b===-1||(v++,g=b,v===f)||g===0)break}var y=v<f?0:g+1;return c.substring(y).split(`
`)}function x(c){for(var f=Object.getOwnPropertyNames(c),g=[],v=0;v<f.length;v++){var b=f[v],y=c[b],I=[].concat(y);if(b==="include"){for(var F=0;F<I.length;F++)g.push({include:I[F]});continue}var M=[];I.forEach(function(w){o(w)?(M.length&&g.push(C(b,M)),g.push(C(b,w)),M=[]):M.push(w)}),M.length&&g.push(C(b,M))}return g}function m(c){for(var f=[],g=0;g<c.length;g++){var v=c[g];if(v.include){for(var b=[].concat(v.include),y=0;y<b.length;y++)f.push({include:b[y]});continue}if(!v.type)throw new Error("Rule has no type: "+JSON.stringify(v));f.push(C(v.type,v))}return f}function C(c,f){if(o(f)||(f={match:f}),f.include)throw new Error("Matching rules cannot also include states");var g={defaultType:c,lineBreaks:!!f.error||!!f.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var v in f)e.call(f,v)&&(g[v]=f[v]);if(typeof g.type=="string"&&c!==g.type)throw new Error("Type transform cannot be a string (type '"+g.type+"' for token '"+c+"')");var b=g.match;return g.match=Array.isArray(b)?b:b?[b]:[],g.match.sort(function(y,I){return i(y)&&i(I)?0:i(I)?-1:i(y)?1:I.length-y.length}),g}function A(c){return Array.isArray(c)?m(c):x(c)}var R=C("error",{lineBreaks:!0,shouldThrow:!0});function X(c,f){for(var g=null,v=Object.create(null),b=!0,y=null,I=[],F=[],M=0;M<c.length;M++)c[M].fallback&&(b=!1);for(var M=0;M<c.length;M++){var w=c[M];if(w.include)throw new Error("Inheritance is not allowed in stateless lexers");if(w.error||w.fallback){if(g)throw!w.fallback==!g.fallback?new Error("Multiple "+(w.fallback?"fallback":"error")+" rules not allowed (for token '"+w.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+w.defaultType+"')");g=w}var j=w.match.slice();if(b)for(;j.length&&typeof j[0]=="string"&&j[0].length===1;){var ie=j.shift();v[ie.charCodeAt(0)]=w}if(w.pop||w.push||w.next){if(!f)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+w.defaultType+"')");if(w.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+w.defaultType+"')")}if(j.length!==0){b=!1,I.push(w);for(var _=0;_<j.length;_++){var W=j[_];if(i(W)){if(y===null)y=W.unicode;else if(y!==W.unicode&&w.fallback===!1)throw new Error("If one rule is /u then all must be")}}var oe=d(j.map(u)),Y=new RegExp(oe);if(Y.test(""))throw new Error("RegExp matches empty string: "+Y);var de=r(oe);if(de>0)throw new Error("RegExp has capture groups: "+Y+`
Use (?: â€¦ ) instead`);if(!w.lineBreaks&&Y.test(`
`))throw new Error("Rule should declare lineBreaks: "+Y);F.push(h(oe))}}var re=g&&g.fallback,he=s&&!re?"ym":"gm",ve=s||re?"":"|";y===!0&&(he+="u");var gt=new RegExp(d(F)+ve,he);return{regexp:gt,groups:I,fast:v,error:g||R}}function se(c){var f=X(A(c));return new k({start:f},"start")}function ce(c,f,g){var v=c&&(c.push||c.next);if(v&&!g[v])throw new Error("Missing state '"+v+"' (in token '"+c.defaultType+"' of state '"+f+"')");if(c&&c.pop&&+c.pop!=1)throw new Error("pop must be 1 (in token '"+c.defaultType+"' of state '"+f+"')")}function ge(c,f){var g=c.$all?A(c.$all):[];delete c.$all;var v=Object.getOwnPropertyNames(c);f||(f=v[0]);for(var b=Object.create(null),y=0;y<v.length;y++){var I=v[y];b[I]=A(c[I]).concat(g)}for(var y=0;y<v.length;y++)for(var I=v[y],F=b[I],M=Object.create(null),w=0;w<F.length;w++){var j=F[w];if(j.include){var ie=[w,1];if(j.include!==I&&!M[j.include]){M[j.include]=!0;var _=b[j.include];if(!_)throw new Error("Cannot include nonexistent state '"+j.include+"' (in state '"+I+"')");for(var W=0;W<_.length;W++){var oe=_[W];F.indexOf(oe)===-1&&ie.push(oe)}}F.splice.apply(F,ie),w--}}for(var Y=Object.create(null),y=0;y<v.length;y++){var I=v[y];Y[I]=X(b[I],!0)}for(var y=0;y<v.length;y++){for(var de=v[y],re=Y[de],he=re.groups,w=0;w<he.length;w++)ce(he[w],de,Y);for(var ve=Object.getOwnPropertyNames(re.fast),w=0;w<ve.length;w++)ce(re.fast[ve[w]],de,Y)}return new k(Y,f)}function B(c){for(var f=typeof Map<"u",g=f?new Map:Object.create(null),v=Object.getOwnPropertyNames(c),b=0;b<v.length;b++){var y=v[b],I=c[y],F=Array.isArray(I)?I:[I];F.forEach(function(M){if(typeof M!="string")throw new Error("keyword must be string (in keyword '"+y+"')");f?g.set(M,y):g[M]=y})}return function(M){return f?g.get(M):g[M]}}var k=function(c,f){this.startState=f,this.states=c,this.buffer="",this.stack=[],this.reset()};k.prototype.reset=function(c,f){return this.buffer=c||"",this.index=0,this.line=f?f.line:1,this.col=f?f.col:1,this.queuedToken=f?f.queuedToken:null,this.queuedText=f?f.queuedText:"",this.queuedThrow=f?f.queuedThrow:null,this.setState(f?f.state:this.startState),this.stack=f&&f.stack?f.stack.slice():[],this},k.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedText:this.queuedText,queuedThrow:this.queuedThrow}},k.prototype.setState=function(c){if(!(!c||this.state===c)){this.state=c;var f=this.states[c];this.groups=f.groups,this.error=f.error,this.re=f.regexp,this.fast=f.fast}},k.prototype.popState=function(){this.setState(this.stack.pop())},k.prototype.pushState=function(c){this.stack.push(this.state),this.setState(c)};var $=s?function(c,f){return c.exec(f)}:function(c,f){var g=c.exec(f);return g[0].length===0?null:g};k.prototype._getGroup=function(c){for(var f=this.groups.length,g=0;g<f;g++)if(c[g+1]!==void 0)return this.groups[g];throw new Error("Cannot find token type for matched text")};function Ce(){return this.value}if(k.prototype.next=function(){var c=this.index;if(this.queuedGroup){var f=this._token(this.queuedGroup,this.queuedText,c);return this.queuedGroup=null,this.queuedText="",f}var g=this.buffer;if(c!==g.length){var I=this.fast[g.charCodeAt(c)];if(I)return this._token(I,g.charAt(c),c);var v=this.re;v.lastIndex=c;var b=$(v,g),y=this.error;if(b==null)return this._token(y,g.slice(c,g.length),c);var I=this._getGroup(b),F=b[0];return y.fallback&&b.index!==c?(this.queuedGroup=I,this.queuedText=F,this._token(y,g.slice(c,b.index),c)):this._token(I,F,c)}},k.prototype._token=function(c,f,g){var v=0;if(c.lineBreaks){var b=/\n/g,y=1;if(f===`
`)v=1;else for(;b.exec(f);)v++,y=b.lastIndex}var I={type:typeof c.type=="function"&&c.type(f)||c.defaultType,value:typeof c.value=="function"?c.value(f):f,text:f,toString:Ce,offset:g,lineBreaks:v,line:this.line,col:this.col},F=f.length;if(this.index+=F,this.line+=v,v!==0?this.col=F-y+1:this.col+=F,c.shouldThrow){var M=new Error(this.formatError(I,"invalid syntax"));throw M}return c.pop?this.popState():c.push?this.pushState(c.push):c.next&&this.setState(c.next),I},typeof Symbol<"u"&&Symbol.iterator){var ue=function(c){this.lexer=c};ue.prototype.next=function(){var c=this.lexer.next();return{value:c,done:!c}},ue.prototype[Symbol.iterator]=function(){return this},k.prototype[Symbol.iterator]=function(){return new ue(this)}}return k.prototype.formatError=function(v,f){if(v==null)var g=this.buffer.slice(this.index),v={text:g,offset:this.index,lineBreaks:g.indexOf(`
`)===-1?0:1,line:this.line,col:this.col};var b=2,y=Math.max(v.line-b,1),I=v.line+b,F=String(I).length,M=E(this.buffer,this.line-v.line+b+1).slice(0,5),w=[];w.push(f+" at line "+v.line+" col "+v.col+":"),w.push("");for(var j=0;j<M.length;j++){var ie=M[j],_=y+j;w.push(p(String(_),F)+"  "+ie),_===v.line&&w.push(p("",F+v.col+1)+"^")}return w.join(`
`)},k.prototype.clone=function(){return new k(this.states,this.state)},k.prototype.has=function(c){return!0},{compile:se,states:ge,error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:B}})})(Ct);const $e=Te,fe="T_CODE",S="G_CODE",Z="M_CODE",z="D_CODE",G="ASTERISK",D="PERCENT",_e="EQUALS",ae="COMMA",K="OPERATOR",Se="GERBER_FORMAT",be="GERBER_UNITS",ze="GERBER_TOOL_MACRO",qe="GERBER_TOOL_DEF",Ve="GERBER_LOAD_POLARITY",He="GERBER_STEP_REPEAT",pe="GERBER_MACRO_VARIABLE",Je="SEMICOLON",Ze="DRILL_UNITS",Pe="DRILL_ZERO_INCLUSION",O="COORD_CHAR",N="NUMBER",kt="WORD",Mt="WHITESPACE",q="NEWLINE",Tt="CATCHALL",St="ERROR",Pt=/^0*/,We=t=>t.replace(Pt,""),we=t=>We(t.slice(1))||"0",Ft={[fe]:{match:/T\d+/,value:we},[S]:{match:/G\d+/,value:we},[Z]:{match:/M\d+/,value:we},[z]:{match:/D\d+/,value:we},[G]:"*",[D]:"%",[_e]:"=",[Se]:{match:/FS[LTDAI]+/,value:t=>t.slice(2)},[be]:{match:/MO(?:IN|MM)/,value:t=>t.slice(2)},[ze]:{match:/AM[a-zA-Z_.$][\w.-]*/,value:t=>t.slice(2)},[qe]:{match:/ADD\d+[a-zA-Z_.$][\w.-]*/,value:t=>We(t.slice(3))},[Ve]:{match:/LP[DC]/,value:t=>t.slice(2)},[He]:"SR",[pe]:/\$\d+/,[Je]:";",[Ze]:/^(?:METRIC|INCH)/,[Pe]:{match:/,(?:TZ|LZ)/,value:t=>t.slice(1)},[O]:/[XYIJACFSBHZN]/,[N]:/[+-]?[\d.]+/,[K]:["x","/","+","-","(",")"],[ae]:",",[kt]:/[a-zA-Z]+/,[Mt]:/[ \t]+/,[q]:{match:/\r?\n/,lineBreaks:!0},[Tt]:/\S/,[St]:$e.error};function Gt(){const t=$e.compile(Ft);return{feed:e};function e(s,i=null){return t.reset(s,i??void 0),n((i==null?void 0:i.offset)??0)}function n(s){return{[Symbol.iterator](){return this},next(){const i=t.next();if(i){const o={...i,offset:s+i.offset},a={...t.save(),offset:s+(t.index??0)};return{value:[o,a]}}return{value:void 0,done:!0}}}}}const Ue="gerber",Fe="drill",Ge="mm",Le="in",Ke="leading",Qe="trailing",Lt="absolute",Rt="incremental",Re="circle",et="rectangle",Ot="obround",Nt="polygon",At="macroShape",jt="shape",tt="move",Dt="segment",Xt="slot",Yt="line",$t="cwArc",_t="ccwArc",zt="single",qt="multi",Vt="dark",Ht="clear",Be="TOKEN",J="MIN_TO_MAX";function l(t,e){return{rule:Be,type:t,value:e}}function ee(t,e){return{rule:Be,type:t,value:e,negate:!0}}function H(t){return{rule:J,min:1,max:1,match:t}}function me(t){return{rule:J,min:0,max:1,match:t}}function V(t){return{rule:J,min:0,max:Number.POSITIVE_INFINITY,match:t}}function nt(t){return{rule:J,min:1,max:Number.POSITIVE_INFINITY,match:t}}function te(t,e,n){return{rule:J,min:t,max:e,match:n}}function st(t,e){const n=[];for(const s of e){const i=Zt(t,s.rules);if(i===ot)n.push(s);else if(i===it)return{filetype:s.filetype,nodes:s.createNodes(t)}}return n.length>0?{candidates:n,tokens:t}:{}}const it="FULL_MATCH",ot="PARTIAL_MATCH",Jt="NO_MATCH";function Zt(t,e){let n=0,s=0,i=0;for(;n<e.length&&s<t.length;){const o=e[n],a=t[s];if(rt(o,a))o.rule===Be||o.rule===J&&i>=o.max-1?(n++,s++,i=0):o.rule===J&&(s++,i++);else if(o.rule===J&&i>=o.min)i=0,n++;else return Jt}return n<e.length?ot:it}function rt(t,e){if(t.rule===Be){const n=t.type===e.type,s=t.value===null||typeof t.value>"u"||typeof t.value=="string"&&t.value===e.value||t.value instanceof RegExp&&t.value.test(e.value),i=n&&s;return t.negate?!i:i}return Array.isArray(t.match)?t.match.some(n=>rt(n,e)):!1}const Wt="root",at="comment",Ut="drillHeader",lt="done",Oe="units",ct="coordinateFormat",ut="toolDefinition",Kt="toolMacro",Ne="toolChange",Qt="loadPolarity",en="stepRepeat",Ae="graphic",Ee="interpolateMode",tn="regionMode",nn="quadrantMode",sn="unimplemented",on="macroComment",rn="macroVariable",an="macroPrimitive";function ne(t){return Object.fromEntries(t.map((e,n)=>[e,t[n-1]]).filter(([e,n])=>e.type===N&&(n==null?void 0:n.type)===O).map(([e,n])=>[n.value.toLowerCase(),e.value]))}function xe(t){return t.filter(e=>e.type===S).map(e=>e.value==="0"?tt:e.value==="1"?Yt:e.value==="2"?$t:e.value==="3"?_t:e.value==="5"?Fe:null)[0]??null}function ln(t){return t.filter(e=>e.type===z).map(e=>e.value==="1"?Dt:e.value==="2"?tt:e.value==="3"?jt:null)[0]??null}function je(t){return t.map(e=>e.value).join("").trim()}function P(t,e={}){const{head:n=t[0],length:s=0}=e,i=s>0?t[t.indexOf(n)+s-1]:t[t.length-1];return{start:{line:n.line,column:n.col,offset:n.offset},end:{line:i.line,column:i.col,offset:i.offset}}}const cn={name:"units",rules:[H([l(Ze),l(Z,"71"),l(Z,"72")]),V([l(ae),l(Pe),l(N,/^0{1,8}\.0{1,8}$/)]),l(q)],createNodes(t){const e=t[0].value==="INCH"||t[0].value==="72"?Le:Ge,n=t.filter(o=>o.type===Pe).map(o=>o.value==="LZ"?Qe:o.value==="TZ"?Ke:null),s=t.filter(o=>o.type===N).map(o=>{const[a="",r=""]=o.value.split(".");return[a.length,r.length]}),i=[{type:Oe,position:P(t.slice(0,2)),units:e}];return(n.length>0||s.length>0)&&i.push({type:ct,position:P(t.slice(1)),mode:null,format:s[0]??null,zeroSuppression:n[0]??null}),i}},un={name:"tool",rules:[l(fe),te(0,12,[l(O,"C"),l(O,"F"),l(O,"S"),l(O,"B"),l(O,"H"),l(O,"Z"),l(N)]),l(q)],createNodes(t){const e=t[0].value,n=P(t),{c:s=null}=ne(t.slice(1,-1)),i=s===null?null:{type:Re,diameter:Number(s)};return i?[{type:ut,hole:null,position:n,shape:i,code:e}]:[{type:Ne,position:n,code:e}]}},dn={name:"operationMode",rules:[H([l(S,"0"),l(S,"1"),l(S,"2"),l(S,"3"),l(S,"5")]),l(q)],createNodes:t=>[{type:Ee,position:P(t),mode:xe(t)}]},hn={name:"operation",rules:[te(0,2,[l(fe),l(S,"0"),l(S,"1"),l(S,"2"),l(S,"3"),l(S,"5")]),te(2,8,[l(O),l(N)]),me([l(fe)]),l(q)],createNodes(t){const e=t.filter(p=>p.type===O||p.type===N),n=t.find(p=>p.type===S),s=t.find(p=>p.type===fe),i=ne(e),o=s?s.value:null,a=xe(t),r=P(t,{head:e[0],length:e.length+1}),h=P(t,{head:n,length:2}),d=P(t,{head:s,length:2}),u=[{type:Ae,position:r,graphic:null,coordinates:i}];return a&&u.unshift({type:Ee,position:h,mode:a}),o&&u.unshift({type:Ne,position:d,code:o}),u}},fn={name:"slot",rules:[te(2,4,[l(O),l(N)]),l(S,"85"),te(2,4,[l(O),l(N)]),l(q)],createNodes(t){const e=t.find(o=>o.type===S),n=e?t.indexOf(e):-1,s=Object.fromEntries(Object.entries(ne(t.slice(0,n))).map(([o,a])=>[`${o}0`,a])),i=ne(t.slice(n));return[{type:Ae,position:P(t),graphic:Xt,coordinates:{...s,...i}}]}},pn={name:"done",rules:[H([l(Z,"30"),l(Z,"0")]),l(q)],createNodes:t=>[{type:lt,position:P(t)}]},mn={name:"header",rules:[H([l(Z,"48"),l(D)]),l(q)],createNodes:t=>[{type:Ut,position:P(t)}]},gn={name:"comment",rules:[l(Je),V([ee(q)]),l(q)],createNodes:t=>[{type:at,comment:je(t.slice(1,-1)),position:P(t)}]},dt=[un,dn,hn,fn,gn,cn,pn,mn].map(t=>({...t,filetype:Fe})),vn={name:"macroComment",rules:[l(N,"0"),V([ee(G)]),l(G)],createNodes:bn},yn={name:"macroVariable",rules:[l(pe),l(_e),nt([l(N),l(K),l(pe),l(O,"X")]),l(G)],createNodes:En},wn={name:"macroPrimitive",rules:[l(N),l(ae),nt([l(ae),l(N),l(K),l(pe),l(O,"X")]),l(G)],createNodes:Bn};function bn(t){const e=t.slice(1,-1).map(n=>n.text).join("").trim();return[{type:on,position:P(t),comment:e}]}function Bn(t){const e=t[0].value,n=[[]];let s=n[0];for(const o of t.slice(2,-1))o.type===ae?(s=[],n.push(s)):s.push(o);const i=n.map(o=>ht(o));return[{type:an,position:P(t),code:e,parameters:i}]}function En(t){const e=t[0].value,n=ht(t.slice(2,-1));return[{type:rn,position:P(t),name:e,value:n}]}function ht(t){const e=t.map(a=>a.type===O?{...a,type:K,value:"x"}:a);return o();function n(){return e[0]??null}function s(){const a=e.shift();if(a.type===N)return Number(a.value);if(a.type===pe)return a.value;const r=o();return e.shift(),r}function i(){let a=s(),r=n();for(;(r==null?void 0:r.type)===K&&(r.value==="x"||r.value==="/");)e.shift(),a={left:a,right:s(),operator:r.value},r=n();return a}function o(){let a=i(),r=n();for(;(r==null?void 0:r.type)===K&&(r.value==="+"||r.value==="-")||(r==null?void 0:r.type)===N;){let h="+";r.type===K&&(e.shift(),h=r.value);const d=i();a={left:a,right:d,operator:h},r=n()}return a}}const De=[wn,yn,vn];function xn(t){let e=De,n=[];const s=[];for(const i of t){const o=st([...n,i],e);o.nodes&&s.push(...o.nodes),n=o.tokens??[],e=o.candidates??De}return s}const ke=t=>{if(t.length===1){const[e]=t;return{type:Re,diameter:e}}if(t.length===2){const[e,n]=t;return{type:et,xSize:e,ySize:n}}return null},In={name:"done",rules:[H([l(Z,"0"),l(Z,"2")]),l(G)],createNodes:t=>[{type:lt,position:P(t)}]},Cn={name:"comment",rules:[l(S,"4"),V([ee(G)]),l(G)],createNodes:t=>[{type:at,position:P(t),comment:je(t.slice(1,-1))}]},kn={name:"format",rules:[l(D),l(Se),V([ee(O,"X")]),l(O,"X"),l(N),l(O,"Y"),l(N),V([ee(G)]),l(G),te(0,2,[l(be),l(G)]),l(D)],createNodes(t){var e;let n=null,s=null,i=null;const o=ne(t),a=t.findIndex(d=>d.type===G),r=t.find(d=>d.type===be);for(const d of t.filter(u=>u.type===Se))d.value.includes("T")&&(s=Qe),d.value.includes("L")&&(s=Ke),d.value.includes("I")&&(i=Rt),d.value.includes("A")&&(i=Lt);if(o.x===o.y&&((e=o.x)==null?void 0:e.length)===2){const d=Number(o.x[0]),u=Number(o.x[1]);d&&u&&(n=[d,u])}const h=[{type:ct,position:P(t.slice(1,a+1)),zeroSuppression:s,format:n,mode:i}];return r&&h.push({type:Oe,position:P(t.slice(1,-1),{head:r}),units:r.value==="MM"?Ge:Le}),h}},Mn={name:"units",rules:[l(D),l(be),l(G),l(D)],createNodes:t=>[{type:Oe,position:P(t.slice(1,-1)),units:t[1].value==="MM"?Ge:Le}]},Tn={name:"toolMacro",rules:[l(D),l(ze),l(G),V([ee(D)]),l(D)],createNodes(t){const e=t[1].value,n=P(t.slice(1,-1)),s=t.slice(3,-1);return[{type:Kt,position:n,children:xn(s),name:e}]}},Sn={name:"toolDefinition",rules:[l(D),l(qe),V([l(ae),l(N),l(O,"X")]),l(G),l(D)],createNodes(t){let e,n=null;const s=/(\d+)(.+)/.exec(t[1].value),[,i="",o=""]=s??[],a=t.slice(3,-2).filter(r=>r.type===N).map(r=>Number(r.value));switch(o){case"C":{const[r,...h]=a;e={type:Re,diameter:r},n=ke(h);break}case"R":case"O":{const[r,h,...d]=a;e={type:o==="R"?et:Ot,xSize:r,ySize:h},n=ke(d);break}case"P":{const[r,h,d=null,...u]=a;e={type:Nt,diameter:r,vertices:h,rotation:d},n=ke(u);break}default:e={type:At,name:o,variableValues:a}}return[{type:ut,position:P(t.slice(1,-1)),code:i,shape:e,hole:n}]}},Pn={name:"toolChange",rules:[me([l(S,"54")]),l(z),l(G)],createNodes:t=>[{type:Ne,position:P(t),code:t.find(e=>e.type===z).value}]},ft=t=>{const e=ln(t),n=ne(t),s=xe(t),i=P(t,{head:s?t[1]:t[0]}),o=[{type:Ae,position:i,graphic:e,coordinates:n}];if(s){const a=P(t,{head:t[0],length:2});o.unshift({type:Ee,position:a,mode:s})}return o},Fn={name:"operation",rules:[me([l(S,"1"),l(S,"2"),l(S,"3")]),te(2,8,[l(O),l(N)]),me([l(z,"1"),l(z,"2"),l(z,"3")]),l(G)],createNodes:ft},Gn={name:"operationWithoutCoords",rules:[me([l(S,"1"),l(S,"2"),l(S,"3")]),H([l(z,"1"),l(z,"2"),l(z,"3")]),l(G)],createNodes:ft},Ln={name:"interpolationMode",rules:[H([l(S,"1"),l(S,"2"),l(S,"3")]),l(G)],createNodes:t=>[{type:Ee,position:P(t),mode:xe(t)}]},Rn={name:"regionMode",rules:[H([l(S,"36"),l(S,"37")]),l(G)],createNodes:t=>[{type:tn,position:P(t),region:t[0].value==="36"}]},On={name:"quadrantMode",rules:[H([l(S,"74"),l(S,"75")]),l(G)],createNodes:t=>[{type:nn,position:P(t),quadrant:t[0].value==="74"?zt:qt}]},Nn={name:"loadPolarity",rules:[l(D),l(Ve),l(G),l(D)],createNodes:t=>[{type:Qt,position:P(t.slice(1,-1)),polarity:t[1].value==="D"?Vt:Ht}]},An={name:"stepRepeat",rules:[l(D),l(He),V([l(O),l(N)]),l(G),l(D)],createNodes(t){const e=ne(t),n=Object.fromEntries(Object.entries(e).map(([s,i])=>[s,Number(i)]));return[{type:en,position:P(t.slice(1,-1)),stepRepeat:n}]}},jn={name:"unimplementedExtendedCommand",rules:[l(D),V([ee(G)]),l(G),l(D)],createNodes:t=>[{type:sn,position:P(t.slice(1,-1)),value:je(t)}]},pt=[Fn,Gn,Ln,Pn,Sn,Tn,Cn,Rn,On,Nn,An,kn,Mn,In,jn].map(t=>({...t,filetype:Ue})),Dn=[...pt,...dt];function Xn(t,e=null){const n=[];let s=r(),i=[],o=null,a="";for(const[h,d]of t){const u=st([...i,h],s);u.nodes?(n.push(...u.nodes),o=d,a=""):a+=h.text,e=e??u.filetype??null,i=u.tokens??[],s=u.candidates??r()}return{filetype:e,unmatched:a,nodes:n,lexerState:o};function r(){return e===Ue?pt:e===Fe?dt:Dn}}function Yn(){const t=Gt(),e=[];let n=null,s=null,i="";const o={lexer:t,feed:a,result:r};return o;function a(h){const d=t.feed(`${i}${h}`,s),u=Xn(d,n);return n=n??u.filetype,i=u.unmatched,s=u.lexerState??s,e.push(...u.nodes),o}function r(){if(n===null)throw new Error("File type not recognized");return{type:Wt,filetype:n,children:e}}}function $n(t){return Yn().feed(t).result()}function _n(t,e){return Array.isArray(e)?[t.a*e[0]+t.c*e[1]+t.e,t.b*e[0]+t.d*e[1]+t.f]:{x:t.a*e.x+t.c*e.y+t.e,y:t.b*e.x+t.d*e.y+t.f}}function zn(t){const{a:e,b:n,c:s,d:i,e:o,f:a}=t,r=e*i-n*s;return{a:i/r,b:n/-r,c:s/-r,d:e/r,e:(i*o-s*a)/-r,f:(n*o-e*a)/r}}function mt(...t){t=Array.isArray(t[0])?t[0]:t;const e=(n,s)=>({a:n.a*s.a+n.c*s.b,c:n.a*s.c+n.c*s.d,e:n.a*s.e+n.c*s.f+n.e,b:n.b*s.a+n.d*s.b,d:n.b*s.c+n.d*s.d,f:n.b*s.e+n.d*s.f+n.f});switch(t.length){case 0:throw new Error("no matrices provided");case 1:return t[0];case 2:return e(t[0],t[1]);default:{const[n,s,...i]=t,o=e(n,s);return mt(o,...i)}}}function qn(t,e=1e10){return{a:Math.round(t.a*e)/e,b:Math.round(t.b*e)/e,c:Math.round(t.c*e)/e,d:Math.round(t.d*e)/e,e:Math.round(t.e*e)/e,f:Math.round(t.f*e)/e}}function Vn(t,e){const n=t[0].x!=null?t[0].x:t[0][0],s=t[0].y!=null?t[0].y:t[0][1],i=e[0].x!=null?e[0].x:e[0][0],o=e[0].y!=null?e[0].y:e[0][1],a=t[1].x!=null?t[1].x:t[1][0],r=t[1].y!=null?t[1].y:t[1][1],h=e[1].x!=null?e[1].x:e[1][0],d=e[1].y!=null?e[1].y:e[1][1],u=t[2].x!=null?t[2].x:t[2][0],p=t[2].y!=null?t[2].y:t[2][1],E=e[2].x!=null?e[2].x:e[2][0],x=e[2].y!=null?e[2].y:e[2][1],m={a:n-u,b:s-p,c:a-u,d:r-p,e:u,f:p},C={a:i-E,b:o-x,c:h-E,d:d-x,e:E,f:x},A=zn(m),R=mt([C,A]);return qn(R)}function Hn(t,e){function n(){this.constructor=t}n.prototype=e.prototype,t.prototype=new n}function Ie(t,e,n,s){var i=Error.call(this,t);return Object.setPrototypeOf&&Object.setPrototypeOf(i,Ie.prototype),i.expected=e,i.found=n,i.location=s,i.name="SyntaxError",i}Hn(Ie,Error);function Me(t,e,n){return n=n||" ",t.length>e?t:(e-=t.length,n+=n.repeat(e),t+n.slice(0,e))}Ie.prototype.format=function(t){var e="Error: "+this.message;if(this.location){var n=null,s;for(s=0;s<t.length;s++)if(t[s].source===this.location.source){n=t[s].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,o=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,a=this.location.source+":"+o.line+":"+o.column;if(n){var r=this.location.end,h=Me("",o.line.toString().length," "),d=n[i.line-1],u=i.line===r.line?r.column:d.length+1,p=u-i.column||1;e+=`
 --> `+a+`
`+h+` |
`+o.line+" | "+d+`
`+h+" | "+Me("",i.column-1," ")+Me("",p,"^")}else e+=`
 at `+a}return e};Ie.buildMessage=function(t,e){var n={literal:function(d){return'"'+i(d.text)+'"'},class:function(d){var u=d.parts.map(function(p){return Array.isArray(p)?o(p[0])+"-"+o(p[1]):o(p)});return"["+(d.inverted?"^":"")+u.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(d){return d.description}};function s(d){return d.charCodeAt(0).toString(16).toUpperCase()}function i(d){return d.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(u){return"\\x0"+s(u)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(u){return"\\x"+s(u)})}function o(d){return d.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(u){return"\\x0"+s(u)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(u){return"\\x"+s(u)})}function a(d){return n[d.type](d)}function r(d){var u=d.map(a),p,E;if(u.sort(),u.length>0){for(p=1,E=1;p<u.length;p++)u[p-1]!==u[p]&&(u[E]=u[p],E++);u.length=E}switch(u.length){case 1:return u[0];case 2:return u[0]+" or "+u[1];default:return u.slice(0,-1).join(", ")+", or "+u[u.length-1]}}function h(d){return d?'"'+i(d)+'"':"end of input"}return"Expected "+r(t)+" but "+h(e)+" found."};class Q{constructor(e,n,s){this.x=e,this.y=n,this.z=s,this.calX=null,this.calY=null,this.canvasX=null,this.canvasY=null,this.docElement=null}toArray(){return[this.x,this.y,this.z]}static fromArray(e){return new Q(e[0],e[1],e[2])}}class Jn extends Q{constructor(e,n,s,i,o){super(e,n,s),this.searchX=i,this.searchY=o}}class Zn{constructor(e,n){this.placements=[],this.fiducials=[],this.dispenseDegrees=30,this.retractionDegrees=1,this.dwellMilliseconds=100,this.preGcode="",this.postGcode="",this.invertDispense=!1,this.lumen=e,this.toast=n,this.jobCanvas=document.getElementById("pointViz"),this.clickedFidBuffer=[]}drawJobToCanvas(){const e=this.jobCanvas.getContext("2d");let n=1/0,s=1/0,i=-1/0,o=-1/0;for(const m of this.placements)n=Math.min(n,m.x),s=Math.min(s,m.y),i=Math.max(i,m.x),o=Math.max(o,m.y);for(const m of this.fiducials)n=Math.min(n,m.x),s=Math.min(s,m.y),i=Math.max(i,m.x),o=Math.max(o,m.y);const a=Math.max(i-n,o-s)*.1;n-=a,s-=a,i+=a,o+=a;const r=i-n,h=o-s,d=this.jobCanvas.width/r,u=this.jobCanvas.height/h,p=Math.min(d,u),E=-n,x=-s;e.clearRect(0,0,this.jobCanvas.width,this.jobCanvas.height),e.fillStyle="blue";for(let m of this.fiducials){const C=(m.x+E)*p,A=(m.y+x)*p;m.canvasX=C,m.canvasY=A,e.beginPath(),e.arc(C,this.jobCanvas.height-A,2,0,Math.PI*2),e.fill()}e.fillStyle="red";for(let m of this.placements){const C=(m.x+E)*p,A=(m.y+x)*p;m.canvasX=C,m.canvasY=A,e.beginPath(),e.arc(C,this.jobCanvas.height-A,2,0,Math.PI*2),e.fill()}}returnClosestFidFromClickCoordinates(e,n){let i=null,o=1/0;for(const a of this.fiducials){const r=Math.sqrt(Math.pow(a.canvasX-e,2)+Math.pow(a.canvasY-n,2));r<10&&r<o&&(o=r,i=a)}return i}async parseGerber(e){const n=document.getElementById(e);if(!n||!n.files[0])return console.error("No file selected"),[];const s=await n.files[0].text(),i=$n(s);console.log(i);let o=[],a,r,h,d,u=1e6,p=1,E=NaN,x=NaN;for(const m of i.children)if(m.type=="units")m.units&&(m.units==="mm"?p=1:m.units==="in"?(console.log("Converting from inches"),p=25.4):console.error("Unknown unit format: ",m.units));else if(m.type==="coordinateFormat"){if(m.format){let C=m.format[1];console.log("Got coordinate format command, decimal places: ",C),u=Math.pow(10,C)}else console.log("Invalid coordinate");m.mode!="absolute"&&alert("Invalid Gerber coordinate format: "+m.mode+`
Try re-exporting with absolute coordinates`)}else if(m.type==="graphic"&&m.graphic==="shape"){let C=m.coordinates.x,A=m.coordinates.y;(Number.isNaN(C)||C===void 0)&&(Number.isNaN(E)?console.error("No reference X for this point: ",m):C=E),(Number.isNaN(A)||A===void 0)&&(Number.isNaN(x)?console.error("No reference Y for this point: ",m):A=x),o.push({x:C/u*p,y:A/u*p}),(a===void 0||m.coordinates.x/u*p<a)&&(a=m.coordinates.x/u*p),(r===void 0||m.coordinates.y/u*p<r)&&(r=m.coordinates.y/u*p),(h===void 0||m.coordinates.x/u*p>h)&&(h=m.coordinates.x/u*p),(d===void 0||m.coordinates.y/u*p>d)&&(d=m.coordinates.y/u*p),Number.isNaN(m.coordinates.x)||m.coordinates.x===void 0||(E=m.coordinates.x),Number.isNaN(m.coordinates.y)||m.coordinates.y===void 0||(x=m.coordinates.y)}return console.log(o),o}async loadJobFromGerbers(){const e=await this.parseGerber("pasteGerberFile");let n=await this.parseGerber("maskGerberFile");console.log("pastePoints: ",e),console.log("maskPoints: ",n),n=n.filter(h=>!e.includes(h));let s=[];for(const h of n)e.includes(h)||s.push(h);console.log("onlyInMask: ",s);for(const h of e){const d=new Q(h.x,h.y,31.5);this.placements.push(d)}for(const h of s){const d=new Q(h.x,h.y,31.5);this.fiducials.push(d)}this.drawJobToCanvas();function i(h){const d=this.jobCanvas.getBoundingClientRect(),u=h.clientX-d.left,p=this.jobCanvas.height-(h.clientY-d.top);let E=this.returnClosestFidFromClickCoordinates(u,p);if(E!==null){this.toast.receivedInput=E,console.log("her'es the point: ",this.toast.receivedInput);const x=this.jobCanvas.getContext("2d");x.fillStyle="green",x.fillRect(E.canvasX-4,this.jobCanvas.height-E.canvasY-4,8,8)}else console.log("no matching click")}console.log("setting event listener"),this.jobCanvas.addEventListener("click",i.bind(this));const o=await this.toast.show("Please click on FID1 in the display."),a=await this.toast.show("Please click on FID2 in the display."),r=await this.toast.show("Please click on FID3 in the display.");this.jobCanvas.removeEventListener("click",i),this.fiducials=[o,a,r],console.log("fiducials: ",this.fiducials),console.log("placements: ",this.placements),this.loadJobIntoPositionList(),this.drawJobToCanvas()}async findBoardRoughPosition(){await this.toast.show("Please jog the camera to be centered on FID1.");const e=await this.lumen.grabBoardPosition();console.log("fid1Rough: ",e),this.fiducials[0].searchX=parseFloat(e[0]),this.fiducials[0].searchY=parseFloat(e[1]),await this.toast.show("Please jog the camera to be centered on FID2.");const n=await this.lumen.grabBoardPosition();this.fiducials[1].searchX=parseFloat(n[0]),this.fiducials[1].searchY=parseFloat(n[1]),await this.toast.show("Please jog the camera to be centered on FID3.");const s=await this.lumen.grabBoardPosition();this.fiducials[2].searchX=parseFloat(s[0]),this.fiducials[2].searchY=parseFloat(s[1]),await this.toast.show("Please jog the paste extruder tip to just barely touch the board.");let i=await this.lumen.grabBoardPosition();await this.lumen.serial.send(["G0 Z31.5"]),i=parseFloat(i[2])-.2;for(const o of this.placements)o.z=i;console.log("this.fiducials: ",this.fiducials),this.transformPlacements([[this.fiducials[0].searchX,this.fiducials[0].searchY],[this.fiducials[1].searchX,this.fiducials[1].searchY],[this.fiducials[2].searchX,this.fiducials[2].searchY]]),console.log(this.placements),this.loadJobIntoPositionList()}async performTipCalibration(){await this.toast.show("Please jog the camera to be centered on any fiducial.");const e=await this.lumen.grabBoardPosition();await this.lumen.serial.send(["G0 Z31.5"]),await this.lumen.serial.goToRelative(-45,63),await this.lumen.serial.send(["G0 Z46.5"]),await this.toast.show("Please jog the nozzle tip to be perfectly centered on and touching the fiducial.");const n=await this.lumen.grabBoardPosition();await this.lumen.serial.send(["G0 Z31.5"]),this.lumen.tipXoffset=n[0]-e[0],this.lumen.tipYoffset=n[1]-e[1]}async performFiducialCalibration(){if(this.fiducials.length!==3){console.error("No fids in this job, cannot perform fiducial calibration.");return}let e=[];for(let n=0;n<this.fiducials.length;n++){const s=this.fiducials[n];console.log(`Processing fiducial ${n+1}:`,s),console.log("jogging to fid: ",s.searchX,s.searchY);try{await this.lumen.serial.goTo(s.searchX,s.searchY),await new Promise(o=>setTimeout(o,1500)),await this.lumen.jogToFiducial(),await new Promise(o=>setTimeout(o,1500)),await this.lumen.jogToFiducial(),await new Promise(o=>setTimeout(o,1500));const i=await this.lumen.grabBoardPosition();console.log(`Fiducial ${n+1} final position:`,i),e.push([parseFloat(i[0]),parseFloat(i[1])]),s.calX=i[0],s.calY=i[1]}catch(i){throw console.error(`Error processing fiducial ${n+1}:`,i),i}}console.log("All fiducials processed, transforming placements..."),this.transformPlacements(e),console.log("fid cal complete: ",this.fiducials),this.loadJobIntoPositionList()}loadJobIntoPositionList(){const e=document.querySelector(".positions-list");e.innerHTML="";for(let n of this.placements)this.createPositionElement(n,!1);for(let n of this.fiducials)this.createPositionElement(n,!0)}handleFiducialSelectionClick(e){const n=this.jobCanvas.getBoundingClientRect(),s=e.clientX-n.left,i=e.clientY-n.top;let o=this.returnClosestFidFromClickCoordinates(s,i);o&&(ctx.beginPath(),ctx.arc(o.canvasX,n.height-o.canvasY,6,0,Math.PI*2),ctx.fill(),this.clickedFidBuffer.push(o),currentFidIndex++,currentFidIndex<3?updateModalForFid():(modal.style.display="none",overlay.style.display="none",this.fiducials=this.clickedFidBuffer,this.clickedFidBuffer=[],console.log(this.fiducials),canvas.removeEventListener("click",this.handleFiducialSelectionClick)))}async captureNewPosition(){if(console.log("Job capture method called"),!this.lumen.serial){console.error("Serial manager not set");return}console.log("Serial manager is set, proceeding with capture"),this.lumen.serial.clearInspectBuffer(),console.log("Inspect buffer cleared"),await this.lumen.serial.send(["G92"]),console.log("G92 command sent");const e=/X:(.*?) Y:(.*?) Z:(.*?) A:(.*?) B:(.*?) /,n=new RegExp(e,"i");console.log("Serial inspect buffer contents:",this.lumen.serial.inspectBuffer);for(var s=0;s<this.lumen.serial.inspectBuffer.length;s++){let i=this.lumen.serial.inspectBuffer[s];console.log("Checking line:",i);let o=n.test(i);if(console.log("Regex test result:",o),o){const a=n.exec(i);console.log("Position matches:",a),this.addPoint(parseFloat(a[1]),parseFloat(a[2]),parseFloat(a[3])),console.log("Point added to job"),this.loadJobIntoPositionList();return}}console.log("No valid position found in inspect buffer")}addPoint(e,n,s){let i=new Q(e,n,s);this.placements.push(i)}async importFromFile(e){try{const n=await new Promise((u,p)=>{const E=new FileReader;E.onload=x=>u(x.target.result),E.onerror=x=>p(x),E.readAsText(e)}),s=JSON.parse(n);this.placements=(s.placements||[]).map(u=>{const p=new Q(u.x,u.y,u.z);return p.calX=u.calX,p.calY=u.calY,p.canvasX=u.canvasX,p.canvasY=u.canvasY,p}),this.fiducials=(s.fiducials||[]).map(u=>{const p=new Jn(u.x,u.y,u.z,u.searchX,u.searchY);return p.calX=u.calX,p.calY=u.calY,p.canvasX=u.canvasX,p.canvasY=u.canvasY,p}),this.dispenseDegrees=s.dispenseDegrees||30,this.retractionDegrees=s.retractionDegrees||1,this.dwellMilliseconds=s.dwellMilliseconds||100,this.preGcode=s.preGcode||"",this.postGcode=s.postGcode||"",this.invertDispense=s.invertDispense||!1,typeof s.tipXoffset<"u"&&(this.lumen.tipXoffset=s.tipXoffset),typeof s.tipYoffset<"u"&&(this.lumen.tipYoffset=s.tipYoffset);const i=document.getElementById("jobDispenseDeg"),o=document.getElementById("jobRetractionDeg"),a=document.getElementById("jobDwellMs"),r=document.getElementById("jobPreGcode"),h=document.getElementById("jobPostGcode"),d=document.getElementById("jobInvertDispense");return i&&(i.value=this.dispenseDegrees),o&&(o.value=this.retractionDegrees),a&&(a.value=this.dwellMilliseconds),r&&(r.value=this.preGcode),h&&(h.value=this.postGcode),d&&(d.checked=this.invertDispense),this.loadJobIntoPositionList(),this.drawJobToCanvas(),{success:!0}}catch(n){return{success:!1,error:n.message||n.toString()}}}async saveToFile(){const e=this.export(),n=new Blob([e],{type:"application/json"}),i=await(await window.showSaveFilePicker({suggestedName:"job.json",types:[{description:"JSON Files",accept:{"application/json":[".json"]}}]})).createWritable();await i.write(n),await i.close()}createPositionElement(e,n){const s=document.querySelector(".positions-list"),i=document.createElement("div");i.className="position-item";let o,a;e.calX!=null&e.calY!=null?(o=e.calX,a=e.calY):e.searchX!=null&e.searchY!=null?(o=e.searchX,a=e.searchY):(o=e.x,a=e.y),n?i.innerHTML=`
            <span class="position-text">Fiducial: X:${o} Y:${a} Z:${e.z}</span>
            <div class="button-group">
                <button class="move-btn">â˜‰</button>
                <button class="remove-btn">X</button>
            </div>
        `:i.innerHTML=`
            <span class="position-text">Position: X:${o} Y:${a} Z:${e.z}</span>
            <div class="button-group">
                <button class="move-btn">â˜‰</button>
                <button class="remove-btn">X</button>
            </div>
        `,i.querySelector(".move-btn").addEventListener("click",()=>{let r,h;e.calX!=null&e.calY!=null?(r=e.calX,h=e.calY):(r=e.x,h=e.y),this.lumen.serial.send(["G90","G0 Z31.5",`G0 X${r} Y${h}`])}),i.querySelector(".remove-btn").addEventListener("click",()=>{i.remove(),this.placements=this.placements.filter(r=>r.x!==e.x||r.y!==e.y||r.z!==e.z),this.fiducials=this.fiducials.filter(r=>r.x!==e.x||r.y!==e.y||r.z!==e.z),this.loadJobIntoPositionList(),this.drawJobToCanvas(),console.log(this.placements)}),s.appendChild(i)}slice(){const e=[];if(this.preGcode&&this.preGcode.trim()){const a=this.preGcode.split(`
`).map(r=>r.trim()).filter(r=>r.length>0);e.push(...a)}e.push("G90","G92 B0","G0 Z31.5");let n=0;console.log(this.positions);const s=parseFloat(this.dispenseDegrees),i=parseFloat(this.retractionDegrees),o=parseFloat(this.dwellMilliseconds);for(const a of this.placements){let r=n-s,h=r+i;this.invertDispense&&(r=n+s,h=r-i);let d=a.x,u=a.y;a.calX!=null&&(d=a.calX),a.calY!=null&&(u=a.calY),e.push(`G0 X${d+this.lumen.tipXoffset} Y${u+this.lumen.tipYoffset}`,`G0 Z${a.z}`,`G0 B${r}`,`G0 B${h}`,`G4 P${o}`,"G0 Z31.5"),n=h}if(e.push("G0 X5 Y5"),this.postGcode&&this.postGcode.trim()){const a=this.postGcode.split(`
`).map(r=>r.trim()).filter(r=>r.length>0);e.push(...a)}return e}async run(){let e=this.slice();this.toast.show("Running job. Close this to cancel.");for(const n of e){if(console.log(this.toast.receivedInput),this.toast.toastObject.style.display=="none"){await this.lumen.serial.send(["G0 Z31.5"]),await this.lumen.serial.send(["G0 X5 Y5"]);return}await this.lumen.serial.send([n])}this.toast.receivedInput=!1}export(){const e={placements:this.placements.map(n=>({x:n.x,y:n.y,z:n.z,calX:n.calX,calY:n.calY,canvasX:n.canvasX,canvasY:n.canvasY})),fiducials:this.fiducials.map(n=>({x:n.x,y:n.y,z:n.z,calX:n.calX,calY:n.calY,canvasX:n.canvasX,canvasY:n.canvasY,searchX:n.searchX,searchY:n.searchY})),dispenseDegrees:this.dispenseDegrees,retractionDegrees:this.retractionDegrees,dwellMilliseconds:this.dwellMilliseconds,preGcode:this.preGcode,postGcode:this.postGcode,invertDispense:this.invertDispense,tipXoffset:this.lumen.tipXoffset,tipYoffset:this.lumen.tipYoffset};return JSON.stringify(e,null,2)}transformPlacements(e){const n=[[this.fiducials[0].x,this.fiducials[0].y],[this.fiducials[1].x,this.fiducials[1].y],[this.fiducials[2].x,this.fiducials[2].y]],s=Vn(n,e);for(let i of this.placements){let o=_n(s,[i.x,i.y]);i.calX=o[0],i.calY=o[1]}}}class Wn{constructor(e){this.serial=e,this.video=null,this.tipXoffset=0,this.tipYoffset=0}addVideoManager(e){this.video=e}async grabBoardPosition(){console.log("grabbing board position"),this.serial.clearInspectBuffer(),await this.serial.send(["G92"]),console.log("sent G92");const e=/X:(.*?) Y:(.*?) Z:(.*?) A:(.*?) B:(.*?) /,n=new RegExp(e,"i");console.log("serial inspect buffer: ",this.serial.inspectBuffer);let s=[];for(var i=0;i<this.serial.inspectBuffer.length;i++){let o=this.serial.inspectBuffer[i];if(console.log(o),n.test(o)){const r=n.exec(o);s=[r[1],r[2],r[3]];break}}return console.log("positionArray: ",s),s}async jogToFiducial(){const e=this.video.CVdetectCircle();if(this.video.displayCvFrame(1e3),e){const[n,s]=e,i=this.video.canvas.width/2,o=this.video.canvas.height/2,a=n-i,r=-(s-o),h=.02,d=a*h,u=r*h;await this.serial.goToRelative(d.toFixed(1),u.toFixed(1))}}}let Un=new wt,Kn=new bt,T=new Bt(Un),U=new Wn(T),L=new Zn(U,Kn);Et(t=>{console.log("OpenCV loaded");const e=new xt(t);U.addVideoManager(e);const n=document.getElementById("opencv-canvas"),s=document.getElementById("camera-select"),i=document.getElementById("process-button");e.populateCameraList(s);let o=!1;const a=document.getElementById("importJob"),r=document.getElementById("jobFile"),h=document.getElementById("exportJob"),d=document.getElementById("jobDispenseDeg"),u=document.getElementById("jobRetractionDeg"),p=document.getElementById("jobDwellMs"),E=document.getElementById("jobPreGcode"),x=document.getElementById("jobPostGcode"),m=document.getElementById("jobInvertDispense");d&&d.addEventListener("change",B=>{console.log("Dispense degrees changed:",B.target.value),L.dispenseDegrees=Number(B.target.value)}),u&&u.addEventListener("change",B=>{console.log("Retraction degrees changed:",B.target.value),L.retractionDegrees=Number(B.target.value)}),p&&p.addEventListener("change",B=>{console.log("Dwell milliseconds changed:",B.target.value),L.dwellMilliseconds=Number(B.target.value)}),E&&E.addEventListener("input",B=>{console.log("Pre-gcode changed"),L.preGcode=B.target.value}),x&&x.addEventListener("input",B=>{console.log("Post-gcode changed"),L.postGcode=B.target.value}),m&&m.addEventListener("change",B=>{console.log("Invert dispense changed:",B.target.checked),L.invertDispense=B.target.checked}),a&&r?(a.addEventListener("click",()=>{r.click()}),r.addEventListener("change",async B=>{const k=B.target.files[0];if(k){console.log("Reading file:",k.name);try{const $=await L.importFromFile(k);$.success||(console.error("Failed to import job:",$.error),alert("Failed to import job file: "+$.error))}catch($){console.error("Error importing job:",$),alert("Error importing job file: "+$.message)}}})):console.error("Import button or file input not found");const C=document.getElementById("selectPasteGerber"),A=document.getElementById("selectMaskGerber"),R=document.getElementById("loadGerbers"),X=document.getElementById("pasteGerberFile"),se=document.getElementById("maskGerberFile"),ce=document.getElementById("pasteGerberFilename"),ge=document.getElementById("maskGerberFilename");C&&X&&(C.addEventListener("click",()=>{X.click()}),X.addEventListener("change",B=>{const k=B.target.files[0];k?ce.textContent=k.name:ce.textContent=""})),A&&se&&(A.addEventListener("click",()=>{se.click()}),se.addEventListener("change",B=>{const k=B.target.files[0];k?ge.textContent=k.name:ge.textContent=""})),R&&R.addEventListener("click",async()=>{if(!X.files[0]||!se.files[0]){alert("Please select both paste and mask gerber files first");return}try{await L.loadJobFromGerbers()}catch(B){console.error("Error loading gerbers:",B),alert("Error loading gerber files: "+B.message)}}),h&&h.addEventListener("click",async()=>{try{d&&(L.dispenseDegrees=Number(d.value)),u&&(L.retractionDegrees=Number(u.value)),p&&(L.dwellMilliseconds=Number(p.value)),E&&(L.preGcode=E.value),x&&(L.postGcode=x.value),m&&(L.invertDispense=m.checked),await L.saveToFile()}catch(B){B.name!=="AbortError"&&(console.error("Error saving file:",B),alert("Error saving file: "+B.message))}}),n.addEventListener("click",B=>{const k=n.getBoundingClientRect(),$=B.clientX-k.left,Ce=B.clientY-k.top,ue=n.width/k.width,c=n.height/k.height,f=$*ue,g=Ce*c,v=n.width/2,b=n.height/2,y=f-v,I=-(g-b),F=.02,M=y*F,w=I*F;T.goToRelative(M.toFixed(1),w.toFixed(1))}),document.getElementById("connect").addEventListener("click",async()=>{const B=document.getElementById("connect");try{o||(await T.connect(),await e.startVideo(s.value,n),o=!0,B.textContent="Connected",B.classList.add("connected"),B.disabled=!0)}catch(k){alert("Error: "+k.message)}}),i.addEventListener("click",()=>{o&&U.jogToFiducial()}),document.getElementById("homing-fid-button").addEventListener("click",async()=>{await U.serial.goTo(218,196),await new Promise(B=>setTimeout(B,1e3)),await U.jogToFiducial(),await new Promise(B=>setTimeout(B,1500)),await U.jogToFiducial(),await new Promise(B=>setTimeout(B,1500)),U.serial.send(["G92 X218 Y196"])}),document.getElementById("nozzleOffsetCal").addEventListener("click",async()=>{await L.performTipCalibration()})});function Qn(){document.getElementById("repl-input").value=""}document.getElementById("repl-input").addEventListener("keyup",function(t){if(t.code==="Enter")t.preventDefault(),document.getElementById("send").click();else if(t.code==="ArrowUp"){if(t.preventDefault(),T.sentCommandBufferIndex==T.sentCommandBuffer.length-1)return!1;T.sentCommandBufferIndex++,document.getElementById("repl-input").value=T.sentCommandBuffer[T.sentCommandBufferIndex]}else if(t.code==="ArrowDown"){if(t.preventDefault(),T.sentCommandBufferIndex==0)return!1;T.sentCommandBufferIndex--,document.getElementById("repl-input").value=T.sentCommandBuffer[T.sentCommandBufferIndex]}});document.getElementById("send").addEventListener("click",()=>{T.sendRepl(),Qn()});function le(){let t=document.getElementById("jog-distance").value;return t=="1"?.1:t=="2"?1:t=="3"?10:t=="4"?100:1}document.getElementById("jog-yp").addEventListener("click",()=>{let t=le();T.send(["G91",`G0 Y${t}`,"G90"])});document.getElementById("jog-ym").addEventListener("click",()=>{let t=le();T.send(["G91",`G0 Y-${t}`,"G90"])});document.getElementById("jog-xp").addEventListener("click",()=>{let t=le();T.send(["G91",`G0 X${t}`,"G90"])});document.getElementById("jog-xm").addEventListener("click",()=>{let t=le();T.send(["G91",`G0 X-${t}`,"G90"])});document.getElementById("jog-zp").addEventListener("click",()=>{let t=le();T.send(["G91",`G0 Z${t}`,"G90"])});document.getElementById("jog-zm").addEventListener("click",()=>{let t=le();T.send(["G91",`G0 Z-${t}`,"G90"])});const Xe=document.getElementById("extrude-btn"),Ye=document.getElementById("retract-btn");Xe&&Xe.addEventListener("click",()=>{const t=L.invertDispense?2:-2;T.send(["G91",`G0 B${t}`,"G90"])});Ye&&Ye.addEventListener("click",()=>{const t=L.invertDispense?-2:2;T.send(["G91",`G0 B${t}`,"G90"])});document.getElementById("left-air-on").addEventListener("click",()=>{T.send(["M106","M106 P1 S255"])});document.getElementById("left-air-off").addEventListener("click",()=>{T.send(["M107","M107 P1"])});document.getElementById("left-vac").addEventListener("click",()=>{T.readLeftVac()});document.getElementById("ring-lights-on").addEventListener("click",()=>{T.send(["M150 P255 R255 U255 B255"])});document.getElementById("ring-lights-off").addEventListener("click",()=>{T.send(["M150 P0"])});document.getElementById("disable-steppers").addEventListener("click",()=>{T.send(["M18"])});document.getElementById("home-x").addEventListener("click",()=>{T.send(["G28 X"])});document.getElementById("home-y").addEventListener("click",()=>{T.send(["G28 Y"])});document.getElementById("home-z").addEventListener("click",()=>{T.send(["G28 Z"])});document.getElementById("getRoughBoardPosition").addEventListener("click",async()=>{try{await L.findBoardRoughPosition()}catch(t){console.error("Error during capture:",t)}});document.getElementById("runJob").addEventListener("click",async()=>{try{await L.run()}catch(t){console.error("Error during run:",t)}});document.getElementById("performFidCal").addEventListener("click",async()=>{try{await L.performFiducialCalibration()}catch(t){console.error("Error during fid cal:",t)}});document.getElementById("captureNewPos").addEventListener("click",async()=>{try{await L.captureNewPosition()}catch(t){console.error("Error during pos capture:",t)}});
