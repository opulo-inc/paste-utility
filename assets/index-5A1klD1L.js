var A=Object.defineProperty;var M=(i,e,r)=>e in i?A(i,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[e]=r;var b=(i,e,r)=>(M(i,typeof e!="symbol"?e+"":e,r),r);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))t(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&t(c)}).observe(document,{childList:!0,subtree:!0});function r(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function t(s){if(s.ep)return;s.ep=!0;const o=r(s);fetch(s.href,o)}})();class G{constructor(){b(this,"timeout",async e=>new Promise(r=>setTimeout(r,e)));this.modalObject=document.getElementById("modal"),this.overlay=document.getElementById("overlay"),this.modalTitle=document.getElementById("modal-title"),this.modalContent=document.getElementById("modal-content"),this.modalNumInput=document.getElementById("modal-num-input"),this.modalClose=document.getElementById("modal-close"),this.modalOK=document.getElementById("modal-ok"),this.receivedInput=void 0}hide(){this.modalObject.style.display="none",this.overlay.style.display="none"}show(e,r,t){t===void 0&&(t=0),this.modalTitle.innerHTML=e,this.modalContent.innerHTML=r,this.modalObject.style.display="flex",this.overlay.style.display="block",t==0?this.modalNumInput.style.display="none":t==1&&(this.modalNumInput.style.display="block",this.modalNumInput.value=1),this.modalOK.focus();let s=this.waitForUserSelection();return s&&t==1&&(s=this.modalNumInput.value),s}async waitForUserSelection(){for(;this.receivedInput===void 0;)await this.timeout(50);let e=this.receivedInput;return this.receivedInput=void 0,e}}class I{constructor(e){b(this,"delay",e=>new Promise(r=>setTimeout(r,e)));this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.consoleDiv=document.getElementById("console"),this.port,this.modal=e,this.receiveBuffer=[],this.inspectBuffer=[],this.sentCommandBuffer=[""],this.sentCommandBufferIndex=0,this.okRespTimeout=!1,this.timeoutID=void 0,this.bootCommands=["G90","M260 A112 B1 S1","M260 A109","M260 B48","M260 B27","M260 S1","M260 A112 B2 S1","M260 A109","M260 B48","M260 B27","M260 S1","G0 F35000"]}async appendToConsole(e,r){let t=document.createElement("p"),s=new Date().toISOString(),o="";r?o="[SEND]":o="[RECE]",t.innerHTML=o+" - "+s+" - "+e+`
`,this.consoleDiv.appendChild(t),this.consoleDiv.scrollTop=this.consoleDiv.scrollHeight}clearBuffer(){for(;this.receiveBuffer.length>0;)this.receiveBuffer.shift()}clearInspectBuffer(){for(;this.inspectBuffer.length>0;)this.inspectBuffer.shift()}dec2bin(e){return(e>>>0).toString(2)}async connect(){if(!navigator.serial)return this.modal.show("Browser Support","Please use a browser that supports WebSerial, like Chrome, Opera, or Edge. <a href='https://developer.mozilla.org/en-US/docs/Web/API/Web_Serial_API#browser_compatibility'>Supported Browsers."),!1;const e=1155;return this.port=await navigator.serial.requestPort({filters:[{usbVendorId:e}]}),console.log("Port Selected."),await this.port.open({baudRate:115200,bufferSize:255,dataBits:8,flowControl:"none",parity:"none",stopBits:1}),console.log("Port Opened."),this.listen(),document.querySelector("#connect").style.background="green",document.querySelector("#connect").style.color="white",document.querySelector("#connect").innerHTML="Connected",this.send(this.bootCommands),!0}async listen(){var e;for(;(e=this.port)!=null&&e.readable;){console.log("Port is readable: Starting to listen.");let r="";document.getElementById("console");const t=this.port.readable.getReader();try{for(;;){const{value:s,done:o}=await t.read();if(o){console.log("Closing reader.");break}const c=this.decoder.decode(s);for(r=r.concat(c);r.indexOf(`
`)!=-1;){let n=r.split(`
`);this.receiveBuffer.push(n[0]),this.appendToConsole(n[0],!1),this.inspectBuffer.push(n[0]),console.log("current inspect buffer",this.inspectBuffer),r=r.split(`
`).slice(1).join(`
`)}}}catch(s){console.error("Reading error.",s)}finally{t.releaseLock()}}}sleep(e){for(var r=new Date().getTime(),t=0;t<1e7&&!(new Date().getTime()-r>e);t++);}async setOkRespTimeout(){new Promise(e=>{this.timeoutID=setTimeout(()=>{console.log("timeout triggered"),this.okRespTimeout=!0,e()},5e3)})}async send(e){var r;if(console.log("sending: ",e),(r=this.port)!=null&&r.writable){const t=await this.port.writable.getWriter();for(const s of e){for(await t.write(this.encoder.encode(s+`
`)),this.setOkRespTimeout(),this.appendToConsole(s,!0),this.clearBuffer();!this.okRespTimeout;){let o=this.receiveBuffer.shift();if(o=="ok"){clearTimeout(this.timeoutID);break}(o="echo:busy: processing")&&(clearTimeout(this.timeoutID),this.setOkRespTimeout()),await new Promise(c=>setTimeout(c,50))}this.okRespTimeout=!1}t.releaseLock()}else this.modal.show("Cannot Write","Cannot write to port. Have you connected?")}async sendRepl(){let e=[document.querySelector("#repl-input").value];this.sentCommandBuffer.splice(1,0,e[0]),this.sentCommandBufferIndex=0,this.send(e)}async leftAirOn(){const e=["M106","M106 P1 S255"];await this.send(e)}async leftAirOff(){const e=["M107","M107 P1"];await this.send(e)}async rightAirOn(){const e=["M106 P2 S255","M106 P3 S255"];await this.send(e)}async rightAirOff(){const e=["M107 P2","M107 P3"];await this.send(e)}async ledOn(){const e=["M150 P255 R255 U255 B255"];await this.send(e)}async ledOff(){const e=["M150 P0"];await this.send(e)}async disableSteppers(){const e=["M18"];await this.send(e)}async readLeftVac(){var f;if(!((f=this.port)!=null&&f.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;const e=["M260 A112 B1 S1"],r=50;this.clearBuffer();let t,s,o;const c=new RegExp("data:(..)");await this.send(e),this.clearBuffer(),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(r);for(var n=0,d=this.receiveBuffer.length;n<d;n++){let m=this.receiveBuffer[n];if(c.test(m)){t=m.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(r);for(var n=0,d=this.receiveBuffer.length;n<d;n++){let h=this.receiveBuffer[n];if(c.test(h)){s=h.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(r);for(var n=0,d=this.receiveBuffer.length;n<d;n++){let h=this.receiveBuffer[n];if(c.test(h)){o=h.match("data:(..)")[1];break}}let a=parseInt(t+s+o,16);a&1<<23&&(a=a-2**24),await this.modal.show("Left Vacuum Sensor Value",a),this.clearBuffer()}async readRightVac(){var f;if(!((f=this.port)!=null&&f.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;const e=["M260 A112 B2 S1"];let r,t,s;const o=new RegExp("data:(..)"),c=50;this.clearBuffer(),await this.send(e),await this.delay(c),this.clearBuffer(),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(c);for(var n=0,d=this.receiveBuffer.length;n<d;n++){let m=this.receiveBuffer[n];if(o.test(m)){r=m.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(c);for(var n=0,d=this.receiveBuffer.length;n<d;n++){let h=this.receiveBuffer[n];if(o.test(h)){t=h.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(c);for(var n=0,d=this.receiveBuffer.length;n<d;n++){let h=this.receiveBuffer[n];if(o.test(h)){s=h.match("data:(..)")[1];break}}let a=parseInt(r+t+s,16);a&1<<23&&(a=a-2**24),await this.modal.show("Right Vacuum Sensor Value",a)}async testTMC(){var s;if(!((s=this.port)!=null&&s.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;let e="";const r=["M122"];await this.clearBuffer(),await this.send(r),await this.delay(5e3),console.log(this.receiveBuffer);for(let o=0;o<this.receiveBuffer.length;o++)e=e.concat(this.receiveBuffer[o]+`
`);if(await this.modal.show("Stepper Driver Test Complete","Test is complete. Click OK to download test report.")==!0){let o=new Date().toISOString();o=o+"-tmctest.txt",this.download(o,e)}}async testVac(){var B;if(!((B=this.port)!=null&&B.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;let e="";const r=["M260 A112 B1 S1","M260 A109","M260 B48","M260 B10","M260 S1"],t=["M260 A112 B2 S1","M260 A109","M260 B48","M260 B10","M260 S1"],s=100;this.clearBuffer();let o,c,n;const d=new RegExp("data:(..)");await this.send(r),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(s);for(var a=0,f=this.receiveBuffer.length;a<f;a++){let g=this.receiveBuffer[a];if(d.test(g)){o=g.match("data:(..)")[1],e=e.concat("Left MSB - "+o+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(s);for(var a=0,f=this.receiveBuffer.length;a<f;a++){let u=this.receiveBuffer[a];if(d.test(u)){c=u.match("data:(..)")[1],e=e.concat("Left CSB - "+c+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(s);for(var a=0,f=this.receiveBuffer.length;a<f;a++){let u=this.receiveBuffer[a];if(d.test(u)){n=u.match("data:(..)")[1],e=e.concat("Left LSB - "+n+`
`);break}}let m=parseInt(o+c+n,16);m&1<<23&&(m=m-2**24),e=e.concat("Left Val - "+m+`
`),this.clearBuffer(),await this.send(t),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(s);for(var a=0,f=this.receiveBuffer.length;a<f;a++){let u=this.receiveBuffer[a];if(d.test(u)){o=u.match("data:(..)")[1],e=e.concat("Right MSB - "+o+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(s);for(var a=0,f=this.receiveBuffer.length;a<f;a++){let u=this.receiveBuffer[a];if(d.test(u)){c=u.match("data:(..)")[1],e=e.concat("Right CSB - "+c+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(s),console.log("current buffer length: ",this.receiveBuffer.length);for(var a=0,f=this.receiveBuffer.length;a<f;a++){let u=this.receiveBuffer[a];if(d.test(u)){n=u.match("data:(..)")[1],e=e.concat("Right LSB - "+n+`
`);break}}let p=parseInt(o+c+n,16);if(p&1<<23&&(p=p-2**24),e=e.concat("Right Val - "+p+`
`),console.log(m,p),await this.modal.show("Vacuum Sensor Test Complete","Test is complete. Click OK to download test report.")==!0){let g=new Date().toISOString();g=g+"-vactest.txt",this.download(g,e)}}download(e,r){var t=document.createElement("a");t.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(r)),t.setAttribute("download",e),t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)}}let w=new G,l=new I(w),y=[];document.getElementById("modal-close").addEventListener("click",()=>{w.receivedInput=!1,w.hide()});document.getElementById("modal-ok").addEventListener("keyup",function(i){i.code==="Enter"&&(i.preventDefault(),w.receivedInput=!0,w.hide())});document.getElementById("modal-ok").addEventListener("click",()=>{w.receivedInput=!0,w.hide()});document.getElementById("modal-ng").addEventListener("click",()=>{w.receivedInput=!1,w.hide()});function L(){document.getElementById("repl-input").value=""}document.getElementById("repl-input").addEventListener("keyup",function(i){if(i.code==="Enter")i.preventDefault(),document.getElementById("send").click();else if(i.code==="ArrowUp"){if(i.preventDefault(),l.sentCommandBufferIndex==l.sentCommandBuffer.length-1)return!1;l.sentCommandBufferIndex++,document.getElementById("repl-input").value=l.sentCommandBuffer[l.sentCommandBufferIndex]}else if(i.code==="ArrowDown"){if(i.preventDefault(),l.sentCommandBufferIndex==0)return!1;l.sentCommandBufferIndex--,document.getElementById("repl-input").value=l.sentCommandBuffer[l.sentCommandBufferIndex]}});document.getElementById("capture-button").addEventListener("click",()=>{k()});document.getElementById("export-captured").addEventListener("click",()=>{E()});document.getElementById("connect").addEventListener("click",()=>{l.connect()});document.getElementById("send").addEventListener("click",()=>{l.sendRepl(),L()});document.getElementById("home").addEventListener("click",()=>{l.send(["G28"])});document.addEventListener("keyup",function(i){i.getModifierState("Shift")&&!i.getModifierState("Alt")?i.code==="ArrowUp"?(console.log("we saw shift arrow up!"),l.send(["G91","G0 Y10","G90"])):i.code==="ArrowDown"?(console.log("we saw shift arrow down!"),l.send(["G91","G0 Y-10","G90"])):i.code==="ArrowLeft"?(console.log("we saw shift arrow left!"),l.send(["G91","G0 X-10","G90"])):i.code==="ArrowRight"?(console.log("we saw shift arrow right!"),l.send(["G91","G0 X10","G90"])):i.code==="BracketLeft"?(console.log("we saw shift comma!"),l.send(["G91","G0 Z-10","G90"])):i.code==="BracketRight"&&(console.log("we saw shift period!"),l.send(["G91","G0 Z10","G90"])):!i.getModifierState("Shift")&&i.getModifierState("Alt")?i.code==="ArrowUp"?(console.log("we saw shift arrow up!"),l.send(["G91","G0 Y1","G90"])):i.code==="ArrowDown"?(console.log("we saw shift arrow down!"),l.send(["G91","G0 Y-1","G90"])):i.code==="ArrowLeft"?(console.log("we saw shift arrow left!"),l.send(["G91","G0 X-1","G90"])):i.code==="ArrowRight"?(console.log("we saw shift arrow right!"),l.send(["G91","G0 X1","G90"])):i.code==="BracketLeft"?(console.log("we saw shift comma!"),l.send(["G91","G0 Z-1","G90"])):i.code==="BracketRight"&&(console.log("we saw shift period!"),l.send(["G91","G0 Z1","G90"])):i.getModifierState("Shift")&&i.getModifierState("Alt")&&(i.code==="ArrowUp"?(console.log("we saw shift arrow up!"),l.send(["G91","G0 Y0.1","G90"])):i.code==="ArrowDown"?(console.log("we saw shift arrow down!"),l.send(["G91","G0 Y-0.1","G90"])):i.code==="ArrowLeft"?(console.log("we saw shift arrow left!"),l.send(["G91","G0 X-0.1","G90"])):i.code==="ArrowRight"?(console.log("we saw shift arrow right!"),l.send(["G91","G0 X0.1","G90"])):i.code==="BracketLeft"?(console.log("we saw shift comma!"),l.send(["G91","G0 Z-0.1","G90"])):i.code==="BracketRight"&&(console.log("we saw shift period!"),l.send(["G91","G0 Z0.1","G90"])))});function E(){const i=JSON.stringify(y),e=new Blob([i],{type:"text/plain"}),r=URL.createObjectURL(e),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download="positions.json",t.click(),URL.revokeObjectURL(r)}async function k(){l.clearInspectBuffer(),await l.send(["G92"]);const i=/X:(.*?) Y:(.*?) Z:(.*?) A:(.*?) B:(.*?) /,e=new RegExp(i,"i");console.log("serial inspect buffer: ",l.inspectBuffer);for(var r=0;r<l.inspectBuffer.length;r++){let t=l.inspectBuffer[r];if(console.log(t),e.test(t)){const o=e.exec(t);let c=[o[1],o[2],o[3]];y.push(c);const n=document.createElement("div");n.className="position-item",n.innerHTML=`Position: ${c.join(", ")} <button class="remove-btn">X</button>`,document.getElementById("capture-output").appendChild(n),n.querySelector(".remove-btn").addEventListener("click",function(){n.remove();const d=y.indexOf(c);d>-1&&y.splice(d,1),console.log("positions: ",y)})}}console.log("positions: ",y)}const v=document.getElementById("pastingForm"),C=document.getElementById("generatedGcode");v.addEventListener("submit",async i=>{i.preventDefault();const e=i.submitter.name,r=new FormData(v),t=Object.fromEntries(r.entries());t.fileData=JSON.parse(await t.dataFile.text()),delete t.dataFile;const s=x(t.fileData,t);if(C.innerHTML=s.join(`
`),e!="execute")return;let o=w.show("Ensure Nozzles Are Level","Manually level the nozzles before hitting ok.");console.log("now we'll execute!!",o),o.then(c=>{console.log(c),l.send(s)})});function x(i,{dispenseDeg:e,retractionDeg:r,dwellMs:t}){const s=[];s.push("G90","G28","G28","G92 B0");let o=0;e=parseFloat(e),r=parseFloat(r),t=parseFloat(t);for(const[c,n,d]of i){const a=o+e,f=a-r;s.push(`G0 X${c} Y${n}`,`G0 Z${d}`,`G0 B${a}`,`G0 B${f}`,`G4 P${t}`,"G0 Z31.5"),o=f}return s.push("G0 X300 Y400"),s}
