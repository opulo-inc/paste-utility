var pt=Object.defineProperty;var mt=(e,t,n)=>t in e?pt(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var ve=(e,t,n)=>(mt(e,typeof t!="symbol"?t+"":t,n),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const l of i)if(l.type==="childList")for(const u of l.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&o(u)}).observe(document,{childList:!0,subtree:!0});function n(i){const l={};return i.integrity&&(l.integrity=i.integrity),i.referrerPolicy&&(l.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?l.credentials="include":i.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(i){if(i.ep)return;i.ep=!0;const l=n(i);fetch(i.href,l)}})();class gt{constructor(){ve(this,"timeout",async t=>new Promise(n=>setTimeout(n,t)));this.modalObject=document.getElementById("modal"),this.overlay=document.getElementById("overlay"),this.modalTitle=document.getElementById("modal-title"),this.modalContent=document.getElementById("modal-content"),this.modalNumInput=document.getElementById("modal-num-input"),this.modalClose=document.getElementById("modal-close"),this.modalOK=document.getElementById("modal-ok"),this.receivedInput=void 0}hide(){this.modalObject.style.display="none",this.overlay.style.display="none"}show(t,n,o){o===void 0&&(o=0),this.modalTitle.innerHTML=t,this.modalContent.innerHTML=n,this.modalObject.style.display="flex",this.overlay.style.display="block",o==0?this.modalNumInput.style.display="none":o==1&&(this.modalNumInput.style.display="block",this.modalNumInput.value=1),this.modalOK.focus();let i=this.waitForUserSelection();return i&&o==1&&(i=this.modalNumInput.value),i}async waitForUserSelection(){for(;this.receivedInput===void 0;)await this.timeout(50);let t=this.receivedInput;return this.receivedInput=void 0,t}}class yt{constructor(t){ve(this,"delay",t=>new Promise(n=>setTimeout(n,t)));this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.consoleDiv=document.getElementById("console"),this.port,this.modal=t,this.receiveBuffer=[],this.inspectBuffer=[],this.sentCommandBuffer=[""],this.sentCommandBufferIndex=0,this.okRespTimeout=!1,this.timeoutID=void 0,this.bootCommands=["G90","M260 A112 B1 S1","M260 A109","M260 B48","M260 B27","M260 S1","M260 A112 B2 S1","M260 A109","M260 B48","M260 B27","M260 S1","G0 F35000"]}async appendToConsole(t,n){let o=document.createElement("p"),i=new Date().toISOString(),l="";n?l="[SEND]":l="[RECE]",o.innerHTML=l+" - "+i+" - "+t+`
`,this.consoleDiv.appendChild(o),this.consoleDiv.scrollTop=this.consoleDiv.scrollHeight}clearBuffer(){for(;this.receiveBuffer.length>0;)this.receiveBuffer.shift()}clearInspectBuffer(){for(;this.inspectBuffer.length>0;)this.inspectBuffer.shift()}dec2bin(t){return(t>>>0).toString(2)}async connect(){if(!navigator.serial)return this.modal.show("Browser Support","Please use a browser that supports WebSerial, like Chrome, Opera, or Edge. <a href='https://developer.mozilla.org/en-US/docs/Web/API/Web_Serial_API#browser_compatibility'>Supported Browsers."),!1;const t=1155;return this.port=await navigator.serial.requestPort({filters:[{usbVendorId:t}]}),console.log("Port Selected."),await this.port.open({baudRate:115200,bufferSize:255,dataBits:8,flowControl:"none",parity:"none",stopBits:1}),console.log("Port Opened."),this.listen(),document.querySelector("#connect").style.background="green",document.querySelector("#connect").style.color="white",document.querySelector("#connect").innerHTML="Connected",this.send(this.bootCommands),!0}async listen(){var t;for(;(t=this.port)!=null&&t.readable;){console.log("Port is readable: Starting to listen.");let n="";document.getElementById("console");const o=this.port.readable.getReader();try{for(;;){const{value:i,done:l}=await o.read();if(l){console.log("Closing reader.");break}const u=this.decoder.decode(i);for(n=n.concat(u);n.indexOf(`
`)!=-1;){let a=n.split(`
`);this.receiveBuffer.push(a[0]),this.appendToConsole(a[0],!1),this.inspectBuffer.push(a[0]),console.log("current inspect buffer",this.inspectBuffer),n=n.split(`
`).slice(1).join(`
`)}}}catch(i){console.error("Reading error.",i)}finally{o.releaseLock()}}}sleep(t){for(var n=new Date().getTime(),o=0;o<1e7&&!(new Date().getTime()-n>t);o++);}async setOkRespTimeout(){new Promise(t=>{this.timeoutID=setTimeout(()=>{console.log("timeout triggered"),this.okRespTimeout=!0,t()},5e3)})}async send(t){var n;if(console.log("sending: ",t),(n=this.port)!=null&&n.writable){const o=await this.port.writable.getWriter();for(const i of t){for(await o.write(this.encoder.encode(i+`
`)),this.setOkRespTimeout(),this.appendToConsole(i,!0),this.clearBuffer();!this.okRespTimeout;){let l=this.receiveBuffer.shift();if(l=="ok"){clearTimeout(this.timeoutID);break}(l="echo:busy: processing")&&(clearTimeout(this.timeoutID),this.setOkRespTimeout()),await new Promise(u=>setTimeout(u,50))}this.okRespTimeout=!1}o.releaseLock()}else this.modal.show("Cannot Write","Cannot write to port. Have you connected?")}async sendRepl(){let t=[document.querySelector("#repl-input").value];this.sentCommandBuffer.splice(1,0,t[0]),this.sentCommandBufferIndex=0,this.send(t)}async leftAirOn(){const t=["M106","M106 P1 S255"];await this.send(t)}async leftAirOff(){const t=["M107","M107 P1"];await this.send(t)}async rightAirOn(){const t=["M106 P2 S255","M106 P3 S255"];await this.send(t)}async rightAirOff(){const t=["M107 P2","M107 P3"];await this.send(t)}async ledOn(){const t=["M150 P255 R255 U255 B255"];await this.send(t)}async ledOff(){const t=["M150 P0"];await this.send(t)}async disableSteppers(){const t=["M18"];await this.send(t)}async readLeftVac(){var m;if(!((m=this.port)!=null&&m.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;const t=["M260 A112 B1 S1"],n=50;this.clearBuffer();let o,i,l;const u=new RegExp("data:(..)");await this.send(t),this.clearBuffer(),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var a=0,p=this.receiveBuffer.length;a<p;a++){let S=this.receiveBuffer[a];if(u.test(S)){o=S.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var a=0,p=this.receiveBuffer.length;a<p;a++){let T=this.receiveBuffer[a];if(u.test(T)){i=T.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(n);for(var a=0,p=this.receiveBuffer.length;a<p;a++){let T=this.receiveBuffer[a];if(u.test(T)){l=T.match("data:(..)")[1];break}}let f=parseInt(o+i+l,16);f&1<<23&&(f=f-2**24),await this.modal.show("Left Vacuum Sensor Value",f),this.clearBuffer()}async readRightVac(){var m;if(!((m=this.port)!=null&&m.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;const t=["M260 A112 B2 S1"];let n,o,i;const l=new RegExp("data:(..)"),u=50;this.clearBuffer(),await this.send(t),await this.delay(u),this.clearBuffer(),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(u);for(var a=0,p=this.receiveBuffer.length;a<p;a++){let S=this.receiveBuffer[a];if(l.test(S)){n=S.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(u);for(var a=0,p=this.receiveBuffer.length;a<p;a++){let T=this.receiveBuffer[a];if(l.test(T)){o=T.match("data:(..)")[1];break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(u);for(var a=0,p=this.receiveBuffer.length;a<p;a++){let T=this.receiveBuffer[a];if(l.test(T)){i=T.match("data:(..)")[1];break}}let f=parseInt(n+o+i,16);f&1<<23&&(f=f-2**24),await this.modal.show("Right Vacuum Sensor Value",f)}async testTMC(){var i;if(!((i=this.port)!=null&&i.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;let t="";const n=["M122"];await this.clearBuffer(),await this.send(n),await this.delay(5e3),console.log(this.receiveBuffer);for(let l=0;l<this.receiveBuffer.length;l++)t=t.concat(this.receiveBuffer[l]+`
`);if(await this.modal.show("Stepper Driver Test Complete","Test is complete. Click OK to download test report.")==!0){let l=new Date().toISOString();l=l+"-tmctest.txt",this.download(l,t)}}async testVac(){var P;if(!((P=this.port)!=null&&P.writable))return this.modal.show("Cannot Write","Cannot write to port. Have you connected?"),!1;let t="";const n=["M260 A112 B1 S1","M260 A109","M260 B48","M260 B10","M260 S1"],o=["M260 A112 B2 S1","M260 A109","M260 B48","M260 B10","M260 S1"],i=100;this.clearBuffer();let l,u,a;const p=new RegExp("data:(..)");await this.send(n),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var f=0,m=this.receiveBuffer.length;f<m;f++){let C=this.receiveBuffer[f];if(p.test(C)){l=C.match("data:(..)")[1],t=t.concat("Left MSB - "+l+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var f=0,m=this.receiveBuffer.length;f<m;f++){let R=this.receiveBuffer[f];if(p.test(R)){u=R.match("data:(..)")[1],t=t.concat("Left CSB - "+u+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var f=0,m=this.receiveBuffer.length;f<m;f++){let R=this.receiveBuffer[f];if(p.test(R)){a=R.match("data:(..)")[1],t=t.concat("Left LSB - "+a+`
`);break}}let S=parseInt(l+u+a,16);S&1<<23&&(S=S-2**24),t=t.concat("Left Val - "+S+`
`),this.clearBuffer(),await this.send(o),await this.send(["M260 A109 B6 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var f=0,m=this.receiveBuffer.length;f<m;f++){let R=this.receiveBuffer[f];if(p.test(R)){l=R.match("data:(..)")[1],t=t.concat("Right MSB - "+l+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B7 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i);for(var f=0,m=this.receiveBuffer.length;f<m;f++){let R=this.receiveBuffer[f];if(p.test(R)){u=R.match("data:(..)")[1],t=t.concat("Right CSB - "+u+`
`);break}}this.clearBuffer(),await this.send(["M260 A109 B8 S1"]),await this.send(["M261 A109 B1 S1"]),await this.delay(i),console.log("current buffer length: ",this.receiveBuffer.length);for(var f=0,m=this.receiveBuffer.length;f<m;f++){let R=this.receiveBuffer[f];if(p.test(R)){a=R.match("data:(..)")[1],t=t.concat("Right LSB - "+a+`
`);break}}let _=parseInt(l+u+a,16);if(_&1<<23&&(_=_-2**24),t=t.concat("Right Val - "+_+`
`),console.log(S,_),await this.modal.show("Vacuum Sensor Test Complete","Test is complete. Click OK to download test report.")==!0){let C=new Date().toISOString();C=C+"-vactest.txt",this.download(C,t)}}download(t,n){var o=document.createElement("a");o.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(n)),o.setAttribute("download",t),o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o)}}var wt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},be={},vt={get exports(){return be},set exports(e){be=e}};(function(e){(function(t,n){e.exports?e.exports=n():t.moo=n()})(wt,function(){var t=Object.prototype.hasOwnProperty,n=Object.prototype.toString,o=typeof new RegExp().sticky=="boolean";function i(s){return s&&n.call(s)==="[object RegExp]"}function l(s){return s&&typeof s=="object"&&!i(s)&&!Array.isArray(s)}function u(s){return s.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function a(s){var c=new RegExp("|"+s);return c.exec("").length-1}function p(s){return"("+s+")"}function f(s){if(!s.length)return"(?!)";var c=s.map(function(d){return"(?:"+d+")"}).join("|");return"(?:"+c+")"}function m(s){if(typeof s=="string")return"(?:"+u(s)+")";if(i(s)){if(s.ignoreCase)throw new Error("RegExp /i flag not allowed");if(s.global)throw new Error("RegExp /g flag is implied");if(s.sticky)throw new Error("RegExp /y flag is implied");if(s.multiline)throw new Error("RegExp /m flag is implied");return s.source}else throw new Error("Not a pattern: "+s)}function S(s,c){return s.length>c?s:Array(c-s.length+1).join(" ")+s}function _(s,c){for(var d=s.length,h=0;;){var v=s.lastIndexOf(`
`,d-1);if(v===-1||(h++,d=v,h===c)||d===0)break}var g=h<c?0:d+1;return s.substring(g).split(`
`)}function T(s){for(var c=Object.getOwnPropertyNames(s),d=[],h=0;h<c.length;h++){var v=c[h],g=s[v],B=[].concat(g);if(v==="include"){for(var I=0;I<B.length;I++)d.push({include:B[I]});continue}var x=[];B.forEach(function(w){l(w)?(x.length&&d.push(C(v,x)),d.push(C(v,w)),x=[]):x.push(w)}),x.length&&d.push(C(v,x))}return d}function P(s){for(var c=[],d=0;d<s.length;d++){var h=s[d];if(h.include){for(var v=[].concat(h.include),g=0;g<v.length;g++)c.push({include:v[g]});continue}if(!h.type)throw new Error("Rule has no type: "+JSON.stringify(h));c.push(C(h.type,h))}return c}function C(s,c){if(l(c)||(c={match:c}),c.include)throw new Error("Matching rules cannot also include states");var d={defaultType:s,lineBreaks:!!c.error||!!c.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var h in c)t.call(c,h)&&(d[h]=c[h]);if(typeof d.type=="string"&&s!==d.type)throw new Error("Type transform cannot be a string (type '"+d.type+"' for token '"+s+"')");var v=d.match;return d.match=Array.isArray(v)?v:v?[v]:[],d.match.sort(function(g,B){return i(g)&&i(B)?0:i(B)?-1:i(g)?1:B.length-g.length}),d}function O(s){return Array.isArray(s)?P(s):T(s)}var R=C("error",{lineBreaks:!0,shouldThrow:!0});function D(s,c){for(var d=null,h=Object.create(null),v=!0,g=null,B=[],I=[],x=0;x<s.length;x++)s[x].fallback&&(v=!1);for(var x=0;x<s.length;x++){var w=s[x];if(w.include)throw new Error("Inheritance is not allowed in stateless lexers");if(w.error||w.fallback){if(d)throw!w.fallback==!d.fallback?new Error("Multiple "+(w.fallback?"fallback":"error")+" rules not allowed (for token '"+w.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+w.defaultType+"')");d=w}var G=w.match.slice();if(v)for(;G.length&&typeof G[0]=="string"&&G[0].length===1;){var te=G.shift();h[te.charCodeAt(0)]=w}if(w.pop||w.push||w.next){if(!c)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+w.defaultType+"')");if(w.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+w.defaultType+"')")}if(G.length!==0){v=!1,B.push(w);for(var z=0;z<G.length;z++){var U=G[z];if(i(U)){if(g===null)g=U.unicode;else if(g!==U.unicode&&w.fallback===!1)throw new Error("If one rule is /u then all must be")}}var ne=f(G.map(m)),j=new RegExp(ne);if(j.test(""))throw new Error("RegExp matches empty string: "+j);var le=a(ne);if(le>0)throw new Error("RegExp has capture groups: "+j+`
Use (?: … ) instead`);if(!w.lineBreaks&&j.test(`
`))throw new Error("Rule should declare lineBreaks: "+j);I.push(p(ne))}}var re=d&&d.fallback,ae=o&&!re?"ym":"gm",de=o||re?"":"|";g===!0&&(ae+="u");var ht=new RegExp(f(I)+de,ae);return{regexp:ht,groups:B,fast:h,error:d||R}}function se(s){var c=D(O(s));return new N({start:c},"start")}function Le(s,c,d){var h=s&&(s.push||s.next);if(h&&!d[h])throw new Error("Missing state '"+h+"' (in token '"+s.defaultType+"' of state '"+c+"')");if(s&&s.pop&&+s.pop!=1)throw new Error("pop must be 1 (in token '"+s.defaultType+"' of state '"+c+"')")}function ct(s,c){var d=s.$all?O(s.$all):[];delete s.$all;var h=Object.getOwnPropertyNames(s);c||(c=h[0]);for(var v=Object.create(null),g=0;g<h.length;g++){var B=h[g];v[B]=O(s[B]).concat(d)}for(var g=0;g<h.length;g++)for(var B=h[g],I=v[B],x=Object.create(null),w=0;w<I.length;w++){var G=I[w];if(G.include){var te=[w,1];if(G.include!==B&&!x[G.include]){x[G.include]=!0;var z=v[G.include];if(!z)throw new Error("Cannot include nonexistent state '"+G.include+"' (in state '"+B+"')");for(var U=0;U<z.length;U++){var ne=z[U];I.indexOf(ne)===-1&&te.push(ne)}}I.splice.apply(I,te),w--}}for(var j=Object.create(null),g=0;g<h.length;g++){var B=h[g];j[B]=D(v[B],!0)}for(var g=0;g<h.length;g++){for(var le=h[g],re=j[le],ae=re.groups,w=0;w<ae.length;w++)Le(ae[w],le,j);for(var de=Object.getOwnPropertyNames(re.fast),w=0;w<de.length;w++)Le(re.fast[de[w]],le,j)}return new N(j,c)}function ut(s){for(var c=typeof Map<"u",d=c?new Map:Object.create(null),h=Object.getOwnPropertyNames(s),v=0;v<h.length;v++){var g=h[v],B=s[g],I=Array.isArray(B)?B:[B];I.forEach(function(x){if(typeof x!="string")throw new Error("keyword must be string (in keyword '"+g+"')");c?d.set(x,g):d[x]=g})}return function(x){return c?d.get(x):d[x]}}var N=function(s,c){this.startState=c,this.states=s,this.buffer="",this.stack=[],this.reset()};N.prototype.reset=function(s,c){return this.buffer=s||"",this.index=0,this.line=c?c.line:1,this.col=c?c.col:1,this.queuedToken=c?c.queuedToken:null,this.queuedText=c?c.queuedText:"",this.queuedThrow=c?c.queuedThrow:null,this.setState(c?c.state:this.startState),this.stack=c&&c.stack?c.stack.slice():[],this},N.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedText:this.queuedText,queuedThrow:this.queuedThrow}},N.prototype.setState=function(s){if(!(!s||this.state===s)){this.state=s;var c=this.states[s];this.groups=c.groups,this.error=c.error,this.re=c.regexp,this.fast=c.fast}},N.prototype.popState=function(){this.setState(this.stack.pop())},N.prototype.pushState=function(s){this.stack.push(this.state),this.setState(s)};var ft=o?function(s,c){return s.exec(c)}:function(s,c){var d=s.exec(c);return d[0].length===0?null:d};N.prototype._getGroup=function(s){for(var c=this.groups.length,d=0;d<c;d++)if(s[d+1]!==void 0)return this.groups[d];throw new Error("Cannot find token type for matched text")};function dt(){return this.value}if(N.prototype.next=function(){var s=this.index;if(this.queuedGroup){var c=this._token(this.queuedGroup,this.queuedText,s);return this.queuedGroup=null,this.queuedText="",c}var d=this.buffer;if(s!==d.length){var B=this.fast[d.charCodeAt(s)];if(B)return this._token(B,d.charAt(s),s);var h=this.re;h.lastIndex=s;var v=ft(h,d),g=this.error;if(v==null)return this._token(g,d.slice(s,d.length),s);var B=this._getGroup(v),I=v[0];return g.fallback&&v.index!==s?(this.queuedGroup=B,this.queuedText=I,this._token(g,d.slice(s,v.index),s)):this._token(B,I,s)}},N.prototype._token=function(s,c,d){var h=0;if(s.lineBreaks){var v=/\n/g,g=1;if(c===`
`)h=1;else for(;v.exec(c);)h++,g=v.lastIndex}var B={type:typeof s.type=="function"&&s.type(c)||s.defaultType,value:typeof s.value=="function"?s.value(c):c,text:c,toString:dt,offset:d,lineBreaks:h,line:this.line,col:this.col},I=c.length;if(this.index+=I,this.line+=h,h!==0?this.col=I-g+1:this.col+=I,s.shouldThrow){var x=new Error(this.formatError(B,"invalid syntax"));throw x}return s.pop?this.popState():s.push?this.pushState(s.push):s.next&&this.setState(s.next),B},typeof Symbol<"u"&&Symbol.iterator){var we=function(s){this.lexer=s};we.prototype.next=function(){var s=this.lexer.next();return{value:s,done:!s}},we.prototype[Symbol.iterator]=function(){return this},N.prototype[Symbol.iterator]=function(){return new we(this)}}return N.prototype.formatError=function(h,c){if(h==null)var d=this.buffer.slice(this.index),h={text:d,offset:this.index,lineBreaks:d.indexOf(`
`)===-1?0:1,line:this.line,col:this.col};var v=2,g=Math.max(h.line-v,1),B=h.line+v,I=String(B).length,x=_(this.buffer,this.line-h.line+v+1).slice(0,5),w=[];w.push(c+" at line "+h.line+" col "+h.col+":"),w.push("");for(var G=0;G<x.length;G++){var te=x[G],z=g+G;w.push(S(String(z),I)+"  "+te),z===h.line&&w.push(S("",I+h.col+1)+"^")}return w.join(`
`)},N.prototype.clone=function(){return new N(this.states,this.state)},N.prototype.has=function(s){return!0},{compile:se,states:ct,error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:ut}})})(vt);const _e=be,ce="T_CODE",b="G_CODE",Y="M_CODE",$="D_CODE",k="ASTERISK",L="PERCENT",Pe="EQUALS",ie="COMMA",W="OPERATOR",Ee="GERBER_FORMAT",pe="GERBER_UNITS",De="GERBER_TOOL_MACRO",je="GERBER_TOOL_DEF",ze="GERBER_LOAD_POLARITY",$e="GERBER_STEP_REPEAT",ue="GERBER_MACRO_VARIABLE",qe="SEMICOLON",Fe="DRILL_UNITS",xe="DRILL_ZERO_INCLUSION",A="COORD_CHAR",M="NUMBER",Bt="WORD",bt="WHITESPACE",q="NEWLINE",Et="CATCHALL",xt="ERROR",St=/^0*/,He=e=>e.replace(St,""),he=e=>He(e.slice(1))||"0",kt={[ce]:{match:/T\d+/,value:he},[b]:{match:/G\d+/,value:he},[Y]:{match:/M\d+/,value:he},[$]:{match:/D\d+/,value:he},[k]:"*",[L]:"%",[Pe]:"=",[Ee]:{match:/FS[LTDAI]+/,value:e=>e.slice(2)},[pe]:{match:/MO(?:IN|MM)/,value:e=>e.slice(2)},[De]:{match:/AM[a-zA-Z_.$][\w.-]*/,value:e=>e.slice(2)},[je]:{match:/ADD\d+[a-zA-Z_.$][\w.-]*/,value:e=>He(e.slice(3))},[ze]:{match:/LP[DC]/,value:e=>e.slice(2)},[$e]:"SR",[ue]:/\$\d+/,[qe]:";",[Fe]:/^(?:METRIC|INCH)/,[xe]:{match:/,(?:TZ|LZ)/,value:e=>e.slice(1)},[A]:/[XYIJACFSBHZN]/,[M]:/[+-]?[\d.]+/,[W]:["x","/","+","-","(",")"],[ie]:",",[Bt]:/[a-zA-Z]+/,[bt]:/[ \t]+/,[q]:{match:/\r?\n/,lineBreaks:!0},[Et]:/\S/,[xt]:_e.error};function It(){const e=_e.compile(kt);return{feed:t};function t(o,i=null){return e.reset(o,i??void 0),n((i==null?void 0:i.offset)??0)}function n(o){return{[Symbol.iterator](){return this},next(){const i=e.next();if(i){const l={...i,offset:o+i.offset},u={...e.save(),offset:o+(e.index??0)};return{value:[l,u]}}return{value:void 0,done:!0}}}}}const Ve="gerber",ke="drill",Ie="mm",Ae="in",Xe="leading",Ye="trailing",At="absolute",Mt="incremental",Me="circle",Ze="rectangle",Gt="obround",Tt="polygon",Ot="macroShape",Rt="shape",Ue="move",Lt="segment",Ct="slot",Nt="line",_t="cwArc",Pt="ccwArc",Dt="single",jt="multi",zt="dark",$t="clear",me="TOKEN",X="MIN_TO_MAX";function r(e,t){return{rule:me,type:e,value:t}}function J(e,t){return{rule:me,type:e,value:t,negate:!0}}function V(e){return{rule:X,min:1,max:1,match:e}}function fe(e){return{rule:X,min:0,max:1,match:e}}function F(e){return{rule:X,min:0,max:Number.POSITIVE_INFINITY,match:e}}function We(e){return{rule:X,min:1,max:Number.POSITIVE_INFINITY,match:e}}function Q(e,t,n){return{rule:X,min:e,max:t,match:n}}function Ke(e,t){const n=[];for(const o of t){const i=Ft(e,o.rules);if(i===Qe)n.push(o);else if(i===Je)return{filetype:o.filetype,nodes:o.createNodes(e)}}return n.length>0?{candidates:n,tokens:e}:{}}const Je="FULL_MATCH",Qe="PARTIAL_MATCH",qt="NO_MATCH";function Ft(e,t){let n=0,o=0,i=0;for(;n<t.length&&o<e.length;){const l=t[n],u=e[o];if(et(l,u))l.rule===me||l.rule===X&&i>=l.max-1?(n++,o++,i=0):l.rule===X&&(o++,i++);else if(l.rule===X&&i>=l.min)i=0,n++;else return qt}return n<t.length?Qe:Je}function et(e,t){if(e.rule===me){const n=e.type===t.type,o=e.value===null||typeof e.value>"u"||typeof e.value=="string"&&e.value===t.value||e.value instanceof RegExp&&e.value.test(t.value),i=n&&o;return e.negate?!i:i}return Array.isArray(e.match)?e.match.some(n=>et(n,t)):!1}const Ht="root",tt="comment",Vt="drillHeader",nt="done",Ge="units",rt="coordinateFormat",ot="toolDefinition",Xt="toolMacro",Te="toolChange",Yt="loadPolarity",Zt="stepRepeat",Oe="graphic",ge="interpolateMode",Ut="regionMode",Wt="quadrantMode",Kt="unimplemented",Jt="macroComment",Qt="macroVariable",en="macroPrimitive";function ee(e){return Object.fromEntries(e.map((t,n)=>[t,e[n-1]]).filter(([t,n])=>t.type===M&&(n==null?void 0:n.type)===A).map(([t,n])=>[n.value.toLowerCase(),t.value]))}function ye(e){return e.filter(t=>t.type===b).map(t=>t.value==="0"?Ue:t.value==="1"?Nt:t.value==="2"?_t:t.value==="3"?Pt:t.value==="5"?ke:null)[0]??null}function tn(e){return e.filter(t=>t.type===$).map(t=>t.value==="1"?Lt:t.value==="2"?Ue:t.value==="3"?Rt:null)[0]??null}function Re(e){return e.map(t=>t.value).join("").trim()}function E(e,t={}){const{head:n=e[0],length:o=0}=t,i=o>0?e[e.indexOf(n)+o-1]:e[e.length-1];return{start:{line:n.line,column:n.col,offset:n.offset},end:{line:i.line,column:i.col,offset:i.offset}}}const nn={name:"units",rules:[V([r(Fe),r(Y,"71"),r(Y,"72")]),F([r(ie),r(xe),r(M,/^0{1,8}\.0{1,8}$/)]),r(q)],createNodes(e){const t=e[0].value==="INCH"||e[0].value==="72"?Ae:Ie,n=e.filter(l=>l.type===xe).map(l=>l.value==="LZ"?Ye:l.value==="TZ"?Xe:null),o=e.filter(l=>l.type===M).map(l=>{const[u="",a=""]=l.value.split(".");return[u.length,a.length]}),i=[{type:Ge,position:E(e.slice(0,2)),units:t}];return(n.length>0||o.length>0)&&i.push({type:rt,position:E(e.slice(1)),mode:null,format:o[0]??null,zeroSuppression:n[0]??null}),i}},rn={name:"tool",rules:[r(ce),Q(0,12,[r(A,"C"),r(A,"F"),r(A,"S"),r(A,"B"),r(A,"H"),r(A,"Z"),r(M)]),r(q)],createNodes(e){const t=e[0].value,n=E(e),{c:o=null}=ee(e.slice(1,-1)),i=o===null?null:{type:Me,diameter:Number(o)};return i?[{type:ot,hole:null,position:n,shape:i,code:t}]:[{type:Te,position:n,code:t}]}},on={name:"operationMode",rules:[V([r(b,"0"),r(b,"1"),r(b,"2"),r(b,"3"),r(b,"5")]),r(q)],createNodes:e=>[{type:ge,position:E(e),mode:ye(e)}]},sn={name:"operation",rules:[Q(0,2,[r(ce),r(b,"0"),r(b,"1"),r(b,"2"),r(b,"3"),r(b,"5")]),Q(2,8,[r(A),r(M)]),fe([r(ce)]),r(q)],createNodes(e){const t=e.filter(S=>S.type===A||S.type===M),n=e.find(S=>S.type===b),o=e.find(S=>S.type===ce),i=ee(t),l=o?o.value:null,u=ye(e),a=E(e,{head:t[0],length:t.length+1}),p=E(e,{head:n,length:2}),f=E(e,{head:o,length:2}),m=[{type:Oe,position:a,graphic:null,coordinates:i}];return u&&m.unshift({type:ge,position:p,mode:u}),l&&m.unshift({type:Te,position:f,code:l}),m}},ln={name:"slot",rules:[Q(2,4,[r(A),r(M)]),r(b,"85"),Q(2,4,[r(A),r(M)]),r(q)],createNodes(e){const t=e.find(l=>l.type===b),n=t?e.indexOf(t):-1,o=Object.fromEntries(Object.entries(ee(e.slice(0,n))).map(([l,u])=>[`${l}0`,u])),i=ee(e.slice(n));return[{type:Oe,position:E(e),graphic:Ct,coordinates:{...o,...i}}]}},an={name:"done",rules:[V([r(Y,"30"),r(Y,"0")]),r(q)],createNodes:e=>[{type:nt,position:E(e)}]},cn={name:"header",rules:[V([r(Y,"48"),r(L)]),r(q)],createNodes:e=>[{type:Vt,position:E(e)}]},un={name:"comment",rules:[r(qe),F([J(q)]),r(q)],createNodes:e=>[{type:tt,comment:Re(e.slice(1,-1)),position:E(e)}]},it=[rn,on,sn,ln,un,nn,an,cn].map(e=>({...e,filetype:ke})),fn={name:"macroComment",rules:[r(M,"0"),F([J(k)]),r(k)],createNodes:pn},dn={name:"macroVariable",rules:[r(ue),r(Pe),We([r(M),r(W),r(ue),r(A,"X")]),r(k)],createNodes:gn},hn={name:"macroPrimitive",rules:[r(M),r(ie),We([r(ie),r(M),r(W),r(ue),r(A,"X")]),r(k)],createNodes:mn};function pn(e){const t=e.slice(1,-1).map(n=>n.text).join("").trim();return[{type:Jt,position:E(e),comment:t}]}function mn(e){const t=e[0].value,n=[[]];let o=n[0];for(const l of e.slice(2,-1))l.type===ie?(o=[],n.push(o)):o.push(l);const i=n.map(l=>st(l));return[{type:en,position:E(e),code:t,parameters:i}]}function gn(e){const t=e[0].value,n=st(e.slice(2,-1));return[{type:Qt,position:E(e),name:t,value:n}]}function st(e){const t=e.map(u=>u.type===A?{...u,type:W,value:"x"}:u);return l();function n(){return t[0]??null}function o(){const u=t.shift();if(u.type===M)return Number(u.value);if(u.type===ue)return u.value;const a=l();return t.shift(),a}function i(){let u=o(),a=n();for(;(a==null?void 0:a.type)===W&&(a.value==="x"||a.value==="/");)t.shift(),u={left:u,right:o(),operator:a.value},a=n();return u}function l(){let u=i(),a=n();for(;(a==null?void 0:a.type)===W&&(a.value==="+"||a.value==="-")||(a==null?void 0:a.type)===M;){let p="+";a.type===W&&(t.shift(),p=a.value);const f=i();u={left:u,right:f,operator:p},a=n()}return u}}const Ce=[hn,dn,fn];function yn(e){let t=Ce,n=[];const o=[];for(const i of e){const l=Ke([...n,i],t);l.nodes&&o.push(...l.nodes),n=l.tokens??[],t=l.candidates??Ce}return o}const Be=e=>{if(e.length===1){const[t]=e;return{type:Me,diameter:t}}if(e.length===2){const[t,n]=e;return{type:Ze,xSize:t,ySize:n}}return null},wn={name:"done",rules:[V([r(Y,"0"),r(Y,"2")]),r(k)],createNodes:e=>[{type:nt,position:E(e)}]},vn={name:"comment",rules:[r(b,"4"),F([J(k)]),r(k)],createNodes:e=>[{type:tt,position:E(e),comment:Re(e.slice(1,-1))}]},Bn={name:"format",rules:[r(L),r(Ee),F([J(A,"X")]),r(A,"X"),r(M),r(A,"Y"),r(M),F([J(k)]),r(k),Q(0,2,[r(pe),r(k)]),r(L)],createNodes(e){var t;let n=null,o=null,i=null;const l=ee(e),u=e.findIndex(f=>f.type===k),a=e.find(f=>f.type===pe);for(const f of e.filter(m=>m.type===Ee))f.value.includes("T")&&(o=Ye),f.value.includes("L")&&(o=Xe),f.value.includes("I")&&(i=Mt),f.value.includes("A")&&(i=At);if(l.x===l.y&&((t=l.x)==null?void 0:t.length)===2){const f=Number(l.x[0]),m=Number(l.x[1]);f&&m&&(n=[f,m])}const p=[{type:rt,position:E(e.slice(1,u+1)),zeroSuppression:o,format:n,mode:i}];return a&&p.push({type:Ge,position:E(e.slice(1,-1),{head:a}),units:a.value==="MM"?Ie:Ae}),p}},bn={name:"units",rules:[r(L),r(pe),r(k),r(L)],createNodes:e=>[{type:Ge,position:E(e.slice(1,-1)),units:e[1].value==="MM"?Ie:Ae}]},En={name:"toolMacro",rules:[r(L),r(De),r(k),F([J(L)]),r(L)],createNodes(e){const t=e[1].value,n=E(e.slice(1,-1)),o=e.slice(3,-1);return[{type:Xt,position:n,children:yn(o),name:t}]}},xn={name:"toolDefinition",rules:[r(L),r(je),F([r(ie),r(M),r(A,"X")]),r(k),r(L)],createNodes(e){let t,n=null;const o=/(\d+)(.+)/.exec(e[1].value),[,i="",l=""]=o??[],u=e.slice(3,-2).filter(a=>a.type===M).map(a=>Number(a.value));switch(l){case"C":{const[a,...p]=u;t={type:Me,diameter:a},n=Be(p);break}case"R":case"O":{const[a,p,...f]=u;t={type:l==="R"?Ze:Gt,xSize:a,ySize:p},n=Be(f);break}case"P":{const[a,p,f=null,...m]=u;t={type:Tt,diameter:a,vertices:p,rotation:f},n=Be(m);break}default:t={type:Ot,name:l,variableValues:u}}return[{type:ot,position:E(e.slice(1,-1)),code:i,shape:t,hole:n}]}},Sn={name:"toolChange",rules:[fe([r(b,"54")]),r($),r(k)],createNodes:e=>[{type:Te,position:E(e),code:e.find(t=>t.type===$).value}]},lt=e=>{const t=tn(e),n=ee(e),o=ye(e),i=E(e,{head:o?e[1]:e[0]}),l=[{type:Oe,position:i,graphic:t,coordinates:n}];if(o){const u=E(e,{head:e[0],length:2});l.unshift({type:ge,position:u,mode:o})}return l},kn={name:"operation",rules:[fe([r(b,"1"),r(b,"2"),r(b,"3")]),Q(2,8,[r(A),r(M)]),fe([r($,"1"),r($,"2"),r($,"3")]),r(k)],createNodes:lt},In={name:"operationWithoutCoords",rules:[fe([r(b,"1"),r(b,"2"),r(b,"3")]),V([r($,"1"),r($,"2"),r($,"3")]),r(k)],createNodes:lt},An={name:"interpolationMode",rules:[V([r(b,"1"),r(b,"2"),r(b,"3")]),r(k)],createNodes:e=>[{type:ge,position:E(e),mode:ye(e)}]},Mn={name:"regionMode",rules:[V([r(b,"36"),r(b,"37")]),r(k)],createNodes:e=>[{type:Ut,position:E(e),region:e[0].value==="36"}]},Gn={name:"quadrantMode",rules:[V([r(b,"74"),r(b,"75")]),r(k)],createNodes:e=>[{type:Wt,position:E(e),quadrant:e[0].value==="74"?Dt:jt}]},Tn={name:"loadPolarity",rules:[r(L),r(ze),r(k),r(L)],createNodes:e=>[{type:Yt,position:E(e.slice(1,-1)),polarity:e[1].value==="D"?zt:$t}]},On={name:"stepRepeat",rules:[r(L),r($e),F([r(A),r(M)]),r(k),r(L)],createNodes(e){const t=ee(e),n=Object.fromEntries(Object.entries(t).map(([o,i])=>[o,Number(i)]));return[{type:Zt,position:E(e.slice(1,-1)),stepRepeat:n}]}},Rn={name:"unimplementedExtendedCommand",rules:[r(L),F([J(k)]),r(k),r(L)],createNodes:e=>[{type:Kt,position:E(e.slice(1,-1)),value:Re(e)}]},at=[kn,In,An,Sn,xn,En,vn,Mn,Gn,Tn,On,Bn,bn,wn,Rn].map(e=>({...e,filetype:Ve})),Ln=[...at,...it];function Cn(e,t=null){const n=[];let o=a(),i=[],l=null,u="";for(const[p,f]of e){const m=Ke([...i,p],o);m.nodes?(n.push(...m.nodes),l=f,u=""):u+=p.text,t=t??m.filetype??null,i=m.tokens??[],o=m.candidates??a()}return{filetype:t,unmatched:u,nodes:n,lexerState:l};function a(){return t===Ve?at:t===ke?it:Ln}}function Nn(){const e=It(),t=[];let n=null,o=null,i="";const l={lexer:e,feed:u,result:a};return l;function u(p){const f=e.feed(`${i}${p}`,o),m=Cn(f,n);return n=n??m.filetype,i=m.unmatched,o=m.lexerState??o,t.push(...m.nodes),l}function a(){if(n===null)throw new Error("File type not recognized");return{type:Ht,filetype:n,children:t}}}function _n(e){return Nn().feed(e).result()}class Pn{constructor(t){this.mm_positions=[],this.shift_x,this.shift_y,this.z_position,this.serial=t}async parseGerber(){const t=await document.getElementById("gerberFile").files[0].text(),n=_n(t);console.log(n);let o=[],i,l,u,a;for(const O of n.children)O.type==="graphic"&&(o.push([O.coordinates.x/1e6,O.coordinates.y/1e6]),(i===void 0||O.coordinates.x/1e6<i)&&(i=O.coordinates.x/1e6),(l===void 0||O.coordinates.y/1e6<l)&&(l=O.coordinates.y/1e6),(u===void 0||O.coordinates.x/1e6>u)&&(u=O.coordinates.x/1e6),(a===void 0||O.coordinates.y/1e6>a)&&(a=O.coordinates.y/1e6));console.log(o),this.mm_positions=o;const p=document.getElementById("pointViz"),f=p.getContext("2d"),m=u-i,S=a-l;let _,T,P;m>S?(_=-i,T=-l+(m-S)/2,P=p.width/m):(_=-i+(S-m)/2,T=-l,P=p.height/S),console.log("xShift: ",_,"yShift: ",T,"scale: ",P);let C=!0;for(const[O,R]of o){console.log("x: ",O,"y: ",R);const D=(O+_)*P,se=(R+T)*P;console.log("drawing at: ",D,se),C?(f.fillStyle="green",f.fillRect(D-6,p.height-se-6,15,15),C=!1):(f.fillStyle="red",f.fillRect(D,p.height-se,5,5))}}async grabBoardPosition(){console.log("grabbing board position"),this.serial.clearInspectBuffer(),await this.serial.send(["G92"]),console.log("sent G92");const t=/X:(.*?) Y:(.*?) Z:(.*?) A:(.*?) B:(.*?) /,n=new RegExp(t,"i");console.log("serial inspect buffer: ",this.serial.inspectBuffer);let o=[];for(var i=0;i<this.serial.inspectBuffer.length;i++){let l=this.serial.inspectBuffer[i];if(console.log(l),n.test(l)){const a=n.exec(l);o=[a[1],a[2],a[3]];break}}console.log("positionArray: ",o),this.shift_x=o[0]-this.mm_positions[0][0],this.shift_y=o[1]-this.mm_positions[0][1],this.z_position=o[2],console.log("shift_x: ",this.shift_x,"shift_y: ",this.shift_y,"z_position: ",this.z_position)}async sendToSlicer(t){let n=[];for(const[o,i]of this.mm_positions)console.log("x: ",o,"y: ",i),console.log("shift_x: ",this.shift_x,"shift_y: ",this.shift_y,"z_position: ",this.z_position),n.push([o+this.shift_x,i+this.shift_y,this.z_position]);console.log(n),t.positions=n}}class Dn{constructor(t,n){this.positions=[],this.shift_x,this.shift_y,this.z_position,this.serial=t,this.commands=[],this.modal=n}slice(t,n,o){const i=[];i.push("G90","G92 B0");let l=0;console.log(this.positions),t=parseFloat(t),n=parseFloat(n),o=parseFloat(o);for(const[u,a,p]of this.positions){const f=l+t,m=f-n;i.push(`G0 X${u} Y${a}`,`G0 Z${p}`,`G0 B${f}`,`G0 B${m}`,`G4 P${o}`,"G0 Z31.5"),l=m}i.push("G0 X300 Y400"),this.commands=i}send(){this.serial.send(this.commands)}}let H=new gt,y=new yt(H),Se=new Pn(y),K=new Dn(y),oe=[];document.getElementById("modal-close").addEventListener("click",()=>{H.receivedInput=!1,H.hide()});document.getElementById("modal-ok").addEventListener("keyup",function(e){e.code==="Enter"&&(e.preventDefault(),H.receivedInput=!0,H.hide())});document.getElementById("modal-ok").addEventListener("click",()=>{H.receivedInput=!0,H.hide()});document.getElementById("modal-ng").addEventListener("click",()=>{H.receivedInput=!1,H.hide()});function jn(){document.getElementById("repl-input").value=""}document.getElementById("repl-input").addEventListener("keyup",function(e){if(e.code==="Enter")e.preventDefault(),document.getElementById("send").click();else if(e.code==="ArrowUp"){if(e.preventDefault(),y.sentCommandBufferIndex==y.sentCommandBuffer.length-1)return!1;y.sentCommandBufferIndex++,document.getElementById("repl-input").value=y.sentCommandBuffer[y.sentCommandBufferIndex]}else if(e.code==="ArrowDown"){if(e.preventDefault(),y.sentCommandBufferIndex==0)return!1;y.sentCommandBufferIndex--,document.getElementById("repl-input").value=y.sentCommandBuffer[y.sentCommandBufferIndex]}});document.getElementById("capture-button").addEventListener("click",()=>{$n()});document.getElementById("export-captured").addEventListener("click",()=>{zn()});document.getElementById("connect").addEventListener("click",()=>{y.connect()});document.getElementById("send").addEventListener("click",()=>{y.sendRepl(),jn()});document.getElementById("home").addEventListener("click",()=>{y.send(["G28"])});function Z(){let e=document.getElementById("jog-distance").value;return e=="1"?.1:e=="2"?1:e=="3"?10:e=="4"?100:1}document.getElementById("jog-yp").addEventListener("click",()=>{let e=Z();y.send(["G91",`G0 Y${e}`,"G90"])});document.getElementById("jog-ym").addEventListener("click",()=>{let e=Z();y.send(["G91",`G0 Y-${e}`,"G90"])});document.getElementById("jog-xp").addEventListener("click",()=>{let e=Z();y.send(["G91",`G0 X${e}`,"G90"])});document.getElementById("jog-xm").addEventListener("click",()=>{let e=Z();y.send(["G91",`G0 X-${e}`,"G90"])});document.getElementById("jog-zp").addEventListener("click",()=>{let e=Z();y.send(["G91",`G0 Z${e}`,"G90"])});document.getElementById("jog-zm").addEventListener("click",()=>{let e=Z();y.send(["G91",`G0 Z-${e}`,"G90"])});document.getElementById("jog-bp").addEventListener("click",()=>{let e=Z();y.send(["G91",`G0 B${e}`,"G90"])});document.getElementById("jog-bm").addEventListener("click",()=>{let e=Z();y.send(["G91",`G0 B-${e}`,"G90"])});document.addEventListener("keyup",function(e){e.getModifierState("Shift")&&!e.getModifierState("Alt")?e.code==="ArrowUp"?(console.log("we saw shift arrow up!"),y.send(["G91","G0 Y10","G90"])):e.code==="ArrowDown"?(console.log("we saw shift arrow down!"),y.send(["G91","G0 Y-10","G90"])):e.code==="ArrowLeft"?(console.log("we saw shift arrow left!"),y.send(["G91","G0 X-10","G90"])):e.code==="ArrowRight"?(console.log("we saw shift arrow right!"),y.send(["G91","G0 X10","G90"])):e.code==="BracketLeft"?(console.log("we saw shift comma!"),y.send(["G91","G0 Z-10","G90"])):e.code==="BracketRight"&&(console.log("we saw shift period!"),y.send(["G91","G0 Z10","G90"])):!e.getModifierState("Shift")&&e.getModifierState("Alt")?e.code==="ArrowUp"?(console.log("we saw shift arrow up!"),y.send(["G91","G0 Y1","G90"])):e.code==="ArrowDown"?(console.log("we saw shift arrow down!"),y.send(["G91","G0 Y-1","G90"])):e.code==="ArrowLeft"?(console.log("we saw shift arrow left!"),y.send(["G91","G0 X-1","G90"])):e.code==="ArrowRight"?(console.log("we saw shift arrow right!"),y.send(["G91","G0 X1","G90"])):e.code==="BracketLeft"?(console.log("we saw shift comma!"),y.send(["G91","G0 Z-1","G90"])):e.code==="BracketRight"&&(console.log("we saw shift period!"),y.send(["G91","G0 Z1","G90"])):e.getModifierState("Shift")&&e.getModifierState("Alt")&&(e.code==="ArrowUp"?(console.log("we saw shift arrow up!"),y.send(["G91","G0 Y0.1","G90"])):e.code==="ArrowDown"?(console.log("we saw shift arrow down!"),y.send(["G91","G0 Y-0.1","G90"])):e.code==="ArrowLeft"?(console.log("we saw shift arrow left!"),y.send(["G91","G0 X-0.1","G90"])):e.code==="ArrowRight"?(console.log("we saw shift arrow right!"),y.send(["G91","G0 X0.1","G90"])):e.code==="BracketLeft"?(console.log("we saw shift comma!"),y.send(["G91","G0 Z-0.1","G90"])):e.code==="BracketRight"&&(console.log("we saw shift period!"),y.send(["G91","G0 Z0.1","G90"])))});function zn(){const e=JSON.stringify(oe),t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=URL.createObjectURL(t),o.download="positions.json",o.click(),URL.revokeObjectURL(n)}async function $n(){y.clearInspectBuffer(),await y.send(["G92"]);const e=/X:(.*?) Y:(.*?) Z:(.*?) A:(.*?) B:(.*?) /,t=new RegExp(e,"i");console.log("serial inspect buffer: ",y.inspectBuffer);for(var n=0;n<y.inspectBuffer.length;n++){let o=y.inspectBuffer[n];if(console.log(o),t.test(o)){const l=t.exec(o);let u=[l[1],l[2],l[3]];oe.push(u);const a=document.createElement("div");a.className="position-item",a.innerHTML=`Position: ${u.join(", ")} <button class="remove-btn">X</button>`,document.getElementById("capture-output").appendChild(a),a.querySelector(".remove-btn").addEventListener("click",function(){a.remove();const p=oe.indexOf(u);p>-1&&oe.splice(p,1),console.log("positions: ",oe)})}}console.log("positions: ",oe)}let qn=document.getElementById("dataFile");qn.addEventListener("change",async e=>{const n=await e.target.files[0].text(),o=JSON.parse(n);K.positions=o,document.getElementById("slicerStatus").innerHTML="(Captured Positions Loaded)"});const Fn=document.getElementById("sliceBtn"),Hn=document.getElementById("sendBtn"),Ne=document.getElementById("generatedGcode");Fn.addEventListener("click",async()=>{const e=document.getElementById("dispenseDeg").value,t=document.getElementById("retractionDeg").value,n=document.getElementById("dwellMs").value;console.log(K.positions),K.slice(e,t,n),console.log("commands: ",K.commands),Ne.style.display="block",Ne.innerHTML=K.commands.join(`
`)});Hn.addEventListener("click",async()=>{let e=H.show("Ensure Nozzles Are Level","Manually level the nozzles before hitting ok.");console.log("now we'll execute!!",e),e.then(t=>{console.log(t),K.send()})});let Vn=document.getElementById("gerberFile");Vn.addEventListener("change",async e=>{Se.parseGerber()});const Xn=document.getElementById("grabGreenSpot");Xn.addEventListener("click",async()=>{await Se.grabBoardPosition(),Se.sendToSlicer(K),document.getElementById("slicerStatus").innerHTML="(Gerber Positions Loaded)"});
